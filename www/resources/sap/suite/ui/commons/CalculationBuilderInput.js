sap.ui.define(["sap/ui/thirdparty/jquery","./library","sap/ui/core/Control","./CalculationBuilderItem","sap/m/List","sap/m/ListMode","sap/m/StandardListItem","sap/m/ResponsivePopover","sap/m/PlacementType","sap/m/Button","sap/m/ButtonType","sap/m/Menu","sap/m/MenuButton","sap/m/MenuItem","sap/m/OverflowToolbar","sap/m/ToolbarSeparator","sap/m/ToolbarSpacer","sap/m/Title","sap/m/OverflowToolbarToggleButton","sap/ui/core/CustomData","sap/ui/model/Sorter","sap/ui/model/json/JSONModel","sap/ui/Device","sap/ui/dom/containsOrEquals"],function(q,l,C,a,L,b,S,R,P,B,c,M,d,f,O,T,g,h,j,k,m,J,D,n){"use strict";var E="&nbsp;&nbsp;";var o="┘┘";var I=l.CalculationBuilderItemType,V=l.CalculationBuilderValidationMode;var r=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var p=function(e){if(typeof e.which==="undefined"){return true;}else if(typeof e.which==="number"&&e.which>0){return!e.ctrlKey&&!e.metaKey&&!e.altKey&&e.which!==8;}return false;};var G=function(e,t){var N,u="",i=0;if(e instanceof q){e=e[0];}var v=e.nodeType;if(!v){while((N=e[i++])){u+=G(N,t);}}else if(v===1||v===9||v===11){for(e=e.firstChild;e;e=e.nextSibling){u+=G(e,t);}}else if(v===3||v===4){u+=t&&q(e).parent().hasClass("sapCalculationBuilderItemTextEmpty")&&e.nodeValue==="  "?"┘┘":e.nodeValue;}return u;};var s=C.extend("sap.suite.ui.commons.CalculationBuilderInput",{metadata:{library:"sap.suite.ui.commons",events:{change:{parameters:{value:"String",position:"integer",validate:"boolean"}}}},renderer:function(e,i){var t="contenteditable=\"true\"";if(i.getParent().getShowInputToolbar()&&!i._bReadOnly){e.write("<div class=\"sapCalculationBuilderInputToolbarWrapper\">");e.renderControl(i._oInputToolbar);e.write("</div>");}e.write("<div");e.writeControlData(i);e.addClass("sapCalculationBuilderInputWrapper");if(i._bReadOnly){t="";}e.writeClasses(i);e.write(" aria-label=\"\" >");e.write("<div aria-label=\"\" aria-describedby=\""+i.getId()+"-error\" spellcheck=\"false\""+t+" id=\""+i.getId()+"-input\" class=\"sapCalculationBuilderInput\"></div>");e.write("<div id=\""+i.getId()+"-error\" class=\"sapCalculationBuilderInputErrorArea\"></div>");e.write("</div>");}});s.prototype.init=function(){this._setupSuggestionList();this._iCarretPosition=0;this._sSuggestionText="";this._aVariables=[];this._oInputToolbar=new O(this.getId()+"-toolbar").addStyleClass("sapCalculationBuilderInputToolbar");this.addDependent(this._oInputToolbar);};s.prototype.exit=function(){if(this._oPopup){this._oPopup.destroy();}if(this._oInputToolbar){this._oInputToolbar.destroy();}};s.prototype.onAfterRendering=function(){this._setupKeyPress();this._setupEvents();this._setupAriaLabel();};s.prototype.onBeforeRendering=function(){this._aFunctions=this.getParent()._getAllFunctions();this._fillInputToolbar();};s.prototype.getFocusDomRef=function(){return this.getDomRef("input");};s.prototype._setupEvents=function(){var $=this.$("input");$.blur(function(){this._lastRangeSelection=this._getSelectionRange();}.bind(this));$.mouseup(function(e){this._iCarretPosition=this._getCaretPosition();}.bind(this));};s.prototype._validate=function(e){var i=this.getParent();if(i&&i.getValidationMode()===V.FocusOut){this.getParent()._validateInput(G(this.$("input")),e?this._iCarretPosition:0);}};s.prototype._setupKeyPress=function(){var t=this,i=this.getParent(),A=i&&i.getAllowSuggestions()&&D.system.desktop,u="paste input";if(D.browser.msie){u+=" keyup";}this.$("input").on('focus',function(){var $=q(this);$.data('before',G($[0]));}).on(u,function(e){var $=q(this),v=$.data('before'),w=e.key,x=G($[0]);if(t._oPopup.isOpen()&&w==="Enter"){return;}if(v!==x){var y=t._iCarretPosition=t._getCaretPosition();t._storeCurrent();t.fireChange({position:Math.max(0,y),value:G($[0],true)});if(A){t._checkSuggestions(y,x,p(e));if(t._sSuggestionText.length>0){t._filterSuggestionList(t._sSuggestionText);if(t._oSuggestionList.getItems().length===0){t._oPopup.close();}else{t._findCurrentSpan();if(!t._oPopup.isOpen()){var z=sap.ui.getCore().getConfiguration().getRTL(),F=q(t._oCurrentSpan),H=z?-($.width()-F.position().left-F.width()):F.position().left;var K=parseInt(H,10),N=t.$("input").outerHeight()-(parseInt(q(t._oCurrentSpan).position().top,10)+q(t._oCurrentSpan).height())-10;t._iSuggestionSelectedIndex=-1;t._oPopup.setOffsetX(K);t._oPopup.setOffsetY(-N);t._oPopup.openBy(t.getDomRef("input"));}}}}}});};s.prototype._createItemSpan=function(K,e){var i=function(){if(!K){return"sapCalculationBuilderItemTextEmpty";}if(e){return"sapCalculationBuilderItemTextError";}if(this._isOperator(K)){return"sapCalculationBuilderItemTextOperator";}return"sapCalculationBuilderItemTextDefault";}.bind(this);var F=K?"text":"html";var N=q('<span />',{title:e?e.title:"","class":i(),"aria-hidden":D.browser.msie})[F](K||E);return N;};s.prototype._findCurrentSpan=function(){var e;if(window.getSelection&&window.getSelection().getRangeAt){e=window.getSelection();this._oCurrentSpan=e.anchorNode.parentNode;if(!q(this._oCurrentSpan).is("span")){this._oCurrentSpan=this.$("input").children().first()[0];}}return this._oCurrentSpan;};s.prototype._setupSuggestionList=function(){var e=new m({path:"grouptitle",descending:false,group:function(i){return i.getProperty("grouptitle");}});var A=function(K){var N=this._createItemSpan(K);q(this._oCurrentSpan).after(N);return N;}.bind(this);var t=function($){var i=$.innerText,v=this._sSuggestionText.toLowerCase(),u=v.length,w=i.toLowerCase(),N="",x=(" "+w).indexOf(" "+v),y;if(x>-1){N+=i.substring(0,x);y=i.substring(x,x+u);N+="<span class=\"sapMInputHighlight\">"+y+"</span>";N+=i.substring(x+u);}else{N=i;}return N;}.bind(this);this._oSuggestionList=new L({mode:b.SingleSelectMaster,showNoData:false,enableBusyIndicator:false,rememberSelections:false,items:{path:"/data",factory:function(i,u){var v=u.getProperty(u.oModel.sPath),w=new S({title:v.title,customData:[new k({key:"key",value:v.key})]});w.addStyleClass("sapCalculationBuilderSuggestionItem");return w;},sorter:e},selectionChange:function(u){var v=u.getParameter("listItem"),w,x,F,K,y;if(v){K=v.getCustomData()[0].getValue();F=this._getFunction(K);q(this._oCurrentSpan).text(F?K+"(":K+"");q(this._oCurrentSpan).removeClass("sapCalculationBuilderItemTextError").addClass("sapCalculationBuilderItemTextDefault");this._iCarretPosition+=(K||"").length+1;if(F){y=this._getFunctionTemplateItems(F);w=y.length;if(w>0){y.forEach(function(K,i){this._oCurrentSpan=A(K)[0];if(!K&&!x){x=this._oCurrentSpan;}if(!x&&K){this._iCarretPosition+=K.length;}if(K&&i!==w-1){this._oCurrentSpan=A(" ");}}.bind(this));}else{x=this._oCurrentSpan=A("")[0];}var z=A(")");if(!x){this._oCurrentSpan=z[0];}}this._storeCurrent();var H=x||this._oCurrentSpan,N=(H&&H.textContent&&H.textContent.length)||0;this.fireChange({position:this._getCaretPosition(H,F?1:N),value:G(this.$("input")[0],true)});}this._oPopup.close();}.bind(this)});this._oSuggestionList.addEventDelegate({onAfterRendering:function(){this._oSuggestionList.$().find(".sapMDLILabel, .sapMSLITitleOnly, .sapMDLIValue").each(function(){this.innerHTML=t(this);});}.bind(this)});this._oPopup=new R(this.getId()+"-popup",{contentWidth:"300px",showArrow:false,showHeader:false,placement:P.Vertical,horizontalScrolling:true,content:this._oSuggestionList}).attachAfterClose(function(i){this._clearSuggestion();}.bind(this));};s.prototype._checkSuggestions=function(e,t,u){var v=t[Math.max(e-1,0)];var w=function(v){return this._isOperator(v)||this._isEmptySpace(v);}.bind(this);if(!v||w(v)){this._clearSuggestion();return;}var W=u?v:"",x=u?2:1;e=Math.max(e,0);for(var i=e-x;i>=0;i--){if(w(t[i])){break;}W=t[i]+W;}for(i=e;i<t.length;i++){if(w(t[i])){break;}W=W+t[i];}if(!W){this._clearSuggestion();}this._sSuggestionText=W||"";};s.prototype._clearSuggestion=function(){this._sSuggestionText="";this._oCurrentSpan={};this._oPopup.close();};s.prototype._filterSuggestionList=function(t){var e=[];var A=function(K,u,v,w){var x=(u||K).toLowerCase(),y=t.toLowerCase();if((" "+x).indexOf(" "+y)!==-1){e.push({title:u||K,key:K,type:v,grouptitle:w});}};var i=this.getParent();i.getOperators().forEach(function(u){A(u.getKey(),u.getText(),I.CustomOperator,r.getText("CALCULATION_BUILDER_OPERATORS_TITLE"));});this._aVariables.forEach(function(v){var u=v.getGroup(),w,x=r.getText("CALCULATION_BUILDER_VARIABLES_TITLE");if(u){w=i.getGroups().filter(function(y){return y.getKey()===u;})[0];x=w?w.getTitle():x;}A(v.getKey(),v.getLabel(),I.Variable,x);});this._aFunctions.forEach(function(u){A(u.key,u.title,I.Function,r.getText("CALCULATION_BUILDER_FUNCTIONS_TITLE"));});e.sort(function(u,v){return u.title.toUpperCase()<v.title.toUpperCase()?-1:1;});this._oSuggestionList.setModel(new J({"data":e}));};s.prototype._getCaretPosition=function(t,u){var v,w,x,A=0;var y=function(N){return(t&&N===t)||(!t&&(N===w.anchorNode||N===w.anchorNode.parentNode));};var z=function(N){var F;if(y(N)){return false;}if(N.nodeType===3){A+=N.textContent.length;}else{for(var i=0;i<N.childNodes.length;i++){F=N.childNodes[i];if(y(F)){return false;}A+=F.textContent.length;}}return true;};try{if(window.getSelection&&window.getSelection().getRangeAt){v=window.getSelection().getRangeAt(0);w=window.getSelection();x=this.$("input")[0].childNodes;for(var i=0;i<x.length;i++){if(!z(x[i])){break;}}return(u||v.startOffset)+A;}}catch(e){return this._iCarretPosition;}return 0;};s.prototype._getSelectionRange=function(){var i,t=0,u=this.$("input")[0];if(typeof window.getSelection!=="undefined"){try{var v=window.getSelection().getRangeAt(0),w=v.cloneRange();if(!n(u,v.startContainer)){return this._lastRangeSelection;}w.selectNodeContents(u);w.setEnd(v.startContainer,v.startOffset);i=w.toString().length;t=i+v.toString().length;}catch(e){t=i=this._iCarretPosition||0;}}return{start:i,length:t-i};};s.prototype._setCaretPosition=function(e){var t=window.getSelection(),$=this.$("input"),u,v,w,F,x;var y=function(x){var z=$.children(),A,H,K=0;for(var i=0;i<z.length;i++){A=z[i];H=A.innerText||"";if(K+H.length>x){return{spanIndex:i,position:K+H.length-x};}K+=H.length;}return{spanIndex:Math.max(i-1,0),position:100};};if(typeof e==="number"){e=y(e);}w=e&&e.span;if(e){u=$[0];if(!w){w=u&&u.children&&u.children.length>e.spanIndex?u.childNodes[e.spanIndex]:null;}if(w){v=document.createRange();F=w.firstChild?w.firstChild:w;x=Math.min(F.length,e.position);v.setStart(F,x);v.collapse(true);t.removeAllRanges();t.addRange(v);}}};s.prototype._recreateText=function(e){var t=function(F){var K;if(F){if(!this._isEmptySpace(F)){K=q.grep(e.errors,function(N){return N.index===x;})[0];}if(F==="┘"){F="";}H+=this._createItemSpan(F,K)[0].outerHTML;if(!this._isEmptySpace(F)){x++;}y++;}}.bind(this);var u=function(){for(;i<w.length;i++){v();if(!this._isEmptySpace(w[i])&&w[i]!=="("){i--;break;}W+=w[i];if(w[i]==="("){break;}}t(W);W="";}.bind(this);var v=function(F){if(!z&&e.position===i){z={spanIndex:y-(F||0),position:F||W.length};}};var H="",w,x=0,y=0,z=null,W="",A;w=e.text||G(this.$("input")[0],true);for(var i=0;i<w.length;i++){A=w[i];v();if(A==="┘"||this._isEmptySpace(A)||this._isOperator(A)){if(this._isFunction(W)){u();}else{t(W);t(A);W="";}if(A==="┘"){i++;v(1);}}else{W+=A;}}t(W);this.$("input").html(H);this._showErrorText(true,e.errors);if(e.position>0){this._setCaretPosition(z||{spanIndex:y-1,position:Number.MAX_SAFE_INTEGER});}};s.prototype._setupAriaLabel=function(){var e,i,A;if(D.browser.msie){return;}e=this.getParent();i=e._oExpressionBuilder._aErrors;A=r.getText("CALCULATION_BUILDER_EXPRESSION_TITLE")+": "+e.getExpression();if(i.length>0){A+=". "+r.getText("CALCULATION_BUILDER_ERROR_TITLE")+": ";i.forEach(function(t){A+=t.title+" ";});}this.$().attr("aria-label",A);};s.prototype._showErrorText=function(e,t){var $=this.$("error");t=t||this.getParent().getErrors();if((t&&t.length>0)&&e){var u="",v=5;for(var i=0;i<t.length&&i<v;i++){u+=t[i].title+"\n";}$.show();$.text(u);}else{$.hide();}};s.prototype._stringToItems=function(e){var i=[],t="",u="",v=0;var w=function(){var F,y="";if(u){F=this._getFunction(u);if(F){if(e[v]!=="("){y=I.Error;for(;v<e.length;v++){if(e[v]==="("){y="";break;}if(!this._isEmptySpace(e[v])){v--;break;}}}}var z=new a({key:u});z._sType=y;i.push(z);}u="";return!!F||!!y;}.bind(this);if(!e){e=G(this.$("input")[0],true);}for(;v<e.length;v++){t=e[v];if(t==="┘"){i.push(new a());v++;continue;}if(this._isEmptySpace(t)){if(u){w();}continue;}var N=e[v+1];if(N&&this._isOperator(t+N,false)){t+=N;v++;}var x=this._isOperator(t,false);if(x){if(w()){continue;}i.push(new a({key:t}));}else{u+=t;}}w();return i;};s.prototype._itemsToString=function(e){var t=e.items,u="",v="",w,x,y;var z=function(A){var F="";if(A){F=A.getKey();w=this._isFunction(F);if(w){F+="(";}}return F;}.bind(this);for(var i=0;i<t.length;i++){x=q.grep(e.errors,function(A){return A.index===i;})[0];y=z(t[i]);v+=this._createItemSpan(y,x)[0].outerHTML;if(!w&&y!=="("&&z(t[i+1])!==")"){v+=this._createItemSpan(" ")[0].outerHTML;}u+=y;}this.$("input").html(v);return u;};s.prototype.onfocusin=function(e){if(this._bSetCaretOnFocus){this._setCaretPosition(this._iCarretPosition);}this._bSetCaretOnFocus=false;this._showErrorText(true);};s.prototype.onsapfocusleave=function(e){if(e.relatedControlId&&n(this._oPopup.getDomRef(),sap.ui.getCore().byId(e.relatedControlId).getFocusDomRef())){if(sap.ui.getCore().isMobile()||D.browser.safari){this._bSetCaretOnFocus=true;}this.focus();}else{this._showErrorText(false);this._validate(false);}};s.prototype.onsappageup=function(e){this._suggestionListKeyHandling({event:e,add:true,toEnd:true});if(!this._oPopup.isOpen()){this._iCarretPosition=G(this.$("input")).length-1;}};s.prototype.onsapnext=function(e){if(this._iCarretPosition<G(this.$("input")).length-1){this._iCarretPosition++;}};s.prototype.onsapprev=function(e){if(this._iCarretPosition>0){this._iCarretPosition--;}};s.prototype.onsappagedown=function(e){this._suggestionListKeyHandling({event:e,add:false,toEnd:true});if(!this._oPopup.isOpen()){this._iCarretPosition=0;}};s.prototype.onsapdown=function(e){this._suggestionListKeyHandling({event:e,add:true});};s.prototype.onsapescape=function(e){if(this._oPopup.isOpen()){this._oPopup.close();}};s.prototype.onsapup=function(e){this._suggestionListKeyHandling({event:e,add:false});};s.prototype.onsapenter=function(e){if(this._oPopup.isOpen()){this._oSuggestionList.fireSelectionChange({listItem:this._oSuggestionList.getSelectedItem()});}else{this._validate(true);}e.preventDefault();e.stopPropagation();};s.prototype._suggestionListKeyHandling=function(e){var i=e.event,A=e.add,t=e.toEnd,u,v;if(!this._oPopup.isOpen()||!i){return;}A?this._iSuggestionSelectedIndex++:this._iSuggestionSelectedIndex--;u=this._oSuggestionList.$().find(".sapCalculationBuilderSuggestionItem");v=u.length;if((this._iSuggestionSelectedIndex<0)||(!A&&t)){this._iSuggestionSelectedIndex=v-1;}else if((this._iSuggestionSelectedIndex>=v)||(A&&t)){this._iSuggestionSelectedIndex=0;}this._oSuggestionList.removeSelections(true);sap.ui.getCore().byId(u[this._iSuggestionSelectedIndex].id).setSelected(true).focus();i.preventDefault();i.stopPropagation();};s.prototype._displayError=function(e){this.$("input")[e?"addClass":"removeClass"]("sapCalculationBuilderInputError");};s.prototype._insertItemFromToolbar=function(K){var $=this.$("input"),t,N,e;var i=" "+K+" ",F=this._getFunction(K),u=i.length,v;var w=function(){return{start:$.text().length,length:0};};e=this._getSelectionRange()||w();$.focus();this._lastRangeSelection={};t=G($[0],true);if(t[e.start]==="┘"&&t[e.start-1]==="┘"&&e.length===0){e.start--;e.length+=2;}if(F){i=" "+K+"(";v=this._getFunctionTemplateItems(F);if(v.length>0){v.forEach(function(K){i+=K?K:o;});}else{i+=o;}i+=") ";u=i.indexOf(o)+1;}N=[t.slice(0,e.start),i,t.slice(e.start+e.length)].join('');this.fireChange({value:N,position:e.start+u});this._storeCurrent();};s.prototype._convertEmptyHashes=function(t){return t?t.replace(new RegExp(o,'g'),"  "):"";};s.prototype._fillInputToolbar=function(){var e=function(X,Y){return new B({type:c.Transparent,text:X==="*"?"x":X,press:this._insertItemFromToolbar.bind(this,X)}).addStyleClass("sapCalculationBuilderInputToolbarButtons "+Y);}.bind(this);var i=function(X){if(X){return X.map(function(Y){return new f({key:Y.getKey(),text:Y._getLabel()});}).sort(function(Y,Z){return Y.getText().localeCompare(Z.getText());});}return[];};var t=function(X){return X.map(function(Y){return new f({key:Y.getKey(),text:Y.getText()?Y.getText():Y.getKey()});}).sort(function(Y,Z){return Y.getText().localeCompare(Z.getText());});};var u=function(X){return X.map(function(Y){return new f({key:Y,text:Y});});};var v=function(){var F=this.getParent(),X=F.getAllowComparisonOperators(),Y=F.getAllowLogicalOperators(),Z=F.getOperators(),$=Z.length>0,_,a1,b1=[];if(X){_=u(Object.keys(y));b1.push(new f({text:r.getText("CALCULATION_BUILDER_COMPARISON_TITLE"),items:_}));}if(Y){a1=u(Object.keys(z));b1.push(new f({text:r.getText("CALCULATION_BUILDER_LOGICAL_TITLE"),items:u(Object.keys(z))}));}if($){a1=t(Z);b1.push(new f({text:r.getText("CALCULATION_BUILDER_ADDITIONAL_OPERATOR"),items:a1}));}if(b1.length>1){return b1;}if(X){return _;}if(Y){return _;}if($){return _;}return[];}.bind(this);var w=function(X){return new d({text:X,menu:new M({itemSelected:function(Y){this._insertItemFromToolbar(Y.getParameters().item.getKey());}.bind(this)})}).addStyleClass("sapCalculationBuilderInputToolbarFunctionMenu").addStyleClass("sapCalculationBuilderInputToolbarMenuButtons");}.bind(this);var x=l.CalculationBuilderOperatorType,y=l.CalculationBuilderComparisonOperatorType,z=l.CalculationBuilderLogicalOperatorType,A=v(),F=this.getParent(),H=!!F.getTitle()&&(F.getLayoutType()===l.CalculationBuilderLayoutType.TextualOnly),K;this._oInputToolbar.removeAllContent();this._oInputToolbar.addContent(new h({text:F.getTitle(),visible:H}));this._oInputToolbar.addContent(new g());Object.keys(x).forEach(function(X){this._oInputToolbar.addContent(e(x[X],""));}.bind(this));this._oInputToolbar.addContent(new T().addStyleClass("sapUiSmallMarginBeginEnd"));if(A.length>0){this._oInputToolbar.addContent(new d({text:r.getText("CALCULATION_BUILDER_OPERATORS_TITLE"),menu:new M({itemSelected:function(X){this._insertItemFromToolbar(X.getParameters().item.getKey());}.bind(this),items:A})}).addStyleClass("sapCalculationBuilderInputToolbarMenuButtons"));}K=this._aFunctions.map(function(X){return new f({key:X.key,text:X.title});});var N=w(r.getText("CALCULATION_BUILDER_FUNCTIONS_AND_VARIABLES_TITLE"));if(K.length>0){N.getMenu().addItem(new f({text:r.getText("CALCULATION_BUILDER_FUNCTIONS_TITLE"),items:[K]}));}var Q=F._getGroupMap(),U=F.getGroups(),W=Q["##DEFAULT##"];if(W&&W.length>0){N.getMenu().addItem(new f({text:r.getText("CALCULATION_BUILDER_VARIABLES_TITLE"),items:i(W)}));}U.forEach(function(X){var Y=Q[X.getKey()];if(Y&&Y.length>0){N.getMenu().addItem(new f({text:X._getTitle(),items:i(Y)}));}});this._oInputToolbar.addContent(N);};s.prototype._isOperator=function(e,A){return this.getParent()&&this.getParent()._isOperator(e,A);};s.prototype._getFunctionTemplateItems=function(F){return this.getParent()._getFunctionTemplateItems(F);};s.prototype._isEmptySpace=function(e){return e===String.fromCharCode(160)||e===" ";};s.prototype._isEmptyItem=function(t){return t===E;};s.prototype._getText=function(){return this.$("input").text();};s.prototype._isFunction=function(K){return!!this._getFunction(K);};s.prototype._getFunction=function(K){return this.getParent()._getFunctionDefinition(K);};s.prototype._storeCurrent=function(v){var $=this.$("input");$.data('before',$.text());};return s;},true);
