/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/suite/ui/commons/library","sap/ui/thirdparty/jquery","sap/ui/core/Control","./SvgBase","./Node","./Line","./Group","./layout/LayeredLayout","./Tooltip","sap/ui/core/Popup","sap/ui/model/json/JSONModel","sap/m/SuggestionItem","./Utils","sap/m/ButtonType","sap/m/Label","sap/m/OverflowToolbar","sap/m/OverflowToolbarButton","sap/m/SearchField","sap/m/ToolbarSpacer","sap/ui/core/CustomData","sap/ui/model/Filter","sap/m/OverflowToolbarLayoutData","./KeyboardNavigator","sap/ui/core/theming/Parameters","sap/base/Log","sap/ui/performance/Measurement","sap/base/util/uid","sap/base/security/encodeXML"],function(l,q,C,S,N,L,G,c,T,P,J,d,U,B,e,O,f,g,h,j,F,k,K,m,n,M,u,o){"use strict";var p=l.networkgraph.Orientation,r=l.networkgraph.LayoutRenderType,R=l.networkgraph.RenderType;var A="nodes",s="lines",t="groups";var Z=[0.05,0.1,0.25,0.33,0.50,0.67,0.75,0.80,0.90,1,1.1,1.25,1.5,1.75,2,2.5,3,4,5],D=1,v=0.4,w=100000;var x={Group:"group",Node:"node",Line:"line",IsLastKey:"islast",TypeKey:"type"};var y=Object.freeze({Node:"Node",Line:"Line",Group:"Group"});var z=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var E=0,H=100;var I=d.extend("sap.suite.ui.commons.networkgraph.LimitedSuggestionItem",{render:function(a,i,b,V){if(E++<H){d.prototype.render.call(this,a,i,b,V);}}});var Q=S.extend("sap.suite.ui.commons.networkgraph.Graph",{metadata:{library:"sap.suite.ui.commons",properties:{height:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"100%"},width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"100%"},orientation:{type:"sap.suite.ui.commons.networkgraph.Orientation",group:"Behavior",defaultValue:p.LeftRight},enableWheelZoom:{type:"boolean",group:"Behavior",defaultValue:true},backgroundImage:{type:"sap.ui.core.URI",group:"Appearance",defaultValue:null},backgroundColor:{type:"sap.suite.ui.commons.networkgraph.BackgroundColor",group:"Appearance",defaultValue:"Default"},renderType:{type:"sap.suite.ui.commons.networkgraph.RenderType",group:"Appearance",defaultValue:R.Html}},aggregations:{lines:{type:"sap.suite.ui.commons.networkgraph.Line",multiple:true,singularName:"line"},nodes:{type:"sap.suite.ui.commons.networkgraph.Node",multiple:true,singularName:"node"},groups:{type:"sap.suite.ui.commons.networkgraph.Group",multiple:true,singularName:"group"},legend:{type:"sap.ui.core.Control",multiple:false},layoutAlgorithm:{type:"sap.suite.ui.commons.networkgraph.layout.LayoutAlgorithm",multiple:false},statuses:{type:"sap.suite.ui.commons.networkgraph.Status",multiple:true,singularName:"status"}},associations:{ariaDescribedBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaDescribedBy"},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},events:{graphReady:{},afterLayouting:{},beforeLayouting:{},zoomChanged:{},failure:{parameters:{type:"String",message:"String"}},selectionChange:{parameters:{items:{type:"sap.suite.ui.commons.networkgraph.ElementBase[]"}}},searchSuggest:{parameters:{term:{type:"sap.ui.core.String"}}},search:{parameters:{term:{type:"sap.ui.core.String"},key:{type:"sap.ui.core.String"}}}}}});Q.FAILURE_TYPE={INCONSISTENT_MODEL:"Inconsistent model",LAYOUT_FAILURE:"Layout failure"};Q.prototype.ZOOM_100=D;Q.prototype.init=function(){this._fZoomLevel=1;this._mSelectedNodes={};this._mSelectedLines={};this._bIsLayedOut=false;this._bIsFullScreen=false;this._mNodes={};this._bNeedNodeProcessing=true;this._oFullScreenContainer=null;this._bRequiresDataProcessing=true;this._oPanning={};this._oLegendLabels={};this._iRunningLayouts=0;this._oLastLayout=null;this._bIsRtl=sap.ui.getCore().getConfiguration().getRTL();this._oFocus=null;this._tooltip=this._createTooltip();this._bIsInvalid=false;this._oStatuses={};this._createToolbar();};Q.prototype.onBeforeRendering=function(){this._bIsRtl=sap.ui.getCore().getConfiguration().getRTL();this.setBusy(false);this.setBusyIndicatorDelay(0);this.getNodes().forEach(function(a){a._resetDimensions();});this.getLines().forEach(function(a){a._resetLayoutData();});this._loadData();};Q.prototype.onAfterRendering=function(){var a="",b=this._bIsRtl?"direction="+"\"rtl\"":"",i="<rect class=\"sapSuiteFlickerFreeRect\" x=\"0\" y=\"0\"></rect>";this.$scroller=this.$("scroller");this._$innerscroller=this.$("innerscroller");this.$legend=this.$("legend");if(this._oFullScreenContainer&&this._bIsFullScreen){this._oFullScreenContainer.$content=this.$();this.$().addClass("sapSuiteUiCommonsNetworkGraphFullScreen");}if(this.getNodes().length===0||this._bIsInvalid){if(this._bIsInvalid){this.$scroller.html("<span class=\"sapSuiteNetworkGraphErrorText\">"+z.getText("NETWORK_GRAPH_WRONGDATA")+"</span>");}this.fireGraphReady();return;}this.setBusy(true);if(this._isDelayedLayouting()){if(!this._isUseNodeHtml()){this.getNodes().forEach(function(W){W._setupWidthAndHeight();a+=W._render({sizeDetermination:true});a+="</g>";});}var V=function(){this._isUseNodeHtml()?this._createDivNodes():this._$innerscroller.html("<svg "+b+" class=\"sapSuiteUiCommonsNetworkGraphSvg\">"+a+i+"</svg>");this.getNodes().forEach(function(W){if(this._isUseNodeHtml()){W._setupDivDimensions();}else{W.calculateSizes();W._setupWidthAndHeight();}}.bind(this));this._preprocessData();sap.ui.getCore().detachThemeChanged(V);}.bind(this);if(!sap.ui.getCore().isThemeApplied()){sap.ui.getCore().attachThemeChanged(V);}else{V();}}};Q.prototype._beforeRender=function(){this.fireEvent("afterLayouting");};Q.prototype._fireFailure=function(a,b){var i=b;if(typeof b==="object"&&b.text){i=b.text;}var V="Graph failure: "+a+": "+i;if(a===Q.FAILURE_TYPE.INCONSISTENT_MODEL){V+=" This may be due to the model size limitation. For its increase use model's 'setSizeLimit' method.";}this.fireFailure([a.toString(),i]);n.error(V);};Q.prototype.preventInvalidation=function(b){this._bPreventInvalidation=b;};Q.prototype.scrollToElement=function(a){this._scrollToElement(a);};Q.prototype.setSearchSuggestionItems=function(i){var a=[];if(i){i.forEach(function(b){a.push({text:b.getText(),icon:b.getIcon(),key:b.getKey(),description:b.getDescription()});});}this._oSuggestionItemsModel.setData({items:a});};Q.prototype.destroyAllElements=function(){this.destroyAggregation(A,false);this.destroyAggregation(t,false);this.destroyAggregation(s,false);};Q.prototype.deselect=function(b){var i=[],$=this.$(),a=function(V){Object.keys(V).forEach(function(W){i.push(V[W]);V[W].setSelected(false);},this);}.bind(this);$.find("."+this.HIGHLIGHT_CLASS).removeClass(this.HIGHLIGHT_CLASS);$.find("."+this.SELECT_CLASS).removeClass(this.SELECT_CLASS);$.find("."+this.VISIBLE_ACTIONS_BUTTONS_CLASS).removeClass(this.VISIBLE_ACTIONS_BUTTONS_CLASS);a(this._mSelectedNodes);a(this._mSelectedLines);if(!b&&i.length){this.fireSelectionChange({items:i});}return i;};Q.prototype.getFocus=function(){return this._oFocus;};Q.prototype.getToolbar=function(){return this._toolbar;};Q.prototype.getNodeByKey=function(a){if(this._bRequiresDataProcessing){this._processData();}return this._mNodes[a];};Q.prototype.setCustomLegendLabel=function(a){var b;if(a.isGroup===true){b=y.Group;}else if(a.isLine===true){b=y.Line;}else{b=a.isNode===false?y.Line:y.Node;}if(a.status){this._oLegendLabels[b+a.status]=a.label;this._createLegend();}};Q.prototype.updateLegend=function(){this._createLegend();};Q.prototype.zoom=function(a){a=a||{};a.deltaY=(a.zoomin!==false)?1:-1;if(a.x&&a.y){a.point={x:a.x,y:a.y};}this._zoom(a);};Q.prototype.getZoomLevelMilestones=function(){return Z;};Q.prototype.getCurrentZoomLevel=function(){return this._fZoomLevel;};Q.prototype.getCorrectMousePosition=function(a){var b=this.$svg.offset(),i=1,V=1;if(this._iWidth!==this.$svg.width()||this._iHeight!==this.$svg.height()){i=this._iWidth/this.$svg.width();V=this._iHeight/this.$svg.height();}return{x:parseInt((a.x-b.left)*i,10),y:parseInt((a.y-b.top)*V,10)};};Q.prototype._createTooltip=function(){var a=new T(this.getId()+"-tooltip");this.addDependent(a);a.create(this);a.attachEvent("afterClose",function(){this.setFocus(this.getFocus());}.bind(this));return a;};Q.prototype.defocus=function(){this.$().find("."+this.FOCUS_CLASS).removeClass(this.FOCUS_CLASS);};Q.prototype.setFocus=function(a){if(!a&&!this._oFocus||a&&this._oFocus&&a.item===this._oFocus.item&&a.button===this._oFocus.button){return;}this.defocus();if(this.getFocusDomRef()){this.getFocusDomRef().focus();}if(a&&a.item instanceof L){a.button=null;}if(a){if(a.button){if(a.item instanceof N){a.item._setActionButtonFocus(a.button,true);}else if(a.item instanceof G){if(a.button===G.BUTTONS.MENU){a.item._setMenuButtonFocus(true);}else if(a.button===G.BUTTONS.COLLAPSE){a.item._setCollapseButtonFocus(true);}}}else if(a.item){a.item._setFocus(true);}}this._oFocus=a;this._ensureOnScreen(a?a.item:null);this._updateAccessibility(a);};Q.prototype._updateAccessibility=function(a){var b=function(){this._setAccessibilityTitle(z.getText("NETWORK_GRAPH_ACCESSIBILITY_CONTENT"));}.bind(this),i=function(V){return z.getText("NETWORK_GRAPH_ACCESSIBILITY_ACTION_BUTTON")+" "+V;};if(a){if(a.button){if(a.item instanceof N){this._setAccessibilityTitle(a.item._getActionButtonTitle(a.button));}else if(a.item instanceof G){if(a.button===G.BUTTONS.MENU){this._setAccessibilityTitle(i(z.getText("NETWORK_GRAPH_GROUP_DETAIL")));}else if(a.button===G.BUTTONS.COLLAPSE){this._setAccessibilityTitle(i(z.getText("NETWORK_GRAPH_EXPAND_COLLAPSE")));}else{b();}}else{b();}}else if(a.item){this._setAccessibilityTitle(a.item._getAccessibilityLabel());}}else{b();}};Q.prototype._processProperties=function(){if(this._bNeedNodeProcessing){this._mSelectedNodes={};this._mSelectedLines={};this.getNodes().forEach(function(a){if(a.getSelected()){this._mSelectedNodes[a.getKey()]=a;}if(a.getCollapsed()){a.setCollapsed(true);}},this);this.getLines().forEach(function(a){if(a.getSelected()){this._mSelectedLines[a._getLineId()]=a;}},this);this._bNeedNodeProcessing=false;}};Q.prototype._loadData=function(){if(this.getNodes().length>0){if(!this._processData()){return;}if(!this._isDelayedLayouting()){setTimeout(this._preprocessData.bind(this),0);}}};Q.prototype._preprocessData=function(){this._bIsLayedOut=false;this._bImageLoaded=false;this.fireBeforeLayouting();this._applyLayout().then(this._render.bind(this));};Q.prototype._getAllElements=function(){return this.getNodes().concat(this.getGroups());};Q.prototype._render=function(){this._beforeRender();this._iRunningLayouts--;if(this._iRunningLayouts>0){return;}this._oLastLayout=null;this._createSearchSuggestItems();this._innerRender();this._createLegend();this._processProperties();if(this._fZoomLevel!==1){this.$svg[0].setAttribute("viewBox","0 0 "+this.$svg.width()+" "+this.$svg.height());this.$svg.width(this.$svg.width()*this._fZoomLevel);this.$svg.height(this.$svg.height()*this._fZoomLevel);if(this._isUseNodeHtml()){var a="scale("+this._fZoomLevel+")";this.$("divnodes").css("transform",a);}}this._setLineClasses();if(this._selectElementAfterScroll){this._scrollToElement(this._selectElementAfterScroll);this._selectElementAfterScroll=null;}this._bIsLayedOut=true;this._setupEvents();this._setupKeyboardNavigation();this.setFocus(this.getFocus());if(!this.getBackgroundImage()||this._bImageLoaded){this.setBusy(false);this.fireGraphReady();}};Q.prototype._createDivNodes=function(){var a=sap.ui.getCore().createRenderManager();var b="style=\"opacity: 0\"";a.write("<div id=\""+this.getId()+"-divnodes\" class=\"sapSuiteUiCommonsNetworkGraphDivNodes\" "+b+">");this.getNodes().forEach(function(i){a.renderControl(i);});a.write("</div>");a.flush(this._$innerscroller[0]);a.destroy();};Q.prototype._innerRender=function(a){var b=function(b1){var c1="";b1.forEach(function(d1){c1+=d1._render();d1.bOutput=true;});return c1;};var i=function(){this.$svg.find(".sapSuiteFlickerFreeRect").remove();this._bImageLoaded=true;if(this._bIsLayedOut){this.setBusy(false);this.fireGraphReady();}}.bind(this);var V=20,W=50,X=function(){var b1=0,c1=0;var d1=function(f1,g1){if(f1>b1){b1=f1;}if(g1>c1){c1=g1;}};this._iWidth=0;this._iHeight=0;this._getAllElements().forEach(function(f1){if(!f1._isIgnored()){d1(f1._iWidth+f1.getX(),f1._iHeight+f1.getY());}},this);this.getLines().forEach(function(f1){if(!f1._isIgnored()){f1.getCoordinates().forEach(function(g1){d1(g1.getX(),g1.getY());});}},this);if(this.getBackgroundImage()){var e1=new Image();e1.onload=function(){this._iWidth=Math.max(this._iWidth,e1.width);this._iHeight=Math.max(this._iHeight,e1.height);this.$svg.width(this._iWidth);this.$svg.height(this._iHeight);this.$svg.css("background-image","url("+this.getBackgroundImage()+")");this.$svg.css("background-size","cover");i();}.bind(this);e1.onerror=function(){n.warning("Unable to load background image.");i();};e1.src=this.getBackgroundImage();}this._iWidth=Math.round(b1+W);this._iHeight=Math.round(c1+V);if(this.getWidth()==="auto"){this.$().width(this._iWidth);}if(this.getHeight()==="auto"){this.$("wrapper").height(this._iHeight);}this.$svg.width(this._iWidth);this.$svg.height(this._iHeight);if(this._isUseNodeHtml()){this.$divnodes.width(this._iWidth);this.$divnodes.height(this._iHeight);this.$divnodes.css("opacity",1);}}.bind(this);var Y=function(b1){b1.forEach(function(c1){c1.forEach(function(d1){d1._afterRendering();});});};var $=this.getNodes(),_=this.getLines(),a1=this.getGroups();M.start(this.getId(),"Rendering of a network graph");this._$innerscroller[this._isUseNodeHtml()?"append":"html"](this._renderSvg(this._isUseNodeHtml()?[]:b($),b(_),b(a1)));this.$svg=this.$("networkGraphSvg");this.$divnodes=this.$("divnodes");X();if(this._isUseNodeHtml()){$.forEach(function(b1){var c1=b1.$();if(b1._isInCollapsedGroup()){c1.hide();}c1.css("top",b1.getY());c1.css("left",b1.getX());});}Y([this._isUseNodeHtml()?[]:$,_,a1]);M.end(this.getId());};Q.prototype._renderSvg=function(a,b,i){var V="",W="sapSuiteUiCommonsNetworkGraphSvg sapSuiteUiCommonsNetworkGraphNoSelect "+(this._fZoomLevel<v?" sapSuiteUiCommonsNetworkGraphZoomedOut ":"");var X=function(Y,$,W){V+="<g id=\""+this._getDomId(Y)+"\" class=\""+(W||"")+"\">";V+=$?$:"";V+="</g>";}.bind(this);V+="<svg id=\""+this.getId()+"-networkGraphSvg\"";if(this._bIsRtl){V+="direction="+"\"rtl\"";}V+=" style=\"margin:auto\"";V+=" class=\""+W+"\" preserveAspectRatio=\"none\" ";V+=">";V+="<g id=\""+this.getId()+"-eventwrapper\"><rect style=\"fill: none\" class=\"sapSuiteUiCommonsNetworkGraphEventWrapper\" width=\"100%\" height=\"100%\"/></g>";V+="<g id=\""+this.getId()+"-svgbody\">";V+="<g class=\"sapSuiteUiCommonsNetworkGroupEventWrapper\"></g>";if(this._isSwimLane()){X("lines",b,"sapSuiteUiCommonsNetworkLines");X("groups",i,"sapSuiteUiCommonsNetworkGroups");}else{X("groups",i,"sapSuiteUiCommonsNetworkGroups");X("lines",b,"sapSuiteUiCommonsNetworkLines");}X("nodes",a,"sapSuiteUiCommonsNetworkNodes");if(this._isUseNodeHtml()){V+="<g id=\""+this._getDomId("actiionbuttons")+"\" class=\"sapSuiteUiCommonsNetworkActionButton\">";V+="</g>";}V+="</g>";if(this.getBackgroundImage()){V+="<rect class=\"sapSuiteFlickerFreeRect\" x=\"0\" y=\"0\" height=\"100%\" width=\"100%\"></rect>";}V+="</svg>";return V;};Q.prototype._isProperKey=function(a){return a||(a==="0");};Q.prototype._processData=function(){var i=this._isSwimLane();var a=function(){var W=0;this.mGroups={};return this.getGroups().some(function(X){var Y=X.getKey();if(!this._isProperKey(Y)){this._fireFailure(Q.FAILURE_TYPE.INCONSISTENT_MODEL,"Group without a proper key [index: "+W+"] found.");return true;}X._bIsSwimLane=i;X._resetSize();X._clearChildren();if(this.mGroups[Y]){this._fireFailure(Q.FAILURE_TYPE.INCONSISTENT_MODEL,"Group with a duplicit key "+Y+" found.");return true;}this.mGroups[Y]=X;W++;return false;},this);}.bind(this);var b=function(){var W=0;this._mNodes={};return this.getNodes().some(function(X){if(!this._isProperKey(X.getKey())){this._fireFailure(Q.FAILURE_TYPE.INCONSISTENT_MODEL,"Node without a proper ID [index: "+W+"] found.");return true;}var Y=X.getGroup(),$;X._oGroup=null;if(Y){$=this.mGroups[Y];if($){X._oGroup=$;$.aNodes.push(X);}else{this._fireFailure(Q.FAILURE_TYPE.INCONSISTENT_MODEL,"Node belonging to a nonexistent group with key "+Y+" found.");return true;}}this._isUseNodeHtml()?X._resetDimensions():X._setupWidthAndHeight();X._clearChildren();X._rendered=false;if(this._mNodes[X.getKey()]){this._fireFailure(Q.FAILURE_TYPE.INCONSISTENT_MODEL,"Node with a duplicit key "+X.getKey()+" found.");return true;}this._mNodes[X.getKey()]=X;W++;return false;},this);}.bind(this);var V=function(){return this.getLines().some(function(W,X){var Y=this.getNodeByKey(W.getFrom()),$=this.getNodeByKey(W.getTo());if(!Y){this._fireFailure(Q.FAILURE_TYPE.INCONSISTENT_MODEL,"Line going from a nonexistent node with key "+W.getFrom()+" found.");return true;}if(!$){this._fireFailure(Q.FAILURE_TYPE.INCONSISTENT_MODEL,"Line going to a nonexistent node with key "+W.getTo()+" found.");return true;}W._rendered=false;W._initialized=false;if(Y&&$){Y.aChildren.push($);Y.aLines.push(W);$.aParents.push(Y);$.aParentLines.push(W);W._oFrom=Y;W._oTo=$;W._sKey="line_"+Y.getKey()+"-"+$.getKey()+"["+X+"]";}if(Y._oGroup){Y._oGroup.aLines.push(W);Y._oGroup.aChildren.push($);}if($._oGroup){$._oGroup.aParentLines.push(W);$._oGroup.aParents.push(Y);}return false;},this);}.bind(this);this._bRequiresDataProcessing=false;if(a()||b()||V()){this._bIsInvalid=true;return false;}this._oStatuses={};this.getStatuses().forEach(function(W){var X=W.getKey();if(X){this._oStatuses[X]=W;}},this);this._bIsInvalid=false;return true;};Q.prototype._validateLayout=function(){var W,b,a,i;W=this.getNodes().some(function(V){if(V._isIgnored()){return false;}i="Missing coordinates: Node("+V.getKey()+")";return!((V._oGroup&&V._oGroup.getCollapsed())||(isFinite(V.getX())&&isFinite(V.getY())));});if(W){this._fireFailure(Q.FAILURE_TYPE.LAYOUT_FAILURE,i);return false;}if(this._isLayered()){b=this.getGroups().some(function(V){if(V._isIgnored()){return false;}i="Missing coordinates: Group("+V.getKey()+")";return!V._isEmpty()&&(!isFinite(V.getX())||!isFinite(V.getY()));});if(b){this._fireFailure(Q.FAILURE_TYPE.LAYOUT_FAILURE,i);return false;}}a=this.getLines().some(function(V){if(V._isIgnored()){return false;}i="Missing coordinates: Line("+V.getKey()+")";return!V._validateLayout();});if(a){this._fireFailure(Q.FAILURE_TYPE.LAYOUT_FAILURE,i);return false;}return true;};Q.prototype._suggest=function(a){var b=function(i){i.addCustomData(new j({key:x.IsLastKey,value:"true",writeToDom:true}));};var V=function(i){var _=U.find(i.getCustomData(),function(a1){return a1.getKey()===x.IsLastKey;});if(_){i.removeCustomData(_);}};var W=function(i){var _=U.find(i.getCustomData(),function(a1){return a1.getKey()===x.TypeKey;});return _&&_.getValue();};var X=function(){var _=this._searchField.getSuggestionItems(),a1,b1,c1;for(var i=0;i<_.length;i++){a1=_[i];V(a1);if(i<_.length-1){b1=W(a1);c1=W(_[i+1]);if(b1&&c1){if((b1===x.Node&&c1===x.Line)||(b1===x.Line&&c1===x.Group)){b(a1);}}}}}.bind(this);var Y=[],$=this.fireEvent("searchSuggest",{term:a},true);E=0;if($){if(a){Y=[new F([new F("text",function(i){return(i.toLowerCase()||"").indexOf(a.toLowerCase())>-1;}),new F("description",function(i){return(i.toLowerCase()||"").indexOf(a.toLowerCase())>-1;})],false)];}this._searchField.getBinding("suggestionItems").filter(Y);X();}this._searchField.suggest();};Q.prototype._getElementSelectFunctionName=function(a){var b="";if(a instanceof N){b="_selectNode";}if(a instanceof L){b="_selectLine";}if(a instanceof G){b="_selectGroup";}return b;};Q.prototype._search=function(a,b){var i,V,W;V=this.fireEvent("search",{term:a,key:b},true);if(!V){return;}if(a){W=U.find(this.getNodes(),function(W){return b?W.getKey()===b:W.getTitle()===a;});if(!W){W=U.find(this.getLines(),function(X){if(X._isLoop()){return false;}return b?X._getLineId()===b:X._createSuggestionHelpText()===a;});}if(!W){W=U.find(this.getGroups(),function(X){return X.aNodes.length>0&&(b?X.getKey()===b:X.getTitle()===a);});}if(W){i=this._getElementSelectFunctionName(W);if(i){this[i]({element:W,scroll:true,alwaysSelect:true});}}}else{this.deselect(false);this.setFocus(null);}};Q.prototype._createToolbar=function(){var a=this;this._toolbar=new O(this.getId()+"-toolbar",{content:[new h()]}).addStyleClass("sapSuiteUiCommonsNetworkGraphToolbar");this.addDependent(this._toolbar);this._searchField=new g({layoutData:new k({priority:sap.m.OverflowToolbarPriority.NeverOverflow,shrinkable:true}),enableSuggestions:true,suggest:function(b){a._suggest(b.getParameter("suggestValue"));},search:function(b){var i=b.getParameter("query"),V=b.getParameter("suggestionItem"),W;if(V){W=V.getProperty("key");}a._search(i,W);}}).addStyleClass("sapSuiteUiCommonsNetworkGraphSearchField");this._toolbar.addContent(this._searchField);this._toolbar.addContent(new f({type:B.Transparent,icon:"sap-icon://legend",press:function(b){if(a.$legend.is(":visible")){a.$legend.hide();}else{a.$legend.show();}}}).setTooltip(z.getText("NETWORK_GRAPH_LEGEND")));this._toolbar.addContent(new f({layoutData:new k({group:1}),type:B.Transparent,icon:"sap-icon://zoom-in",press:function(b){a._zoom({deltaY:1});}}));this._zoomLabel=new e({layoutData:new k({group:1,priority:sap.m.OverflowToolbarPriority.Disappear}),text:"100%"});this._toolbar.addContent(this._zoomLabel);this._toolbar.addContent(new f({layoutData:new k({group:1}),type:B.Transparent,icon:"sap-icon://zoom-out",press:function(b){a._zoom({deltaY:-1});}}));this._toolbar.addContent(new f({type:B.Transparent,icon:"sap-icon://sys-monitor",press:this._fitToScreen.bind(this)}).setTooltip(z.getText("NETWORK_GRAPH_ZOOMTOFIT")));this._toolbar.addContent(new f({type:B.Transparent,icon:"sap-icon://full-screen",press:this._toggleFullScreen.bind(this)}));this._oPopup=new P({modal:true,shadow:false,autoClose:false});};Q.prototype._fitToScreen=function(){var a=this.$scroller.height()/this._iHeight,W=this.$scroller.width()/this._iWidth,b=Math.min(a,W),V=Z.slice(-1);for(var i=1;i<Z.length;i++){if(b<Z[i]){V=Z[i-1];break;}}this._zoom({zoomLevel:V});};Q.prototype._getZoomText=function(){return Math.floor((this._fZoomLevel*100))+"%";};Q.prototype._toggleFullScreen=function(a){var b=function(){this._oFullScreenContainer={};this._oFullScreenContainer.$content=this.$();if(this._oFullScreenContainer.$content){this.$().addClass("sapSuiteUiCommonsNetworkGraphFullScreen");this._oFullScreenContainer.$tempNode=q("<div></div>");this._oFullScreenContainer.$content.before(this._oFullScreenContainer.$tempNode);this._oFullScreenContainer.$overlay=q("<div id='"+u()+"'></div>");this._oFullScreenContainer.$overlay.addClass("sapSuiteUiCommonsNetworkGraphContainerOverlay");this._oFullScreenContainer.$overlay.append(this._oFullScreenContainer.$content);this._oPopup.setContent(this._oFullScreenContainer.$overlay);}this._oPopup.open(200,P.Dock.BeginTop,P.Dock.BeginTop,q("body"));}.bind(this);var i=function(){this.$().removeClass("sapSuiteUiCommonsNetworkGraphFullScreen");this._oFullScreenContainer.$tempNode.replaceWith(this._oFullScreenContainer.$content);this._oPopup.close();this._oFullScreenContainer.$overlay.remove();}.bind(this);if(this._bIsFullScreen){a.getSource().setIcon("sap-icon://full-screen");i();}else{a.getSource().setIcon("sap-icon://exit-full-screen");b();}this._bIsFullScreen=!this._bIsFullScreen;};Q.prototype._setupKeyboardNavigation=function(){var V=[],W=[[]],X,Y;if(!this._isLayedOut()){return;}this.getNodes().forEach(function(a){if(a.isHidden()||a._isIgnored()||!a.getVisible()){return;}V.push({item:a,x:a.getX(),y:a.getY()});});this.getLines().forEach(function(a){if(a.isHidden()||a._isIgnored()||!a.getVisible()||a.getCoordinates().length<2){return;}var b=a.getCoordinates()[0],i=b.getX(),$=b.getY();a.getCoordinates().forEach(function(b){if(i>b.getX()){i=b.getX();}if($>b.getY()){$=b.getY();}});V.push({item:a,x:i,y:$});});this.getGroups().forEach(function(a){if(a.isHidden()||a._isEmpty()||!a.getVisible()){return;}V.push({item:a,x:a.getX(),y:a.getY()});});V.sort(function(a,b){if(a.y<b.y){return-1;}else if(a.y>b.y){return 1;}else if(a.x<b.x){return-1;}else if(a.x>b.x){return 1;}else{return 0;}});if(V.length>0){Y=[V[0]];W=[Y];X=V[0];V.forEach(function(a,i){if(i===0){return;}if(a.y===X.y){Y.push(a);}else{Y=[a];W.push(Y);}X=a;});}W=this._normalizeGrid(W,V);if(!this._oKeyboardNavigator){this._oKeyboardNavigator=new K(this);this.addDelegate(this._oKeyboardNavigator);}this._oKeyboardNavigator.setItems(W);this._oKeyboardNavigator.setWrapperDom(this.getFocusDomRef());};Q.prototype._normalizeGrid=function(a,b){if(b.length===0){return a;}var V=b[0],W=V.x,X=V.x,Y=1,$,_,a1=[],i;b.forEach(function(b1){if(b1.x<W){W=b1.x;}if(b1.x>X){X=b1.x;}});a.forEach(function(b1){if(b1.length>Y){Y=b1.length;}});$=Math.abs(X-W)/Y;_=W;for(i=0;i<Y;i++){_+=$;a1.push(_);}return a.map(function(b1){var c1,d1;if(b1.length===Y){c1=b1;}else{c1=[];d1=0;while(d1<(Y-b1.length)&&a1[d1]<b1[0].x){d1++;c1.push(null);}b1.forEach(function(e1){c1.push(e1);d1++;});while(d1<Y){c1.push(null);d1++;}}return c1.map(function(e1){return e1?e1.item:null;});});};Q.prototype.getFocusDomRef=function(){return this.getDomRef("wrapper");};Q.prototype._setupEvents=function(){var a=5;var i=0,b={},$=this.$("eventwrapper"),V=this.$("ctrlalert"),W=this.$scroller;var X=function(o1,o2){return Math.sqrt(Math.pow(o1.clientX-o2.clientX,2)+Math.pow(o1.clientY-o2.clientY,2));};var Y=function(a1){if(a1.touches&&a1.touches.length===2){b={t1:a1.touches[0],t2:a1.touches[1],diff:X(a1.touches[0],a1.touches[1])};}};var _=function(a1){if(a1.touches&&a1.touches.length===2){if(++i===a){var b1=a1.touches[0],c1=a1.touches[1],d1=X(b1,c1);this._zoom({point:{x:(b1.clientX+c1.clientX)/2,y:(b1.clientY+c1.clientY)/2},deltaY:d1-b.diff});i=0;b={t1:b1,t2:c1,diff:d1};}}}.bind(this);W.mousemove(function(a1){this._mouseMove(a1.clientX,a1.clientY);}.bind(this));$.mousedown(function(a1){this._mouseDown(a1.clientX,a1.clientY);a1.preventDefault();}.bind(this));W.mouseleave(this._endDragging.bind(this));W.mouseup(this._mouseUp.bind(this));W.bind("wheel",function(a1){if(this._wheel({x:a1.originalEvent.clientX,y:a1.originalEvent.clientY,deltaY:a1.originalEvent.deltaY,div:V,ctrl:a1.ctrlKey})){a1.preventDefault();}}.bind(this));W.bind("touchstart",function(a1){Y(a1);});W.bind("touchmove",function(a1){_(a1);});};Q.prototype._wheel=function(a){if(this.getEnableWheelZoom()||a.ctrl){a.div.css("opacity","0");this._zoom({point:{x:a.x,y:a.y},deltaY:-a.deltaY});this._zoomLabel.setText(this._getZoomText());return true;}else{a.div.css("transition-duration","0.3s");a.div.css("opacity","0.6");setTimeout(function(){a.div.css("transition-duration","0.8s");a.div.css("opacity","0");},1500);}return false;};Q.prototype._endDragging=function(){this._oPanning.dragging=false;this.$scroller.removeClass("sapSuiteUiCommonsNetworkGraphPanning");};Q.prototype._mouseMove=function(X,Y){var a=this.$scroller[0];if(this._oPanning.dragging){if(!this.$scroller.hasClass("sapSuiteUiCommonsNetworkGraphPanning")){this.$scroller.addClass("sapSuiteUiCommonsNetworkGraphPanning");}a.scrollTop=a.scrollTop-(Y-this._oPanning.lastY);a.scrollLeft=a.scrollLeft-(X-this._oPanning.lastX);this._oPanning.lastX=X;this._oPanning.lastY=Y;}};Q.prototype._mouseDown=function(X,Y){this.deselect(false);this.setFocus(null);this._oPanning.lastX=X;this._oPanning.lastY=Y;this._oPanning.dragging=true;this._tooltip.instantClose();};Q.prototype._mouseUp=function(){this._endDragging();};Q.prototype._preventZoomToChangeLineWidth=function(){return this._isLayered()&&(this._fZoomLevel>=0.5&&this._fZoomLevel<2);};Q.prototype._setLineClasses=function(){var $=this.$(),a=this._preventZoomToChangeLineWidth()?"addClass":"removeClass",b=(this._fZoomLevel<0.5)?"removeClass":"addClass";$[a]("sapSuiteUiCommonsNetworkGraphDefaultLineWidth");$[b]("sapSuiteUiCommonsNetworkGraphCrispEdges");};Q.prototype._zoom=function(a){var b=this.$svg[0].getAttribute("viewBox"),i=a.deltaY<0?-1:1,V,W,X,Y;var $=function(_){var a1=0,b1;Z.forEach(function(c1,d1){var e1=Math.abs(_-c1);if(e1<b1||b1===undefined){a1=d1;b1=e1;}});return a1;};if(!a.point){a.point={x:this.$scroller.width()/2,y:this.$scroller.height()/2};}V=this.getCorrectMousePosition({x:a.point.x,y:a.point.y});if(a.zoomLevel||a.zoomLevel===0){this._fZoomLevel=a.zoomLevel;}else{X=$(this._fZoomLevel);if(Z.indexOf(this._fZoomLevel)<0){if(this._fZoomLevel>Z[X]){X=i<0?X:X+i;}else{X=i>0?X:X+i;}}else{X+=i;}if(X<0){X=0;}else if(X>Z.length-1){X=Z.length-1;}this._fZoomLevel=Z[X];}if(this._fZoomLevel<0){this._fZoomLevel=0;}if(!b){Y="0 0 "+Math.round(this.$svg.width())+" "+Math.round(this.$svg.height());this.$svg[0].setAttribute("viewBox",Y);}this.$svg.width(Math.round(this._iWidth*this._fZoomLevel));this.$svg.height(Math.round(this._iHeight*this._fZoomLevel));W=this.getCorrectMousePosition({x:a.point.x,y:a.point.y});this.$scroller[0].scrollLeft+=(V.x-W.x)*this._fZoomLevel;this.$scroller[0].scrollTop+=(V.y-W.y)*this._fZoomLevel;this._zoomLabel.setText(this._getZoomText());if(this._fZoomLevel<v){this.$svg.addClass("sapSuiteUiCommonsNetworkGraphZoomedOut");}else{this.$svg.removeClass("sapSuiteUiCommonsNetworkGraphZoomedOut");}if(this._isUseNodeHtml()){this.$("divnodes").css("transform","scale("+this._fZoomLevel+")");}this._setLineClasses();this.fireEvent("zoomChanged");};Q.prototype._createSearchSuggestItems=function(){var a=50;var b={items:[]},i=this.getNodes().sort(function(X,Y){return X.getTitle().localeCompare(Y.getTitle());}),V=this.getLines().sort(function(X,Y){var $=X.getTitle(),_=Y.getTitle();if($===_){return X.getFromNode().getTitle().localeCompare(Y.getFromNode().getTitle());}return $.localeCompare(_);}),W=this.getGroups().sort(function(X,Y){return X.getTitle().localeCompare(Y.getTitle());});this._oSuggestionItemsModel=new J();this._oSuggestionItemsModel.setSizeLimit(w);i.forEach(function(X){var Y=U.trimText(X.getTitle(),a);b.items.push({text:Y?Y:X.getKey(),type:x.Node,icon:X.getIcon(),key:X.getKey(),description:"("+z.getText("NETWORK_GRAPH_NODE")+")"});});V.forEach(function(X){if(X._isLoop()){return;}if(X.getTitle()||X.getFromNode().getTitle()||X.getToNode().getTitle()){b.items.push({text:X._createSuggestionHelpText(),type:x.Line,key:X._getLineId(),description:"("+z.getText("NETWORK_GRAPH_LINE")+")"});}});W.forEach(function(X){var Y=U.trimText(X.getTitle(),a);if(X.aNodes.length>0){b.items.push({text:Y?Y:X.getKey(),key:X.getKey(),type:x.Group,description:"("+z.getText("NETWORK_GRAPH_GROUP")+")"});}});this._oSuggestionItemsModel.setData(b);this._searchField.setModel(this._oSuggestionItemsModel);this._searchField.bindAggregation("suggestionItems",{path:"/items",template:new I({text:"{text}",icon:"{icon}",key:"{key}",description:"{description}",customData:new j({key:"type",value:"{type}"})})});};Q.prototype._scrollToElement=function(i){var b=i._oGroup&&i._oGroup.getCollapsed(),X,Y,W,a,V,$;if(b){i=i._oGroup;}if(i instanceof L){V=i.getSource();$=i.getTarget();W=Math.abs($.getX()-V.getX());a=Math.abs($.getY()-V.getY());X=Math.min(V.getX(),$.getX());Y=Math.max(V.getY(),$.getY());}else{X=i.getX();Y=i.getY();W=i._iWidth;a=i._iHeight;}this.$scroller.get(0).scrollLeft=((X+(W?W:0)/2)*this._fZoomLevel)-(this.$scroller.width()/2);this.$scroller.get(0).scrollTop=((Y+(a?a:0)/2)*this._fZoomLevel)-(this.$scroller.height()/2);};Q.prototype._ensureOnScreen=function(i){var a,b,V,W,X,Y,$,_;if(!i||!this.$scroller){return;}a=this.$scroller[0];if(i instanceof N){$=i.getX()+i._iWidth/2;_=i.getY()+i._iHeight/2;}else if(i instanceof L){b=i._getArrowFragmentVector();$=(b.center.x+b.apex.x)/2;_=(b.center.y+b.apex.y)/2;}else if(i instanceof G){$=i.getX();_=i.getY();}$*=this._fZoomLevel;_*=this._fZoomLevel;V=a.scrollLeft;X=a.scrollTop;W=V+this.$scroller.width();Y=X+this.$scroller.height();if($<V||$>W){a.scrollLeft=$-this.$scroller.width()/2;}if(_<X||_>Y){a.scrollTop=_-this.$scroller.height()/2;}};Q.prototype._createLegend=function(){var $=this.$("legend"),i="",V=this,W={},X={},Y={};var _=function(a,b){var d1=o(a.getStatus());if(d1){if(b[d1]){b[d1].push(a);}else{b[d1]=[a];}}};var a1=function(a){return Object.keys(a).length>0;};var b1=function(a,b){var d1=this._oStatuses[a],e1=d1&&d1._getLegendColor(),f1=d1&&d1.getTitle(),g1=e1?"background-color:"+m.get(e1):"";f1=f1||a;i+=this._renderControl("div",{status:a,elementtype:b,"class":"sapSuiteUiCommonsNetworkGraphLegendLine"},false);i+=this._renderControl("div",{"class":"sapSuiteUiCommonsNetworkGraphLegendColorLine "+this._getStatusClass(a),"style":g1});i+=this._renderControl("label",{"class":"sapSuiteUiCommonsNetworkGraphLegendLineLabel"},false);i+=o(this._oLegendLabels[b+a]?this._oLegendLabels[b+a]:f1);i+="</label>";i+="</div>";}.bind(this);var c1=function(d1,e1,f1,g1,h1){d1.forEach(function(a){_(a,e1);});if(a1(e1)){i+="<div class=\""+f1+"\"><label class=\"sapSuiteUiCommonsNetworkGraphLegendTitle\">"+o(z.getText(g1))+"</label></div>";var i1=Object.keys(e1).reduce(function(a,b){a[b]=this._oLegendLabels[h1+b]?this._oLegendLabels[h1+b]:b;return a;}.bind(this),{});Object.keys(e1).sort(function(a,b){return i1[a]>i1[b];}).forEach(function(a){b1(a,h1);});}}.bind(this);if(this.getLegend()){return;}if(!$[0]){return;}c1(this.getNodes(),W,"sapSuiteUiCommonsNetworkGraphLegendTitleNode","NETWORK_GRAPH_NODES",y.Node);c1(this.getLines(),X,"sapSuiteUiCommonsNetworkGraphLegendTitleLine","NETWORK_GRAPH_LINES",y.Line);c1(this.getGroups(),Y,"sapSuiteUiCommonsNetworkGraphLegendTitleLine","NETWORK_GRAPH_GROUPS",y.Group);$.html(i);this.$().find(".sapSuiteUiCommonsNetworkGraphLegendLine").click(function(a){var b=q(this).attr("status"),d1=q(this).attr("elementtype"),e1;if(d1===y.Node){e1=W;}if(d1===y.Line){e1=X;}if(!a.ctrlKey){V.deselect(false);V.setFocus(null);}if(d1!==y.Group&&e1[b]){e1[b].forEach(function(f1){f1.setSelected(true);});}});};Q.prototype._selectElement=function(a){var i=a.element&&!a.element.getSelected(),b=[];var V=function(W){a.element.setSelected(W);if(a.setFocus!==false){this.setFocus({item:a.element});}}.bind(this);this.$("svg").find("."+this.VISIBLE_ACTIONS_BUTTONS_CLASS).removeClass(this.VISIBLE_ACTIONS_BUTTONS_CLASS);if(!a.preventDeselect){b=this.deselect(true);if(a.setFocus){this.setFocus(null);}if(i||a.alwaysSelect){V(true);}}else{V(i);}if(!a.element._hasFocus()&&a.forceFocus){this.setFocus({item:a.element});}if(!b.some(function(W){return W===a.element;})){b.push(a.element);}this.fireSelectionChange({items:b});};Q.prototype._selectLine=function(a){var b=a.element.getFromNode(),i=a.element.getToNode(),V=(b._isInCollapsedGroup()&&(b._oGroup===i._oGroup))?i._oGroup:null;if(a.scroll){this._scrollToElement(V||a.element);}if(!V){this._selectElement(a);}};Q.prototype._selectNode=function(a){var b=a.element._isInCollapsedGroup()?a.element._oGroup:null;if(a.scroll){this._scrollToElement(b||a.element);}if(!b){this._selectElement(a);if(a.renderActionButtons!==false){a.element.showActionButtons(true);}}};Q.prototype._selectGroup=function(a){if(a.scroll){this._scrollToElement(a.element);}this.setFocus({item:a.element});};Q.prototype._applyLayout=function(){var a;this._iRunningLayouts++;a=this._getLayoutAlgorithm().layout().catch(function(b){this._fireFailure(Q.FAILURE_TYPE.LAYOUT_FAILURE,b);return Promise.reject();}.bind(this)).then(function(){return new Promise(function(b,i){if(a.isTerminated()){b();return;}if(this._validateLayout()){b();}else{i();}}.bind(this));}.bind(this));if(this._oLastLayout&&this._iRunningLayouts>1){this._oLastLayout.terminate();}this._oLastLayout=a;return a;};Q.prototype._setAccessibilityTitle=function(i){var a,W=this.$("accessibility");if(i===null){a=z.getText("NETWORK_GRAPH_ACCESSIBILITY_CONTENT");}else if(typeof i==="string"){a=i;}else{a=i._getAccessibilityLabel();}if(W){W.html(o(a));}};Q.prototype._isTopBottom=function(){return this.getOrientation()===p.TopBottom||this.getOrientation()===p.BottomTop;};Q.prototype._getLayoutAlgorithm=function(){return this.getLayoutAlgorithm()||this._getDefalutLayout();};Q.prototype._isUseNodeHtml=function(){return this.getRenderType()===R.Html;};Q.prototype._getDefalutLayout=function(){if(!this._oDefalutLayout){this._oDefaultLayout=new c();this._oDefaultLayout.setParent(this,null,true);}return this._oDefaultLayout;};Q.prototype._isLayered=function(){var a=this._getLayoutAlgorithm().getLayoutRenderType();return a===r.SwimLanes||a===r.LayeredWithGroups;};Q.prototype._isSwimLane=function(){return this._getLayoutAlgorithm().getLayoutRenderType()===r.SwimLanes;};Q.prototype._isDelayedLayouting=function(){if(this._isUseNodeHtml()){return true;}return this.getNodes().some(function(a){var b=a.hasListeners("computeSizes");return b||a._useAutomaticSize()||a.getTitleLineSize()!==1||a._displayDescription();});};Q.prototype._isLayedOut=function(){return this._bIsLayedOut;};Q.prototype.destroyAggregation=function(a,b){this._bRequiresDataProcessing=true;C.prototype.destroyAggregation.call(this,a,b);};Q.prototype.insertAggregation=function(a,b,i,V){this._bRequiresDataProcessing=true;C.prototype.insertAggregation.call(this,a,b,i,V);};Q.prototype.removeAggregation=function(a,b,i){this._bRequiresDataProcessing=true;C.prototype.removeAggregation.call(this,a,b,i);};Q.prototype.addAggregation=function(a,b,i){this._bRequiresDataProcessing=true;C.prototype.addAggregation.call(this,a,b,i);};Q.prototype.removeAllAggregation=function(a,b){this._bRequiresDataProcessing=true;C.prototype.removeAllAggregation.call(this,a,b);};Q.prototype.updateAggregation=function(a){this._bNeedNodeProcessing=true;C.prototype.updateAggregation.call(this,a);};Q.prototype.invalidate=function(){if(this._bPreventInvalidation!==true){C.prototype.invalidate.call(this);}};return Q;});
