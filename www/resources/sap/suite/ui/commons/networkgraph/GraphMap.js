/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./SvgBase","sap/ui/core/ResizeHandler"],function(q,S,R){"use strict";var N=4;var r=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var G=S.extend("sap.suite.ui.commons.networkgraph.GraphMap",{metadata:{library:"sap.suite.ui.commons",properties:{height:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:""},width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:""},directRenderNodeLimit:{type:"int",group:"Behavior",defaultValue:250},title:{type:"string",group:"Misc",defaultValue:""}},associations:{graph:{type:"sap.suite.ui.commons.networkgraph.Graph",multiple:false,singularName:"graph"}},events:{mapReady:{}}}});G.prototype.init=function(){this._oResizeListener=null;this.setBusyIndicatorDelay(0);};G.prototype.onAfterRendering=function(){this.setBusy(true);};G.prototype._renderMap=function(){var v,g,i,s,$,a,b,t=this,o=this.getGraph(),z=o._fZoomLevel,n=o.getNodes().length,u=o._isUseNodeHtml();var f=function(I){var e="";I.forEach(function(h){e+=h._render({mapRender:true,idSufix:t.getId()});});return e;};var c=function(e,w){var h=sap.ui.getCore().createRenderManager();e.forEach(function(j){j._render({mapRender:true,renderManager:h,idSufix:t.getId()});});h.flush(w);h.destroy();};var C=function(e){s+=this._renderControl("rect",{x:N/2,y:N/2,width:Math.min((o.$scroller.width()-N/2)/z,(o.$svg.width()-N/2)/z),height:Math.min((o.$scroller.height()-N/2)/z,(o.$svg.height()-N/2)/z),"class":e,id:this._getDomId("mapNavigator")});}.bind(this);if(!o._iWidth||!o._iHeight||n===0){if(o._bIsInvalid){this.setBusy(false);}return;}v=o.$("networkGraphSvg").attr("viewBox");if(!v){v="0 0 "+o._iWidth+" "+o._iHeight;}s="<svg class=\"sapSuiteUiCommonsNetworkGraphSvg\" width=\"100%\" height=\"100%\" viewBox=\""+v+"\" "+"id=\""+this._getDomId("svg")+"\"";if(o._bIsRtl){s+=" direction =\"rtl\"";}s+=" >";if(this._useGraphClone()){s+=this._renderControl("use",{"xlink:href":"#"+o._getDomId("svgbody")});}else{s+=f(o.getGroups());s+=f(o.getLines());if(!u){s+=f(o.getNodes());}}s+=this._renderControl("rect",{x:0,y:0,width:o._iWidth,height:o._iHeight,"class":"sapSuiteUiCommonsNetworkGraphMapBoundary","pointer-events":"fill"});if(!u){C("sapSuiteUiCommonsNetworkGraphMapNavigator");}s+="</svg>";if(u){s+="<div id=\""+this._getDomId("divnodes")+"\" class=\"sapSuiteUiCommonsNetworkGraphMapDivNodes\"";if(sap.ui.getCore().getConfiguration().getRTL()){s+="style=\"left:0\"";}s+=">";s+="</div>";s+="<svg class=\"sapSuiteUiCommonsNetworkGraphSvgNavigator\" width=\"100%\" height=\"100%\" viewBox=\""+v+"\">";C("sapSuiteUiCommonsNetworkGraphMapNavigator");s+="</svg>";}this.$().find(".sapSuiteUiCommonsNetworkGraphMapContent").html(s);if(u){var d=this.getDomRef("divnodes");c(o.getNodes(),d);}$=this.$("svg");g=o._iWidth;i=o._iHeight;a=Math.max(g/$.width(),i/$.height());if(u){this._setHtmlNodesPosition(a);}b=Math.ceil(a/5);this._iStrokeWidth=b;this._correctLineWidth();this.$("svg").find("circle").css("stroke-width",b);this._setupEvents();this._correctPosition();this.setBusy(false);this.fireMapReady();};G.prototype._setHtmlNodesPosition=function(i){var g=this.getGraph(),$=this.$("svg"),c=1/i,t,T;t=Math.floor(($.width()/2)-((g._iWidth/2)*c));T=Math.floor(($.height()/2)-((g._iHeight/2)*c));this.$("divnodes").css("transform","matrix("+c+", 0, 0, "+c+", "+t+", "+T+")");};G.prototype._useGraphClone=function(){var l=this.getDirectRenderNodeLimit(),g=this.getGraph();if(g){return l>g.getNodes().length&&!g._isUseNodeHtml();}return false;};G.prototype._correctLineWidth=function(g){var g=this.getGraph(),c=this._isMSBrowser()||(!this._useGraphClone()||g._preventZoomToChangeLineWidth());this.$("svg").css("stroke-width",c?this._iStrokeWidth:"1");};G.prototype._correctMapNavigator=function(){var $=this.$("mapNavigator"),w=parseFloat($.attr("width")),h=parseFloat($.attr("height")),x=parseFloat($.attr("x")),y=parseFloat($.attr("y")),g=this.getGraph(),i=g._iWidth,a=g._iHeight;if(w+x>i){$.attr("width",i-x);}if(h+y>a){$.attr("height",a-y);}};G.prototype._resize=function(){var g=this.getGraph(),$=g.$scroller,a=this.$("mapNavigator");a.attr("x",Math.max(N/2,$[0].scrollLeft/g._fZoomLevel));a.attr("y",Math.max(N/2,$[0].scrollTop/g._fZoomLevel));a.attr("width",$.width()/g._fZoomLevel);a.attr("height",$.height()/g._fZoomLevel);this._correctLineWidth();this._correctMapNavigator();};G.prototype._resizeHandler=function(){this._resize();var g=this.getGraph();if(g._isUseNodeHtml()){var $=this.$("svg"),a=this.getGraph().$svg;if(a){var i=Math.max(a.width()/$.width(),a.height()/$.height())*(1/g._fZoomLevel);this._setHtmlNodesPosition(i);}}};G.prototype._correctPosition=function(){var g=this.getGraph(),$=g&&g.$scroller,a=this.$("mapNavigator");if(g&&$[0]){a.attr("x",Math.max(N/2,$[0].scrollLeft/g._fZoomLevel));a.attr("y",Math.max(N/2,$[0].scrollTop/g._fZoomLevel));this._correctMapNavigator();}};G.prototype._setupEvents=function(){var d=false,g=this.getGraph(),$=this.$("svg"),a=g.$scroller;var s=function(o){var b=g.$svg,i=Math.max(b.width()/$.width(),b.height()/$.height()),c=$.find(".sapSuiteUiCommonsNetworkGraphMapBoundary"),f=a[0],h=c.offset().left,j=c.offset().top;f.scrollLeft=(o.pageX-h)*i-(a.width()/2);f.scrollTop=(o.pageY-j)*i-(a.height()/2);};var e=function(){$.removeClass("sapSuiteUiCommonsNetworkGraphPanning");d=false;};a.scroll(function(){this._correctPosition();}.bind(this));$.off();$.mousedown(function(E){d=true;s(E);E.preventDefault();});$.mousemove(function(E){if(d){if(!$.hasClass("sapSuiteUiCommonsNetworkGraphPanning")){$.addClass("sapSuiteUiCommonsNetworkGraphPanning");}s(E);}});$.mouseleave(function(E){e();});$.mouseup(function(E){e();});};G.prototype._onBeforeDataProcess=function(){if(this.getDomRef("svg")){this.$("svg").html("");this.setBusy(true);}};G.prototype._onGraphReady=function(){setTimeout(this._renderMap.bind(this),0);if(this._oResizeListener){R.deregister(this._oResizeListener);}this._oResizeListener=R.register(this.getGraph().$("wrapper")[0],q.proxy(this._resizeHandler,this));};G.prototype._removeListeners=function(){var g=this.getGraph();if(g){g.detachBeforeLayouting(this._onBeforeDataProcess,this);g.detachGraphReady(this._onGraphReady,this);g.detachZoomChanged(this._resize,this);}};G.prototype.destroy=function(){this._removeListeners();S.prototype.destroy.apply(this,arguments);};G.prototype.exit=function(){if(this._oResizeListener){R.deregister(this._oResizeListener);this._oResizeListener=null;}};G.prototype.getTitle=function(){var t=this.getProperty("title");return t?t:r.getText("NETWORK_GRAPH_MAP_TITLE");};G.prototype.getGraph=function(){var i=this.getAssociation("graph");return i?sap.ui.getCore().byId(i):null||null;};G.prototype.setGraph=function(g){this._removeListeners();this.setAssociation("graph",g);var o=this.getGraph();if(o){o.attachBeforeLayouting(this._onBeforeDataProcess,this);o.attachGraphReady(this._onGraphReady,this);o.attachZoomChanged(this._resize,this);if(o._isLayedOut()){this._onGraphReady();}}return this;};return G;});
