sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/suite/ui/generic/template/ListReport/controller/MultipleViewsSingleTableModeHelper","sap/suite/ui/generic/template/ListReport/controller/MultipleViewsMultipleTablesModeHelper","sap/ui/model/Filter","sap/suite/ui/generic/template/lib/testableHelper","sap/ui/Device","sap/base/Log"],function(q,B,M,a,F,t,D,L){"use strict";var P="/listReport/multipleViews";var b=P+"/selectedKey";var c=P+"/mode";var d=P+"/items";var e=P+"/msgVisibility";var f=P+"/finalMessage";function g(s,C,T){var I;var Q;var m;var S;var h,u=[];var o=T.oComponentUtils.getTemplatePrivateModel();var k;var l=T.oServices.oApplication.getBusyHelper().getBusyDelay();function n(){return Q&&Q.enableAutoBinding;}function r(){if(I&&I.fnRegisterToChartEvents){return I.fnRegisterToChartEvents.apply(null,arguments);}}function p(){if(I&&I.onDetailsActionPress){return I.onDetailsActionPress.apply(null,arguments);}}function v(){if(!I){return;}var i=G();return i.templateSortOrder;}function w(i){var j;if(!i){return"";}if(i.state==="error"){return T.oCommonUtils.getText("SEG_BUTTON_ERROR",i.text);}if(i.state===""||i.state==="busy"){var q1=sap.ui.core.format.NumberFormat.getIntegerInstance({groupingEnabled:true});j=q1.format(i.count);}return T.oCommonUtils.getText("SEG_BUTTON_TEXT",[i.text,i.state==="busyLong"?"...":j]);}function x(){if(I){var i=o.getProperty(b);var j=I.getContentForIappState(i);return{mode:m,state:j};}}function R(i){if(I){var j=I.getSelectedKeyAndRestoreFromIappState(i);if(k[j]){o.setProperty(b,j);}}}function y(){return o.getProperty(b);}function z(q1,r1){var s1=[],t1;var u1=T.oCommonUtils.getElementCustomData(r1).variantAnnotationPath;if(u1){var v1=q1[u1];if(!v1){return[];}if(!v1.SelectOptions&&v1.SelectionVariant){v1=v1.SelectionVariant;if(v1.Path){u1=v1.Path.split("@")[1];v1=u1&&q1[u1];}}if(v1.AnnotationPath){t1=v1.AnnotationPath.split("@")[1];v1=q1[t1];}for(var i in v1.SelectOptions){if(v1.SelectOptions[i].PropertyName){var w1=v1.SelectOptions[i].PropertyName.PropertyPath;for(var j in v1.SelectOptions[i].Ranges){var x1=v1.SelectOptions[i].Ranges[j].Option;x1.EnumMember=x1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/","");var y1=v1.SelectOptions[i].Ranges[j].Low;var z1=v1.SelectOptions[i].Ranges[j].High;var A1=Object.keys(y1)[0];if(z1){var B1=Object.keys(z1)[0];s1.push(new F(w1,x1.EnumMember,y1[A1],z1[B1]));}else{s1.push(new F(w1,x1.EnumMember,y1[A1]));}}}}}return s1;}function A(i){if(!I){return;}var j=i.getSource();var q1=j.getModel();var r1=q1.getMetaModel();var s1=j.getEntitySet();var t1=r1.getODataEntitySet(s1);var u1=r1.getODataEntityType(t1.entityType);var v1=function(w1,x1){var y1=z(u1,x1);var z1=T.oCommonUtils.getElementCustomData(x1);var A1=k[w1]||Object.create(null);A1.selectionVariantFilters=y1;A1.templateSortOrder=z1.TemplateSortOrder;A1.implementingControl=j;A1.dirtyState=0;k[w1]=A1;if(S){var B1=d+"/"+w1;var C1=function(E1,F1,G1){if(A1.numberOfUpdates!==F1){return;}var D1=q.extend({},o.getProperty(B1));if(!D1.state&&E1=="busy"){setTimeout(function(){if(o.getProperty(B1).state==="busy"){D1=q.extend({},o.getProperty(B1));D1.state="busyLong";o.setProperty(B1,D1);}},l);}D1.state=E1;if(!E1){D1.count=G1;}o.setProperty(B1,D1);};A1.numberOfUpdates=0;A1.updateStartFunction=C1.bind(null,"busy");A1.updateSuccessFunction=C1.bind(null,"");A1.errorFunction=C1.bind(null,"error");var D1={text:z1.text,count:0,state:""};o.setProperty(B1,D1);}};I.init(i,v1);}function E(){return m;}function G(){return k[o.getProperty(b)];}function H(i){if(!I){return;}var j=i.getParameter("bindingParams");s.oFiltersWithoutSmartFilterBar=q.extend(true,{},j);if(E()==="multi"){var q1=s.oSmartFilterbar.getFilters();s.oFiltersForCounts=K(j);V(s.oSmartTable,j,q1);}else if(E()==="single"){s.oFiltersForCounts=q.extend(true,{},j);}J(j);}function J(j){var q1=G();if(q1){var r1=q1.selectionVariantFilters;for(var i in r1){j.filters.push(r1[i]);}}}function K(i){var j=q.extend(true,{},i);O(j.filters,s.oMultipleViewsHandler.aTableFilters);return j;}function N(i,j){if(I.getIsDifferentEntitySets&&I.getIsDifferentEntitySets()){d1(i,j.filters);}}function O(q1,r1){for(var i in r1){var s1=r1[i];for(var j=q1.length;j--;j>=0){if(JSON.stringify(q1[j])===JSON.stringify(s1)){q1.splice(j,1);break;}}}}function U(){var i=s.oSmartTable.getModel();var j=[],q1;var r1=s.oSmartFilterbar.getBasicSearchValue();var s1={};var t1;var u1=s.oSmartTable;var v1=k[o.getProperty(b)];if(r1){s1={search:r1};}var w1;for(var x1 in k){w1=q.extend(true,{},s.oFiltersForCounts);t1=s.oSmartFilterbar.getFilters();var y1=k[x1];q1=y1.entitySet;if(!q1){q1=s.oSmartTable.getEntitySet();}y1.numberOfUpdates++;y1.updateStartFunction(y1.numberOfUpdates);if(E()==="multi"){V(y1.implementingControl,w1,t1);}j=w1.filters.concat(y1.selectionVariantFilters);i.read("/"+q1+"/$count",{urlParameters:s1,filters:j,groupId:"updateMultipleViewsItemsCounts",success:y1.updateSuccessFunction.bind(null,y1.numberOfUpdates),error:y1.errorFunction.bind(null,y1.numberOfUpdates)});}if(v1&&v1.entitySet===u1.getEntitySet()&&(v1.implementingControl.getMetadata().getElementName()===u1.getMetadata().getElementName())){k1(u);}}function V(i,j,q1){N(i,j);Z(i,q1,j);}function W(){if(S){U();}}function X(){return S;}function Y(i){var j=T.oCommonUtils.getMetaModelEntityType(i);return j.navigationProperty;}function Z(i,j,q1){var r1=[],s1=[],t1;if(j.length<1){return;}if(I.getIsDifferentEntitySets&&I.getIsDifferentEntitySets()){r1=d1(i,j);}else{r1=j;}s1=q1.filters&&q1.filters.slice();s1=s1.concat(r1);t1=new F(s1,true);q1.filters=[t1];}function $(i){var j;for(j in k){if(k[j].implementingControl===i){return k[j].properties;}}}function _(j,q1,r1,s1,t1){var u1,v1,w1,x1,y1;if(j.indexOf("/")!==-1){u1=j.split("/");for(var i=0;i<u1.length-1;i++){v1=u1[i];for(var i in t1){if(t1[i].name===v1){w1=true;break;}}if(!w1){return false;}x1=r1.getODataAssociationEnd(s1,v1);s1=x1&&r1.getODataEntityType(x1.type);t1=s1&&s1.navigationProperty;}y1=s1&&s1.property;}else{y1=$(q1);}return y1;}function a1(i){var j,q1;if(i.indexOf("/")!==-1){j=i.split("/");q1=j.pop();}else{q1=i;}return q1;}function b1(i){var j=T.oCommonUtils.isSmartTable(s.oSmartTable);if(i!==2){s.oSmartTable[j?"rebindTable":"rebindChart"]();}if(i>1){if(j){T.oCommonUtils.refreshModel(s.oSmartTable);T.oCommonUtils.refreshSmartTable(s.oSmartTable);}else{}}}function c1(i,j,q1){if(!I){return false;}var r1=Array.isArray(j);if((r1&&j.length===0)||(q1&&q.isEmptyObject(q1))){return true;}var s1=y();var t1=T.oComponentUtils.isComponentActive();if(m==="single"){if(r1?j.indexOf(s1)<0:(j&&j!==s1)){return true;}if(t1){b1(i);return true;}else{j=s1;r1=false;}}var u1=function(v1){if(v1===s1&&t1){b1(i);return;}var w1=k[v1];if(w1.dirtyState>0&&w1.dirtyState!==i){w1.dirtyState=3;}else{w1.dirtyState=i;}};if(j){if(r1){j.forEach(u1);return true;}u1(j);return true;}for(var v1 in k){if(!q1||q1[k[v1].implementingControl.getEntitySet()]){u1(v1);}}return true;}function d1(i,q1){var r1,s1,t1,j,u1,v1,w1,x1,y1,z1,y1,A1,B1=[];if(!q1||q1.length<1){return;}w1=i.getModel().getMetaModel();x1=T.oCommonUtils.getMetaModelEntityType(i);v1=Y(i);A1=k[o.getProperty(b)];y1=q.extend(true,[],q1);if(y1[0]&&y1[0].aFilters instanceof Array){u1=y1[0].aFilters;}else{u1=y1;}if(!u1){return;}for(j=u1.length-1;j>=0;j--){s1=false;if(u1[j].aFilters instanceof Array){t1=u1[j].aFilters[0].sPath;}else{t1=u1[j].sPath;}r1=_(t1,i,w1,x1,v1);if(!r1){u1.splice(j,1);continue;}z1=a1(t1);r1.some(function(C1){if(C1.name===z1){s1=true;return s1;}});if(!s1){if(A1&&A1.entitySet===i.getEntitySet()&&(A1.implementingControl.getMetadata().getElementName()===i.getMetadata().getElementName())){if(!B1.includes(z1)){B1.push(z1);}}u1.splice(j,1);}}if(y1&&y1[0]&&y1[0].aFilters&&y1[0].aFilters.length<1){y1=[];}if(A1&&A1.entitySet===i.getEntitySet()&&(A1.implementingControl.getMetadata().getElementName()===i.getMetadata().getElementName())){e1(B1,i);}return y1;}function e1(i,j){var q1,r1,s1=[];var t1=k[o.getProperty(b)];if(t1&&t1.entitySet===j.getEntitySet()&&(t1.implementingControl.getMetadata().getElementName()===j.getMetadata().getElementName())){for(var u1 in i){q1=l1(i[u1],j);r1=q1["sap:label"]?q1["sap:label"]:q1.name;if(!s1.includes(r1)){s1.push(r1);}}h=h1(j);m1(s1,h);}u=s1;}function f1(i,j){var q1;q1=o1(i);if(q1){i.removeCustomData(q1);}i.addCustomData(new sap.ui.core.CustomData({"key":"multiTabMessageInfo","value":j}));}function g1(i){var j,q1=[];for(j in k){if(k[j].implementingControl!==i){q1.push(k[j].properties);}}return q1;}function h1(i){var j=o.getProperty(b);var q1=C.getOwnerComponent().getAppComponent().getConfig();var r1=q1&&q1.pages[0]&&q1.pages[0].component&&q1.pages[0].component.settings;var s1=r1.quickVariantSelectionX.variants[j];var t1=T.oCommonUtils.getMetaModelEntityType(i);var u1=t1[s1.annotationPath];if(u1&&u1.Text){return(u1.Text.String);}}function i1(i){if(i&&i.length>0){o.setProperty(e,true);}else{o.setProperty(e,false);}}function j1(){var i=s.oSmartTable;var j=o1(i);if(j){var q1={"filters":j.getValue().filters,"selectedKey":j.getValue().selectedKey,"isClosed":true};f1(i,q1);i1();}}function k1(u){var i=false;var j=s.oSmartTable;var q1=o1(j);if(q1&&q1.getValue().isClosed){if(q1.getValue().filters.length===u.length){if(JSON.stringify(q1.getValue().filters)===JSON.stringify(u)){i=true;}}}q1={"filters":u,"selectedKey":h};if(i){i1();q1.isClosed=true;}else{i1(u);q1.isClosed=false;}f1(j,q1);}function l1(i,j){var q1,r1;var s1=g1(j);for(q1 in s1){r1=s1[q1].filter(function(t1){if(t1.name===i){return t1;}})[0];if(r1){break;}}return r1;}function m1(i,h){var j="";if(i){if(D.system.tablet||D.system.phone){if(i.length>1){j=T.oCommonUtils.getText("MESSAGE_MULTIPLE_VALUES_S_FORM",[i.join(", "),h]);}else{j=T.oCommonUtils.getText("MESSAGE_SINGLE_VALUE_S_FORM",[i[0],h]);}}else{if(i.length>1){j=T.oCommonUtils.getText("MESSAGE_MULTIPLE_VALUES_L_FORM",[i.join(", "),h]);}else{j=T.oCommonUtils.getText("MESSAGE_SINGLE_VALUE_L_FORM",[i[0],h]);}}}o.setProperty(f,j);}function n1(i){var j;j=o1(i);if(j){var q1=j.getValue();m1(q1.filters,q1.selectedKey);i1(q1.filters);}else{i1(u);}}function o1(i){var j;var q1=k[o.getProperty(b)];if(q1.entitySet===i.getEntitySet()&&(q1.implementingControl.getMetadata().getElementName()===i.getMetadata().getElementName())){var r1=i.getCustomData();for(var s1=0;s1<r1.length;s1++){if(r1[s1].getKey()&&r1[s1].getKey()==="multiTabMessageInfo"){j=r1[s1];break;}}}return j;}function p1(){var j=false;for(var i in Q.variants){if(!!Q.variants[i].entitySet){j=true;}else{j=false;}}return j;}(function(){var i,j,q1,r1;i=C.getOwnerComponent().getAppComponent().getConfig();j=i&&i.pages[0]&&i.pages[0].component&&i.pages[0].component.settings;if(!j){return;}q1=j.quickVariantSelectionX;r1=j.quickVariantSelection;if(q1&&r1){throw new Error("Defining both QuickVariantSelection and QuickVariantSelectionX in the manifest is not allowed.");}Q=q1||r1;if(!Q){return;}S=(q1&&p1())||Q.showCounts;k=Object.create(null);o.setProperty(P,Object.create(null));o.setProperty(d,Object.create(null));var s1=C.byId("page");var t1=function(u1){o.setProperty(b,u1);var v1=o.bindProperty(b);v1.attachChange(function(w1){u=[];i1(u);if(s1){s1.setPreserveHeaderStateOnScroll(true);}var x1=w1.getSource().getValue();if(I.onSelectedKeyChanged){I.onSelectedKeyChanged(x1);}var y1=s.oIappStateHandler.areDataShownInTable()||s.oWorklistData.bWorkListEnabled;var z1=(m==="single")?3:k[x1].dirtyState;if(s.oWorklistData.bWorkListEnabled&&z1<2){z1=z1+2;}if(y1&&z1>0){b1(z1);}else{T.oCommonUtils.setEnabledToolbarButtons(s.oSmartTable);n1(s.oSmartTable);}k[x1].dirtyState=0;s.oIappStateHandler.changeIappState(true,y1);if(T.oCommonUtils.isSmartTable(s.oSmartTable)){if(s1&&s1.getPreserveHeaderStateOnScroll()){s1.setPreserveHeaderStateOnScroll(false);}}});};if(r1){I=new M(r1,s,C,T,t1,k);m="single";L.info("This list supports multiple views with single table");}else{I=new a(q1,s,C,T,t1,k);m="multi";L.info("This list supports multiple views with multiple tables/charts");}o.setProperty(c,m);})();var O=t.testable(O,"fnRemoveTableSettingsFromFilters");var d1=t.testable(d1,"fnCheckIfFiltersSupported");var $=t.testable($,"findEntityProperties");var Z=t.testable(Z,"fnAddFiltersFromSmartFilterbar");var z=t.testable(z,"getSelectionVariantFilters");t.testable(function(){return I;},"getImplementingHelper");return{getEnableAutoBinding:n,fnRegisterToChartEvents:r,onDetailsActionPress:p,determineSortOrder:v,onDataRequested:W,formatItemTextForMultipleView:w,getContentForIappState:x,restoreFromIappState:R,getVariantSelectionKey:y,init:A,getMode:E,onRebindContentControl:H,getShowCounts:X,refreshOperation:c1,onMessageCloseActionPress:j1};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.MultipleViewsHandler",{constructor:function(s,C,T){q.extend(this,g(s,C,T));}});});
