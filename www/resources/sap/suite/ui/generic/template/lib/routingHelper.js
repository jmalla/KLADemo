sap.ui.define(["sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/generic/app/util/ModelUtil","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/FlexibleColumnLayoutHandler","sap/suite/ui/generic/template/lib/testableHelper","sap/suite/ui/generic/template/js/AnnotationHelperReuseComponents","sap/m/MessageBox","sap/base/Log"],function(F,a,M,C,b,t,A,c,L){"use strict";var p="---";function d(i,j,V,W,X){var Y={};Y={viewName:V,controlId:j,controlAggregation:X};var Z=i.getTargets();Z.addTarget(W,Y);}function e(i,j){if(i.oTemplateContract.oFlexibleColumnLayoutHandler){i.oTemplateContract.oFlexibleColumnLayoutHandler.createMessagePageTargets(d.bind(null,i.oRouter,j,"sap.suite.ui.generic.template.fragments.MessagePage"));}else{d(i.oRouter,j,"sap.suite.ui.generic.template.fragments.MessagePage","messagePage","pages");}}function E(i,j,V){var W=i[j];if(!W){W={draftSpec:"OData",level:0,children:[]};for(var X in i){var Y=i[X];if(Y.level===1){W.children.push(X);break;}}i[j]=W;}if(W.hasOwnProperty("isDraft")){return;}if(W.draftSpec==="parent"){if(W.parent){E(i,W.parent,V);var Z=i[W.parent];W.isDraft=Z.isDraft;}else if(W.level===1){for(var $ in i){var _=i[$];if(_.level===0){W.isDraft=_.isDraft;return;}}}return;}if(W.draftSpec==="OData"){var a1=V.getDraftContext();W.isDraft=a1.isDraftEnabled(j);return;}W.isDraft=W.draftSpec;}function f(i,j){var V=i.oAppComponent.getModel();var W=V.getMetaModel();W.loaded().then(function(){var X=i.oTemplateContract.mEntityTree;var Y=i.oAppComponent.getTransactionController().getDraftController();E(X,j.entitySet,Y);for(var Z in X){E(X,Z,Y);}});}function g(i){var j=i.oTemplateContract.oNavigationHost.getId();var V=i.oAppComponent.getConfig();if(!V.pages||!V.pages.length){throw new Error("Route Configuration missing");}if(V.pages.length>1){throw new Error("Currently only one Top route supported");}var W=V.pages[0];i.oTemplateContract.mEntityTree=Object.create(null);i.oTemplateContract.mRoutingTree=Object.create(null);var X=r([],W,"root",0,null,i,j);i.oRouter.addRoute(X);var Y={sRouteName:"root",pattern:"",level:0,children:[]};i.oTemplateContract.mRoutingTree.root=Y;n(X,i);h("root",W,0,null,i,j,Y.children);e(i,j);f(i,X);return W.entitySet;}function h(j,V,W,X,Y,Z,$,_){var i,a1;if(V.pages){a1=V.pages.length;for(i=0;i<a1;i++){m(j,V.pages[i],(W+1),X,Y,Z,$,_);}}}function H(i,j,V,W,X,Y,Z,$){var _=W.target;var a1={pages:j.pages};var b1={pattern:W.pattern+"/"+i,entitySet:W.entitySet,name:W.name,contextPath:W.contextPath,patternDelimiter:p,embeddedComponent:i};h(_,a1,V,b1,X,Y,Z,$);}function k(i,j,V,W,X,Y,Z,$,_){var a1={};var b1={key:Y,componentName:Z.componentName,componentUsage:Z.componentUsage,hiddenByDefault:Z.hiddenByDefault,containerId:$,sectionId:_,pages:Z.pages||[],children:[],communicationObject:a1};i.embeddedComponents[Y]=b1;if(Z.pages){H(Y,Z,j,V,W,X,b1.children,a1);}}function l(i,j,V,W,X,Y){i.embeddedComponents=Object.create(null);if(j.implementingComponent){k(i,V,W,X,Y,"implementation",j.implementingComponent,"template::ImplementingComponent");}else if(j.embeddedComponents){for(var Z in j.embeddedComponents){var $=j.embeddedComponents[Z];k(i,V,W,X,Y,Z,$,A.formatIdComponentContainer($),A.formatIdComponentSection($));}}}function m(i,j,V,W,X,Y,Z,$){if(j.component){var _={parent:W&&W.entitySet,parentRoute:W?W.name:"root",parentEmbeddedComponent:W&&W.embeddedComponent,navigationProperty:j.navigationProperty,level:V,children:[],communicationObject:$,defaultLayoutType:j.defaultLayoutType,noKey:j.routingSpec&&j.routingSpec.noKey,noOData:j.routingSpec&&j.routingSpec.noOData,draftSpec:j.routingSpec?j.routingSpec.draftSpec||"parent":"OData"};var a1=r(i,j,j.component.list?"aggregation":"detail",V,W,X,Y);_.sRouteName=a1.name;_.entitySet=a1.entitySet;_.pattern=a1.pattern;if(Z){Z.push(a1.entitySet);}X.oTemplateContract.mRoutingTree[a1.name]=_;var b1=X.oTemplateContract.mEntityTree[a1.entitySet];if(!b1||b1.level>_.level){X.oTemplateContract.mEntityTree[a1.entitySet]=_;}X.oRouter.addRoute(a1);n(a1,X);o(X,a1);h(a1.target,j,V,a1,X,Y,_.children,$);l(_,j,V,a1,X,Y);}}function n(i,j){var V=jQuery.extend({},i);V.name=i.name+"query";V.pattern=i.pattern+"{?query}";j.oRouter.addRoute(V);}function o(i,j){var V=i.oTemplateContract.mEntityTree[j.entitySet];if(j.routingSpec&&j.routingSpec.noOData){V.headerTitle=j.routingSpec.headerTitle;V.titleIconUrl=j.routingSpec.titleIconUrl;}else{var W=i.oAppComponent.getModel();var X=W.getMetaModel();X.loaded().then(function(){var Y=X.getODataEntitySet(j.entitySet);var Z=X.getODataEntityType(Y.entityType);var $=Z["com.sap.vocabularies.UI.v1.HeaderInfo"];var _=($&&$.TypeName&&$.TypeName.String)||"";if(_.substr(0,7)==="{@i18n>"){var a1=_.substring(1,_.length-1);var b1=a1.split(">");_=i.oAppComponent.getModel(b1[0]).getResourceBundle().getText(b1[1]);}V.headerTitle=_;var c1=($&&$.Title&&$.Title.IconUrl&&$.Title.IconUrl.String)||"";V.titleIconUrl=c1;});}}function D(i){var j,V,W;if(i){j=i.pattern;V=i.navigationProperty||i.entitySet;if(j&&V){W=j.indexOf("{?query}");if(W>0){j=j.substring(0,W);}W=-1;V+="({keys";W=j.indexOf(V);if(W>0){j=j.substring(W);}if(i.navigationProperty){j=j.replace(i.navigationProperty,i.entitySet);}j="/"+j;}}return j;}function q(i,j){return j?j.contextPath+(i.routingSpec.binding?("/"+i.routingSpec.binding):""):"";}function r(i,j,V,W,X,Y,Z){var $=jQuery.isArray(i)?i:[i];var _,a1;_=(W===1)?j.entitySet:j.navigationProperty;a1=jQuery.extend({},j);a1.path="/"+j.entitySet;a1.operation=V;a1.viewLevel=W;a1.template=j.component?(j.component.name||j.component):j.template;switch(V){case"root":a1.name="root";a1.pattern="";break;case"aggregation":a1.name=_+"~aggregation";a1.pattern=_;break;default:a1.name=_;var b1=j.routingSpec&&j.routingSpec.noKey?"":"({keys"+W+"})";a1.pattern=_+b1;break;}if(X){a1.name=X.name+"/"+(X.embeddedComponent?X.embeddedComponent+"/":"")+a1.name;a1.pattern=X.pattern+(X.patternDelimiter||"/")+a1.pattern;a1.parentEntitySet=X.entitySet;}var c1;var d1=a1.name;if(Y.oTemplateContract.oFlexibleColumnLayoutHandler){c1=Y.oTemplateContract.oFlexibleColumnLayoutHandler.adaptRoutingInfo(a1,d1,$);}else{c1="pages";a1.target=d1;}d(Y.oRouter,Z,a1.name,d1,c1);var e1=new Promise(function(f1){Y.mRouteToComponentResolve[a1.name]=f1;});Y.oTemplateContract.mRouteToTemplateComponentPromise[a1.name]=e1;a1.contextPath=(j.routingSpec&&j.routingSpec.noOData)?q(j,X):D(a1);return a1;}function I(i,j){var V;if(!i.oHashChanger.getHash()){V="";if(j&&j.route&&j.route.length===1){V=j.route[0];i.navigate(V,true);}}i.oRouter.initialize();i.fnInitializationResolve();}function B(j,V,W,X){var i,Y,Z,$,_=[],a1;Y=W.length;for(i=0;i<Y;i++){Z=W[i].PropertyPath;$=X[Z][0];_.push(new F(Z,a.EQ,$));}if(j.oAppComponent.getTransactionController().getDraftController().getDraftContext().isDraftEnabled(V)){var b1=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});_.push(b1);}a1=new F(_,true);return a1;}function R(j,V,W){jQuery.sap.require("sap.ui.model.analytics.odata4analytics");var X="/"+V;try{var Y=new sap.ui.model.analytics.odata4analytics.Model(sap.ui.model.analytics.odata4analytics.Model.ReferenceByModel(j));var Z=Y.findQueryResultByName(V);var $=new sap.ui.model.analytics.odata4analytics.QueryResultRequest(Z);var _=Z&&Z.getParameterization();var a1=false;if(_){$.setParameterizationRequest(new sap.ui.model.analytics.odata4analytics.ParameterizationRequest(_));var b1=_.getAllParameterNames();jQuery.each(b1,function(){if(W.hasOwnProperty(this)){a1=true;$.getParameterizationRequest().setParameterValue(this,W[this][0]);}});for(var i=0;i<b1.length;i++){if(b1[i].startsWith("P_")){var c1=b1[i].substr(2);if(W.hasOwnProperty(c1)){a1=true;$.getParameterizationRequest().setParameterValue(b1[i],W[c1][0]);}}}if(a1){X=$.getURIToQueryResultEntitySet();}}}catch(d1){L.info(d1.name+":"+d1.message);}return X;}function s(i,j,V,W,X){return new Promise(function(Y,Z){var $=R(V,i,W);V.read($,{filters:[j],success:function(_){var a1=v(_,V,W);if(a1){var b1=V.getKey(a1);if(b1){Y({"status":"success","value":b1,"iLevel":X});}}Y({"status":"noData"});},error:function(){Y({"status":"error"});}});});}function u(j,V,W,X,Y,Z,$){var _=[],a1,b1,c1;var d1=new Promise(function(e1){e1({"status":"success","value":$,"iLevel":0});});if(W&&X&&Y){if(Z.aNavigablePages){for(var i=0;i<Z.aNavigablePages.length;i++){if(Z.aNavigablePages&&Z.aNavigablePages[i]&&Z.aNavigablePages[i].bNavigationWithTechnicalKeyPossible){_.push(d1);continue;}a1=Z.aNavigablePages[i];b1=B(j,a1.sEntitySet,a1.aSemanticKey,X);c1=s(a1.sEntitySet,b1,Y,X,a1.iLevel);_.push(c1);}}return Promise.all(_).then(function(e1){if(e1[0]&&e1[0].status&&e1[0].status==="success"){var i,f1="",g1;for(i=0;i<e1.length;i++){if(e1[i]&&e1[i].status&&e1[i].status==="success"){g1=e1[i].value;if(i>0){g1=g1.replace(Z.aNavigablePages[i].sEntitySet,Z.aNavigablePages[i].sNavigationProperty);g1='/'+g1;}f1=f1.concat(g1);continue;}else{break;}}j.navigate(f1,true);}I(j,X);});}}function v(V,W,X){var Y,i,Z,$;if(V&&V.results){Z=V.results.length;if(Z===0){$=null;}else if(Z===1){$=V.results[0];}else if(Z>=1){var _=[];var a1=[];for(i=0;i<Z;i++){Y=V.results[i];if(Y&&Y.IsActiveEntity){a1.push(Y);}else if(Y&&Y.IsActiveEntity===false){_.push(Y);}}if(a1.length===0&&_.length>=2){var b1;for(var j=0;j<_.length;j++){b1=_[j];if(b1.DraftUUID===X.DraftUUID){$=b1;break;}}if(!$){$=_[0];}}else if(a1.length===1&&_.length===1){$=a1[0];}else if(a1.length===1&&_.length>=2){$=a1[0];}}}return $;}function w(i,j){if((i&&j)||(j==="display")){return{mode:"unsupported"};}var V={mode:"display",force:"false"};V.mode=j||i||V.mode;V.force=!!j;return V;}function x(j,V,W,X,Y){var Z=z(j,V,W,X,Y);if(Z.aNavigablePages&&Z.aNavigablePages[0]&&Z.aNavigablePages[0].aSemanticKey&&Z.aNavigablePages[0].iLevel===0){u(V,W,Z.aNavigablePages[0].aSemanticKey,X,j,Z);return;}else if(Z.aNavigablePages&&Z.aNavigablePages[0]&&Z.aNavigablePages[0].bNavigationWithTechnicalKeyPossible){if(X.IsActiveEntity&&X.IsActiveEntity[0]==="false"&&X.DraftUUID&&X.DraftUUID[0]!==""){var $=[];for(var i=0;i<Z.aNavigablePages[0].aTechnicalKey.length;i++){var _=Z.aNavigablePages[0].aTechnicalKey[i]&&Z.aNavigablePages[0].aTechnicalKey[i].name;if(_==="DraftUUID"||_==="IsActiveEntity"){continue;}if(X.hasOwnProperty(_)){$.push({PropertyPath:_});}}var a1=j.createKey(W,X);u(V,W,$,X,j,Z,a1);return;}var a1=j.createKey(W,X);if(a1){if(Z){var $=[];for(var i=0;i<Z.aNavigablePages[0].aTechnicalKey.length;i++){var _=Z.aNavigablePages[0].aTechnicalKey[i]&&Z.aNavigablePages[0].aTechnicalKey[i].name;if(_==="DraftUUID"||_==="IsActiveEntity"){continue;}if(X.hasOwnProperty(_)){$.push({PropertyPath:_});}}u(V,W,$,X,j,Z,a1);return;}V.navigate(a1,true);}}I(V,X);}function y(j,V){var i,W,X=false,Y,Z;if(V&&j){W=j.length;for(i=0;i<W;i++){X=true;Y=j[i];Z=Y.name||Y.PropertyPath;if(!V[Z]||V[Z].length>1){X=false;break;}}}return X;}function G(j,V,W,X,Y,Z){var $,_,a1,b1,c1,d1,e1;for(var i=0;i<X.length;i++){d1=X[i];if(d1&&d1.navigation&&d1.navigation[W.mode]){continue;}_=j.getMetaModel().getODataEntitySet(d1.entitySet);a1=d1.component&&d1.component.settings&&d1.component.settings.allowDeepLinking;if(!_||!(Y===0||a1)){continue;}b1=j.getMetaModel().getODataEntityType(_.entityType);c1=b1["com.sap.vocabularies.Common.v1.SemanticKey"];$={};e1={};if(c1&&y(c1,V)){$["sEntitySet"]=d1.entitySet;$["aSemanticKey"]=c1;$["sNavigationProperty"]=d1.navigationProperty;$["iLevel"]=Y;Z.push($);}else{if(b1.key.propertyRef&&(Y===0)&&y(b1.key.propertyRef,V)){e1.bNavigationWithTechnicalKeyPossible=y(b1.key.propertyRef,V);e1.aTechnicalKey=b1.key.propertyRef;Z.push(e1);}}if(d1.pages){G(j,V,W,d1.pages,++Y,Z);}else{break;}}return Z;}function z(i,j,V,W,X){var Y={},Z=[],$=[];var _=j.oAppComponent.getConfig();Z=_.pages&&_.pages[0]&&_.pages[0].pages;if(!Z){return{};}$=G(i,W,X,Z,0,$);Y.aNavigablePages=$;return Y;}function P(i){var j=i.oAppComponent.getModel("_templPrivGlobal");j.setProperty("/generic/forceFullscreenCreate",true);}function T(V,W,X){var Y,Z,$,_,a1,b1,i,c1,j,d1,e1;if(jQuery.isEmptyObject(X)){return;}Y=V&&V.getMetaModel();Z=Y&&Y.getODataEntitySet(W);$=Z&&Z.entityType;_=Y&&Y.getODataEntityType($);a1=_&&_.property;b1=[];e1=a1&&a1.length;for(i=0;i<e1;i++){c1=a1[i];if(c1["type"]==="Edm.Guid"){b1.push(c1["name"]);}}for(j=0;j<b1.length;j++){if(!X[b1[j]]){continue;}d1=X[b1[j]][0];d1=d1.toLowerCase().replace(/(guid')([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})(')/,"$2");if(!d1.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/)){d1=d1.replace(/([0-9a-f]{8})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{12})/,"$1-$2-$3-$4-$5");}X[b1[j]][0]=d1;}}function J(i){var j=i.oAppComponent.getConfig();var V=j.settings;var W=V&&V.inboundParameters;var X=[];if(W){Object.keys(W).forEach(function(Y){if(W[Y].useForCreate){X.push(Y);}});}return X;}function S(j,V){var W;var X=J(j);for(var i=0;i<X.length;i++){var Y=X[i];var Z=V[Y];if(Z&&Z.length===1){W=W||Object.create(null);W[Y]=Z[0];}}return W;}function K(j,V,W){var X;X=j.oAppComponent.getModel();X.attachMetadataFailed(j.fnInitializationResolve);X.getMetaModel().loaded().then(function(){var Y;T(X,V,W);var Z=W.preferredMode&&W.preferredMode[0];var $=W.mode&&W.mode[0];var _=w(Z,$);switch(_.mode){case"create":P(j);var a1=S(j,W);var b1=C.create(j.oAppComponent.getTransactionController().getDraftController(),V,"/"+V,X,j.oTemplateContract.oApplicationProxy.setEditableNDC,a1);b1.then(function(i){j.navigateToContext(i,"",true,4).then(I.bind(null,j,W));},function(i){I(j,W);j.navigateToMessagePage({title:j.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),text:i.messageText,description:"",icon:"sap-icon://message-error"});});j.oTemplateContract.oBusyHelper.setBusy(b1,true);break;case"createWithContext":P(j);var c1=new Promise(function(g1,h1){var i1=function(o1){h1();I(j,W);j.navigateToMessagePage({title:j.oTemplateContract.getText("ST_ERROR"),text:(o1&&o1.messageText)||j.oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),icon:"sap-icon://message-error",description:""});};Y=X.getMetaModel().getODataEntitySet(V);var j1=Y["com.sap.vocabularies.Common.v1.DraftRoot"];if(j1&&j1.NewAction){var k1=X.getMetaModel().getODataFunctionImport(j1.NewAction.String.split("/")[1]);var l1={};if(k1){var m1=k1.parameter?k1.parameter.length:0;for(var i=0;i<m1;i++){var n1=k1.parameter[i];if(n1.mode==="In"&&W[n1.name]&&W[n1.name][0]){l1[n1.name]=W[n1.name][0];}}X.callFunction("/"+k1.name,{success:function(o1,p1){var q1=new M(X);var r1=q1.getContextFromResponse(o1);if(r1){g1();j.navigateToContext(r1,null,true,4).then(I.bind(null,j,W));}else{i1();}},error:i1,method:"POST",urlParameters:l1});}else{i1();}}else{i1();}});j.oTemplateContract.oBusyHelper.setBusy(c1,true);break;case"edit":var d1=z(X,j,V,W,_);if(d1.aNavigablePages&&d1.aNavigablePages[0]&&(d1.aNavigablePages[0].bNavigationWithTechnicalKeyPossible||(d1.aNavigablePages[0].aSemanticKey&&d1.aNavigablePages[0].iLevel===0))){var e1="";var f1;if(d1.aNavigablePages[0].bNavigationWithTechnicalKeyPossible){e1=X.createKey(V,W);f1=C.edit(j.oAppComponent.getTransactionController(),V,"/"+e1,X,j.oTemplateContract,j.fnInitializationResolve);}else if(d1.aNavigablePages&&d1.aNavigablePages[0]&&d1.aNavigablePages[0].aSemanticKey&&d1.aNavigablePages[0].iLevel===0){e1="";f1=C.edit(j.oAppComponent.getTransactionController(),V,e1,X,j.oTemplateContract,j.fnInitializationResolve,d1.aNavigablePages[0].aSemanticKey,W);}f1.then(function(i){j.navigate(i.context.getPath(),true);I(j);},function(i){if(i.lockedByUser){if(!_.force){x(X,j,V,W,_);}else{j.fnInitializationResolve();j.navigateToMessagePage({title:j.oTemplateContract.getText("LOCKED_OBJECT_POPOVER_TITLE"),text:j.oTemplateContract.getText("LOCKED_OBJECT_POPOVER_TITLE"),description:j.oTemplateContract.getText("ST_GENERIC_LOCKED_OBJECT_POPOVER_TEXT",[i.lockedByUser]),icon:"sap-icon://message-error",replaceURL:true});}}else if(i.draftAdminReadResponse){I(j,W);}else{var g1=j.oTemplateContract.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_EDIT");c.warning(g1,{onClose:function(h1){x(X,j,V,W,{mode:"display",force:false});}});}});}else{I(j,W);}break;case"display":x(X,j,V,W,_);break;default:j.fnInitializationResolve();j.navigateToMessagePage({title:j.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),text:j.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),description:j.oTemplateContract.getText("PARAMETER_COMBINATION_NOT_SUPPORTED",[$,Z]),icon:"sap-icon://message-error",replaceURL:true});}});}function N(i){var j=i.oAppComponent.getConfig();if(j.settings&&j.settings.flexibleColumnLayout){i.oTemplateContract.oFlexibleColumnLayoutHandler=new b(i.oTemplateContract.oNavigationHost,i);}var V=g(i);var W=i.oAppComponent.getComponentData();var X=W&&W.startupParameters;if(V&&X&&!i.oHashChanger.getHash()){K(i,V,X);}else{I(i);}}function O(i,j,V){var W,X,Y;if(i.operation==="root"){return null;}if(i.operation==="aggregation"){W=i.pattern;}else if(V){W=V;}else{W=i.contextPath;}if(!W){return"";}if(W.indexOf("/")!==0){W="/"+W;}X=j.getParameter("arguments");if(X){for(Y in X){if(Y!=="?query"){W=W.replace("{"+Y+"}",X[Y]);}}return W;}}function Q(i,j){var V,W,X;V=i.getPath().substring(1);W=V.split("(");if(W[0]){X=W[0];}if(j){V=V.replace(X,j);if(V.indexOf("/")===0){V=V.substring(1);}}return{entitySet:X,path:V};}function U(){return p;}var g=t.testableStatic(g,"routingHelpergenerateRoutingMetadataAndGetRootEntitySet");var I=t.testableStatic(I,"routingHelper_initialiseRouting");var u=t.testableStatic(u,"routingHelper_readObject");var K=t.testableStatic(K,"routingHelper_processStartupParameters");var T=t.testableStatic(T,"routingHelper_transformStartupGuidParameters");return{startupRouter:N,determinePath:O,determineNavigationPath:Q,getPatternDelimiter:U,readObjectProcessResults:v};});
