/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/gantt/library","jquery.sap.global","sap/ui/core/Control","sap/ui/model/ChangeReason","sap/base/util/values","sap/ui/layout/Splitter","./InnerGanttChart","./GanttHeader","./GanttSyncedControl","../control/AssociateContainer","../axistime/ProportionZoomStrategy","./SelectionModel","./ExpandModel","./ShapeScheme","./GanttExtension","./GanttScrollExtension","./GanttZoomExtension","./GanttPointerExtension","./GanttDragDropExtension","./GanttPopoverExtension","./GanttConnectExtension","./GanttResizeExtension","./RenderUtils","../misc/Format","../misc/Utility","../config/TimeHorizon"],function(l,q,C,a,v,S,I,G,b,A,P,c,E,d,e,f,g,h,j,k,m,n,R,F,U,T){"use strict";var o=C.extend("sap.gantt.simple.GanttChartWithTable",{metadata:{properties:{width:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},shapeSelectionMode:{type:"sap.gantt.SelectionMode",defaultValue:l.SelectionMode.MultiWithKeyboard},shapeSelectionSettings:{type:"object",defaultValue:null},enableCursorLine:{type:"boolean",defaultValue:true},enableNowLine:{type:"boolean",defaultValue:true},enableVerticalLine:{type:"boolean",defaultValue:true},enableAdhocLine:{type:"boolean",defaultValue:true},adhocLineLayer:{type:"string",defaultValue:l.AdhocLineLayer.Top},dragOrientation:{type:"sap.gantt.DragOrientation",defaultValue:l.DragOrientation.Free},ghostAlignment:{type:"string",defaultValue:l.dragdrop.GhostAlignment.None},showShapeTimeOnDrag:{type:"boolean",defaultValue:false},selectionPanelSize:{type:"sap.ui.core.CSSSize",defaultValue:"30%"}},aggregations:{table:{type:"sap.ui.table.Table",multiple:false},adhocLines:{type:"sap.gantt.AdhocLine",multiple:true,singularName:"adhocLine",bindable:"bindable",visibility:"public"},svgDefs:{type:"sap.gantt.def.SvgDefs",multiple:false,singularName:"svgDef"},shapeSchemes:{type:"sap.gantt.simple.ShapeScheme",multiple:true,singularName:"shapeScheme"},calendarDef:{type:"sap.gantt.def.cal.CalendarDefs",multiple:false,bindable:"bindable"},axisTimeStrategy:{type:"sap.gantt.axistime.AxisTimeStrategyBase",multiple:false,bindable:"bindable"},locale:{type:"sap.gantt.config.Locale",multiple:false},_splitter:{type:"sap.ui.layout.Splitter",multiple:false,visibility:"hidden"},_header:{type:"sap.gantt.simple.GanttHeader",multiple:false,defaultValue:null,visibility:"hidden"},_innerGantt:{type:"sap.gantt.simple.InnerGanttChart",multiple:false,visibility:"hidden"}},events:{shapeSelectionChange:{parameters:{shapeUids:{type:"string[]"}}},shapeResize:{parameters:{shapeUid:{type:"string"},shape:{type:"sap.gantt.shape.BaseShape"},rowObject:{type:"object"},oldTime:{type:"string[]"},newTime:{type:"string[]"}}},shapeMouseEnter:{parameters:{shape:{type:"sap.gantt.shape.BaseShape"},pageX:{type:"int"},pageY:{type:"int"}}},shapeMouseLeave:{parameters:{shape:{type:"sap.gantt.shape.BaseShape"},originEvent:{type:"object"}}},shapeDoubleClick:{parameters:{shape:{type:"sap.gantt.shape.BaseShape"},rowSettings:{type:"sap.gantt.simple.GanttRowSettings"}}},shapeContextMenu:{parameters:{shape:{type:"sap.gantt.shape.BaseShape"},rowSettings:{type:"sap.gantt.simple.GanttRowSettings"},pageX:{type:"int"},pageY:{type:"int"}}},shapeDrop:{parameters:{sourceGanttChart:{type:"sap.gantt.simple.GanttChartWithTable"},targetGanttChart:{type:"sap.gantt.simple.GanttChartWithTable"},draggedShapeDates:{type:"object"},lastDraggedShapeUid:{type:"string"},targetRow:{type:"sap.ui.table.Row"},cursorDateTime:{type:"object"},newDateTime:{type:"object"},targetShape:{type:"sap.gantt.shape.BaseShape"}}},shapeConnect:{parameters:{fromShapeUid:{type:"string"},toShapeUid:{type:"string"},type:{type:"sap.gantt.simple.RelationshipType"}}}}}});o.prototype.init=function(){this.iGanttRenderedWidth=-1;this._bExtensionsInitialized=false;this._oExpandModel=new E();this._oSplitter=new S();this.setAggregation("_splitter",this._oSplitter);this._oSplitter.attachResize(this.onSplitterResize.bind(this));this._oSyncedControl=new b();this.setAggregation("_innerGantt",new I());this.setAggregation("_header",new G());};o.prototype.getInnerGantt=function(){return this.getAggregation("_innerGantt");};o.prototype.onSplitterResize=function(i){var O=i.getParameter("oldSizes"),N=i.getParameter("newSizes"),r=O.length>0&&O[0]!==-1;if(r){var p=N[0];this.setProperty("selectionPanelSize",p+"px",true);this.fireEvent("_selectionPanelResize",{newWidth:p});this._draw(true);}};o.prototype.setLayoutData=function(L){this.setAggregation("layoutData",L,true);this.fireEvent("_layoutDataChange");return this;};o.prototype.applySettings=function(s,i){s=s||{};this._applyMissingSettings(s);C.prototype.applySettings.call(this,s,i);this._initSelectionModel(this.getProperty("shapeSelectionMode"));};o.prototype._applyMissingSettings=function(s){if(!s.axisTimeStrategy){s.axisTimeStrategy=new P();}if(!s.locale){s.locale=l.config.DEFAULT_LOCALE_CET.clone();}if(!s.shapeSchemes){s.shapeSchemes=[new d({key:"default",primary:true})];}else{var H=s.shapeSchemes.some(function(i){return i.getPrimary();});if(!H){q.sap.log.warning("you need set a ShapeSheme with primary:true");}}};o.prototype.getPrimaryShapeScheme=function(){return this.getShapeSchemes().filter(function(s){return s.getPrimary();})[0];};o.prototype.getSyncedControl=function(){return this._oSyncedControl;};o.prototype.getTableRowHeights=function(){return this.getSyncedControl().getRowHeights();};o.prototype.setTable=function(t){this.setAggregation("table",t);t._bVariableRowHeightEnabled=true;var O=this._oSplitter.removeContentArea(0);this._oSplitter.insertContentArea(new A({content:t,enableRootDiv:true}),0);if(O==null){this._oSyncedControl.syncWith(t);this._oSplitter.addContentArea(this._oSyncedControl);}else if(O&&O.getContent()!=t.getId()){this._oSyncedControl.syncWith(t);}t.detachEvent("_rowsUpdated",this._onTableRowsUpdated,this);t.attachEvent("_rowsUpdated",this._onTableRowsUpdated,this);};o.prototype.setEnableVariableRowHeight=function(i){if(this.getTable()){this.getTable()._bVariableRowHeightEnabled=i;}else{q.sap.log.warning("you need to set table aggregation first");}};o.prototype.getRenderedTimeRange=function(){return this.getAxisTime().getTimeRangeSlice(0,this.iGanttRenderedWidth);};o.prototype._initSelectionModel=function(s){if(this.oSelection){this.oSelection.detachSelectionChanged(this._onSelectionChanged,this);}this.oSelection=new c(s);this.oSelection.attachSelectionChanged(this._onSelectionChanged,this);return this;};o.prototype.setShapeSelectionMode=function(s){this.setProperty("shapeSelectionMode",s);if(this.oSelection){this.oSelection.setSelectionMode(s);}return this;};o.prototype.getSelectedShapeUid=function(){var s=this.oSelection.allUid();return s;};o.prototype._onSelectionChanged=function(i){var s=i.getParameter("shapeUid"),D=i.getParameter("deselectedUid"),p=i.getParameter("silent");this._updateShapeSelections(s,D);if(!p){this.fireShapeSelectionChange({shapeUids:s});}};o.prototype.handleShapePress=function(p){var s=p.shape,i=s.getShapeUid(),r=p.ctrlOrMeta;var N=!s.getSelected();this.oSelection.update(i,{selected:N,ctrl:r,draggable:s.getDraggable(),time:s.getTime(),endTime:s.getEndTime()});};o.prototype._updateShapeSelections=function(s,D){var i=this.getShapeSelectionMode();if(i===l.SelectionMode.None){return;}R.updateShapeSelections(this,s,D);};o.prototype.getSelection=function(){return this.oSelection;};o.prototype.getExpandedBackgroundData=function(){if(this._oExpandModel.hasExpandedRows()){var r=this.getTable().getRows();var p=r.length;var s=this.getTable().getFirstVisibleRow();var t=[];for(var i=0;i<p;i++){if(r[i].getIndex()>=s){var u=r[i].getAggregation("_settings");t.push(u.getRowUid());}}return this._oExpandModel.collectExpandedBgData(t);}};o.prototype.setAxisTimeStrategy=function(i){this.setAggregation("axisTimeStrategy",i,false);i.attachEvent("_redrawRequest",this._onRedrawRequest,this);return this;};o.prototype._onTableRowsUpdated=function(i){var r=i.getParameter("reason"),p=this.getInnerGantt();var M=v(a).slice();var s=M.concat(["Render","VerticalScroll","FirstVisibleRowChange","Resize"]);if(s.indexOf(r)!==-1){this.getSyncedControl().setAllowContentScroll(false);p.invalidate();}else{p.getRenderer().renderImmediately(this);}};o.prototype.syncVisibleHorizon=function(t,V,K){var i=this.getAxisTimeStrategy();var p=i.getTotalHorizon();var r;var s=this.getVisibleWidth();if(V!==undefined){if(s===undefined){return;}if(K){var u=i.getVisibleHorizon();var w=F.abapTimestampToDate(u.getStartTime());r=U.calculateHorizonByWidth(t,V,s,w);}else{r=U.calculateHorizonByWidth(t,V,s);}}else{r=t;}if(p.getEndTime()<r.getEndTime()){var x=F.abapTimestampToDate(r.getEndTime()).getTime()-F.abapTimestampToDate(r.getStartTime()).getTime();var y=F.abapTimestampToDate(p.getEndTime());var z=new Date();z.setTime(y.getTime()-x);r=new T({startTime:z,endTime:y});}this._updateVisibleHorizon(r,"syncVisibleHorizon",s);};o.prototype._updateVisibleHorizon=function(t,r,i){var p=this.getAxisTimeStrategy();p.updateGanttVisibleWidth(i);p.setVisibleHorizonWithReason(t,r);};o.prototype.syncMouseWheelZoom=function(i){this._getZoomExtension().performMouseWheelZooming(i.originEvent,true);};o.prototype.syncTimePeriodZoomOperation=function(i,t,O){this._getZoomExtension().syncTimePeriodZoomOperation(i,t,O);};o.prototype._onRedrawRequest=function(i){var p=i.getParameter("forceUpdate");var V=i.getParameter("valueBeforeChange");var r=i.getParameter("reasonCode");var O=i.getParameter("originEvent");if(r!=="totalHorizonUpdated"&&V){this._oLastVisibleHorizon=V;if(r!=="syncVisibleHorizon"){var s=this.getAxisTimeStrategy();var t=s.getVisibleHorizon();var u=this.getVisibleWidth();this.fireEvent("_visibleHorizonUpdate",{reasonCode:r,visibleHorizon:t,visibleWidth:u,originEvent:O});}}p=r==="initialRender"?true:p;this.redraw(p);};o.prototype.redraw=function(i){if(i){var s=this._getScrollExtension();s.clearOffsetWidth();}this._draw(i);};o.prototype._draw=function(){var s=this._getScrollExtension();var V=this.getVisibleWidth();if(!V){return;}var i=this.getAxisTimeStrategy().syncContext(V);this.fireEvent("_zoomInfoUpdated",i);if(i.axisTimeChanged){s.clearOffsetWidth();}s.needRerenderGantt(function(){this.getInnerGantt().getRenderer().renderImmediately(this);}.bind(this));};o.prototype.onBeforeRendering=function(i){this._updateRowHeightInExpandModel(this.getTable());e.detachEvents(this);};o.prototype.onAfterRendering=function(i){this._attachExtensions();e.attachEvents(this);this.jumpToVisibleHorizon("initialRender");};o.prototype._updateRowHeightInExpandModel=function(t){var i=t.getRowHeight();if(i===0){i=t._getDefaultRowHeight();}this._oExpandModel.setBaseRowHeight(i);};o.prototype.jumpToVisibleHorizon=function(r){var t=this.getAxisTimeStrategy().getVisibleHorizon();this._updateVisibleHorizon(t,r,this.getVisibleWidth());};o.prototype.exit=function(){this._detachExtensions();};o.prototype._attachExtensions=function(){if(this._bExtensionsInitialized){return;}e.enrich(this,f);e.enrich(this,g);e.enrich(this,h);e.enrich(this,j);e.enrich(this,k);e.enrich(this,m);e.enrich(this,n);this._bExtensionsInitialized=true;};o.prototype._detachExtensions=function(){e.cleanup(this);};o.prototype.getAxisTime=function(){var i=this.getAxisTimeStrategy().getAxisTime();if(!i){this.getAxisTimeStrategy().createAxisTime(this.getLocale());i=this.getAxisTimeStrategy().getAxisTime();}return i;};o.prototype.getContentWidth=function(){var i=this.getAxisTime(),r=i.getViewRange();return Math.abs(Math.ceil(r[1])-Math.ceil(r[0]));};o.prototype.getVisibleWidth=function(){return this._getScrollExtension?this._getScrollExtension().getVisibleWidth():undefined;};o.prototype.expand=function(s,r){this.toggleShapeScheme(true,s,r);};o.prototype.collapse=function(s,r){this.toggleShapeScheme(false,s,r);};o.prototype.toggleShapeScheme=function(i,s,r){var p=[];if(typeof r==="number"){p=[r];}else if(Array.isArray(r)){p=r;}if(p.length===0||!s){return;}var t=this.getShapeSchemes().filter(function(x){return x.getKey()===s;});if(t==null||t.length===0||t.length>1){return;}var u=this.getPrimaryShapeScheme();var w=this._oExpandModel.isTableRowHeightNeedChange(i,this.getTable(),p,u,t[0]);if(w){this.getTable().invalidate();}};o.prototype.isShapeVisible=function(s){if(s&&s.isVisible()){return true;}var t=this.getRenderedTimeRange(),M=t[0],i=t[1];var p=s.getTime(),r=s.getEndTime();var u=function(w){return(w>=M&&w<=i);};if(s.getSelected()||!p||!r){return true;}else if(p&&r){return u(p)||u(r)||(p<=M&&r>=i);}else if(p&&!r){return u(p);}else if(!p&&r){return u(r);}};o.prototype.doBirdEye=function(r){var z=this._getZoomExtension();z.doBirdEye(r);};return o;},true);
