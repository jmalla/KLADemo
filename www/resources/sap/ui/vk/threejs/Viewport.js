/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../library","../ViewportBase","sap/ui/core/ResizeHandler","../Loco","./thirdparty/three","../ContentConnector","../ViewStateManager","./ViewportGestureHandler","./OrthographicCamera","./PerspectiveCamera","./NodesTransitionHelper","../Messages","sap/ui/base/ManagedObjectObserver","./ViewportRenderer"],function(q,l,V,R,L,a,C,b,c,O,P,N,M,d,e){"use strict";var f=V.extend("sap.ui.vk.threejs.Viewport",{metadata:{library:"sap.ui.vk",properties:{renderMode:{type:"sap.ui.vk.RenderMode",defaultValue:sap.ui.vk.RenderMode.Default}},events:{cameraChanged:{parameters:{position:"float[]",quaternion:"float[]",zoom:"float"},enableEventBubbling:true}}}});var g=f.getMetadata().getParent().getClass().prototype;f.prototype.init=function(){if(g.init){g.init.call(this);}this._resizeListenerId=null;this._renderLoopRequestId=0;this._renderLoopFunction=this._renderLoop.bind(this);this._shouldRenderFrame=true;this._clippingPlanes=[];this._renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});this._renderer.setPixelRatio(window.devicePixelRatio);this._renderer.setSize(1,1);this._renderer.shadowMap.enabled=true;this._camera=new sap.ui.vk.threejs.PerspectiveCamera();var h=["varying float vPos;","void main() {","	gl_Position = vec4(position, 1.0);","	vPos = position.y * -0.5 + 0.5;","}"].join("\n");var i=["uniform vec4 topColor;","uniform vec4 bottomColor;","varying float vPos;","void main() {","	gl_FragColor = mix(topColor, bottomColor, vPos);","}"].join("\n");var j=new THREE.Vector4();var k=new THREE.Vector4();this._updateColor(j,this.getBackgroundColorTop());this._updateColor(k,this.getBackgroundColorBottom());this._checkBackgroundColor();this._backgroundMaterial=new THREE.ShaderMaterial({uniforms:{topColor:{value:j},bottomColor:{value:k}},vertexShader:h,fragmentShader:i,side:THREE.DoubleSide,depthTest:false,depthWrite:false,blending:THREE.NoBlending});var m=new THREE.Geometry();m.vertices.push(new THREE.Vector3(-1,1,0),new THREE.Vector3(1,1,0),new THREE.Vector3(-1,-1,0),new THREE.Vector3(1,-1,0));m.faces.push(new THREE.Face3(0,2,1),new THREE.Face3(1,2,3));this._backgroundCamera=new THREE.Camera();this._backgroundScene=new THREE.Scene();this._backgroundScene.add(new THREE.Mesh(m,this._backgroundMaterial));var x=["#include <clipping_planes_pars_vertex>","varying vec3 vNormal;","void main() {","#include <begin_vertex>","#include <project_vertex>","#include <clipping_planes_vertex>","#include <beginnormal_vertex>","#include <defaultnormal_vertex>","	vNormal = normalize( transformedNormal );","}"].join("\n");var n=["#include <clipping_planes_pars_fragment>","uniform vec4 color1;","uniform vec4 color2;","varying vec3 vNormal;","void main() {","#include <clipping_planes_fragment>","	gl_FragColor = mix(color1, color2, abs(normalize(vNormal).z));","}"].join("\n");this._xrayColor1=new THREE.Vector4(0,0.75,1,0.45);this._xrayColor2=new THREE.Vector4(0,0,1,0);this._xrayMaterial=new THREE.ShaderMaterial({uniforms:{color1:{value:this._xrayColor1},color2:{value:this._xrayColor2}},vertexShader:x,fragmentShader:n,side:THREE.DoubleSide,depthWrite:false,depthFunc:THREE.LessDepth,blending:THREE.NormalBlending,clipping:true,transparent:true});this._viewportGestureHandler=new c(this);this._loco=new L();this._loco.addHandler(this._viewportGestureHandler);this._zoomedObject=null;this._nodesTransitionHelper=new N();this._nodesTransitionHelper.setViewport(this);this._cdsLoader=null;this.attachCameraChanged(function(s){this.setShouldRenderFrame();});this._sceneObserver=new d(this.setShouldRenderFrame.bind(this));};f.prototype.exit=function(){this._loco.removeHandler(this._viewportGestureHandler);this._viewportGestureHandler.destroy();if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this._stopRenderLoop();this.setScene(null);this.setCamera(null);this._renderer=null;this._backgroundCamera=null;this._backgroundMaterial=null;this._backgroundScene=null;this._loco=null;this._viewportGestureHandler=null;if(this._cdsLoader){this._cdsLoader.detachSceneUpdated(this._handleCdsSceneUpdate,this);}if(g.exit){g.exit.call(this);}};f.prototype._startRenderLoop=function(){if(!this._renderLoopRequestId){this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);}return this;};f.prototype._stopRenderLoop=function(){if(this._renderLoopRequestId){window.cancelAnimationFrame(this._renderLoopRequestId);this._renderLoopRequestId=0;}return this;};f.prototype.setBackgroundColorTop=function(v){g.setBackgroundColorTop.call(this,v);if(this._backgroundMaterial!==null){this._updateColor(this._backgroundMaterial.uniforms.topColor.value,v);this._checkBackgroundColor();}return this;};f.prototype.setBackgroundColorBottom=function(v){g.setBackgroundColorBottom.call(this,v);if(this._backgroundMaterial!==null){this._updateColor(this._backgroundMaterial.uniforms.bottomColor.value,v);this._checkBackgroundColor();}return this;};f.prototype.setClippingPlanes=function(h){this._clippingPlanes=h;return this;};f.prototype.onBeforeRendering=function(){if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this._stopRenderLoop();};f.prototype.onAfterRendering=function(){var h=this.getDomRef();h.appendChild(this._renderer.domElement);this._resizeListenerId=R.register(this,this._handleResize.bind(this));this._handleResize({size:{width:h.clientWidth,height:h.clientHeight}});this._startRenderLoop();};f.prototype._handleResize=function(h){if(!this._camera||!this._renderer){return false;}var w=h.size.width;var i=h.size.height;if(this._camera){this._camera.update(w,i);}this._renderer.setSize(w,i);this.fireResize({size:{width:w,height:i}});this.setShouldRenderFrame();return true;};f.prototype.setScene=function(s){this._scene=s;this._homeCamera=null;this._sceneObserver.disconnect();var n=this._scene?this._scene.getSceneRef():undefined;if(n){this._sceneObserver.observe(this._scene,{properties:["doubleSided"]});var h;for(var i=0;i<n.children.length;i++){h=n.children[i];if(h.private&&h.name==="DefaultLights"&&h.children.length){if(h.children[0]instanceof THREE.PointLight){this._eyePointLight=h.children[0];}}}}this.setShouldRenderFrame();return this;};f.prototype.getScene=function(){return this._scene;};f.prototype.setCamera=function(h){if(g.setCamera){g.setCamera.call(this,h);}var i=this.getCamera();if(i&&this._renderer){var s=this._renderer.getSize();i.update(s.width,s.height);if(!this._homeCamera&&i.getCameraRef()){this._homeCamera=i.getCameraRef().clone();}}this.setShouldRenderFrame();return this;};f.prototype.getRenderer=function(){return this._renderer;};f.prototype._getViewStateManagerThreeJS=function(){if(this._viewStateManager){if(this._viewStateManager.constructor===sap.ui.vk.threejs.ViewStateManager){return this._viewStateManager;}if(this._viewStateManager.constructor===sap.ui.vk.ViewStateManager&&this._viewStateManager._implementation.constructor===sap.ui.vk.threejs.ViewStateManager){return this._viewStateManager._implementation;}}return null;};f.prototype._updateBoundingBoxesIfNeeded=function(){var v=this._getViewStateManagerThreeJS();if(v){v._updateBoundingBoxesIfNeeded();}};f.prototype._updateColor=function(h,i){var j=sap.ui.vk.cssColorToColor(i);h.color=new THREE.Color(j.red/255,j.green/255,j.blue/255);h.alpha=j.alpha;h.x=h.color.r*h.alpha;h.y=h.color.g*h.alpha;h.z=h.color.b*h.alpha;h.w=h.alpha;};f.prototype._checkBackgroundColor=function(){var h=this.getBackgroundColorTop();if(h===this.getBackgroundColorBottom()){if(this._backgroundColor===null){this._backgroundColor=new THREE.Vector4();}this._updateColor(this._backgroundColor,h);}else{this._backgroundColor=null;}this.setShouldRenderFrame();};f.prototype._handleCdsSceneUpdate=function(){this.setShouldRenderFrame();};f.prototype.setShouldRenderFrame=function(){this._shouldRenderFrame=true;return this;};f.prototype.shouldRenderFrame=function(){return this._shouldRenderFrame;};f.prototype.setRenderMode=function(h){this.setProperty("renderMode",h,true);this.setShouldRenderFrame();};f.prototype.hitTest=function(x,y){var n=this._scene?this._scene.getSceneRef():undefined;var h=this._camera?this._camera.getCameraRef():undefined;if(!h||!n){return null;}var j=this._renderer.domElement;var m=new THREE.Vector2((x-j.clientLeft)/j.clientWidth*2-1,(j.clientTop-y)/j.clientHeight*2+1);var k=new THREE.Raycaster();k.setFromCamera(m,h);if(this._clippingPlanes){for(var i in this._clippingPlanes){var s=this._clippingPlanes[i];var u=s.distanceToPoint(k.ray.origin),t=-u/s.normal.dot(k.ray.direction);if(t>0){if(u<0){k.near=Math.max(k.near,t);}else{k.far=Math.min(k.far,t);}}else if(u<0){return null;}}}var v=k.intersectObjects(n.children,true);if(v&&v.length){var w=v[0];if(!w.object.name&&w.object.children.length===0){w.object=w.object.parent;}return w;}return null;};f.prototype.tap=function(x,y,i){if(!i){if(this._viewStateManager){var h=this.hitTest(x,y);var n=h&&h.object;var j={picked:n?[n]:[]};this.fireNodesPicked(j);if(this.getSelectionMode()===sap.ui.vk.SelectionMode.Exclusive){this.exclusiveSelectionHandler(j.picked);}else if(this.getSelectionMode()===sap.ui.vk.SelectionMode.Sticky){this.stickySelectionHandler(j.picked);}if(n!==null){this.fireNodeClicked({nodeRef:n,x:x,y:y},true,true);}}}else if(!this.getFreezeCamera()){var k=this.hitTest(x,y);if(k&&(this._zoomedObject===null||this._zoomedObject!==k.object)){this._zoomedObject=k.object;this._viewportGestureHandler.zoomObject(this._zoomedObject,true);}else{this._viewportGestureHandler.zoomObject(this._zoomedObject,false);this._zoomedObject=null;}}return this;};var o={x:-2,y:-2};var r=2;var p=5;[{key:"left",dx:-r,dy:0},{key:"right",dx:+r,dy:0},{key:"up",dx:0,dy:-r},{key:"down",dx:0,dy:+r}].forEach(function(i){f.prototype["onsap"+i.key]=function(h){var j=this._viewportGestureHandler._cameraController;j.beginGesture(o.x,o.y);j.rotate(i.dx,i.dy,true);j.endGesture();this.setShouldRenderFrame();h.preventDefault();h.stopPropagation();};});[{key:"left",dx:-p,dy:0},{key:"right",dx:+p,dy:0},{key:"up",dx:0,dy:-p},{key:"down",dx:0,dy:+p}].forEach(function(i){f.prototype["onsap"+i.key+"modifiers"]=function(h){if(h.shiftKey&&!(h.ctrlKey||h.altKey||h.metaKey)){var j=this._viewportGestureHandler._cameraController;j.beginGesture(o.x,o.y);j.pan(i.dx,i.dy);j.endGesture();this.setShouldRenderFrame();h.preventDefault();h.stopPropagation();}};});[{key:"minus",d:0.98},{key:"plus",d:1.02}].forEach(function(i){f.prototype["onsap"+i.key]=function(h){var j=this._viewportGestureHandler._cameraController;j.beginGesture(this.$().width()/2,this.$().height()/2);j.zoom(i.d);j.endGesture();this.setShouldRenderFrame();h.preventDefault();h.stopPropagation();};});f.prototype._handleVisibilityChanged=f.prototype._handleOpacityChanged=f.prototype._handleTintColorChanged=f.prototype._handleHighlightColorChanged=function(h){this.setShouldRenderFrame();};f.prototype._handleSelectionChanged=function(h){var t=this.getTools();for(var i=0;i<t.length;i++){var j=sap.ui.getCore().byId(t[i]);var k=j.getGizmoForContainer(this);if(k&&k.handleSelectionChanged){k.handleSelectionChanged(h);}}this.setShouldRenderFrame();};f.prototype.setSelectionRect=function(h){this.setShouldRenderFrame();if(!h){this._selectionRect=null;return;}var s=this._renderer.getSize();var x=(h.x1/s.width)*2-1,y=(h.y1/s.height)*-2+1,i=(h.x2/s.width)*2-1,j=(h.y2/s.height)*-2+1;if(!this._selectionRect){var k=new THREE.Geometry();k.vertices.push(new THREE.Vector3(x,j,-1),new THREE.Vector3(i,j,-1),new THREE.Vector3(i,y,-1),new THREE.Vector3(x,y,-1));this._selectionRect=new THREE.LineLoop(k,new THREE.LineBasicMaterial({color:0xFFFF00,linewidth:window.devicePixelRatio}));}else{var v=this._selectionRect.geometry.vertices;v[0].set(x,j,-1);v[1].set(i,j,-1);v[2].set(i,y,-1);v[3].set(x,y,-1);this._selectionRect.geometry.verticesNeedUpdate=true;}};f.prototype._renderLoop=function(){if(!this._renderer||!this.getDomRef()){this._renderLoopRequestId=0;return;}if(this._viewportGestureHandler){this._viewportGestureHandler.animateCameraUpdate();}if(this._nodesTransitionHelper){this._nodesTransitionHelper.displayNodesMoving();}var n=this.getCamera()?this.getCamera().getCameraRef():undefined;if(this._eyePointLight&&n){this._eyePointLight.position.copy(n.position);}if(this._shouldRenderFrame){this._shouldRenderFrame=false;this.render();}this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);};f.prototype._updateDynamicObjects=function(h,n,i,j){var k=false;i.children.forEach(function(m){if(m.userData._vkDetailViews&&m.userData._vkDetailViews.length>0){k=true;}});function s(v){i.children.forEach(function(m){if(m.userData._vkBillboards){m.userData._vkBillboards.forEach(function(t){t._node.visible=v;});}if(m.userData._vkDetailViews){m.userData._vkDetailViews.forEach(function(t){t._node.visible=v;});}});}if(k){j=j||this._scene._computeBoundingBox();s(false);i.children.forEach(function(m){if(m.userData._vkDetailViews){m.userData._vkDetailViews.forEach(function(t){t._update(h,n,i,j);});}});s(true);}i.children.forEach(function(m){if(m.userData._vkCallouts){m.userData._vkCallouts.forEach(function(t){t._update(h,n);});}if(m.userData._vkBillboards){m.userData._vkBillboards.forEach(function(t){t._update(h,n);});}});};f.prototype.render=function(){var h=this._renderer;if(!h){return;}var n=this._scene?this._scene.getSceneRef():null;var j=this._camera?this._camera.getCameraRef():null;if(!n||!j){return;}var t=this.getTools();var i,k,m,s;if(this._camera.getUsingDefaultClipPlanes()||(j.isOrthographicCamera&&this._camera.getZoomNeedRecalculate())){s=this._scene._computeBoundingBox();if(!s.isEmpty()){if(j.isOrthographicCamera&&this._camera.getZoomNeedRecalculate()){this._camera.adjustZoom(s);}if(this._camera.getUsingDefaultClipPlanes()){for(i=0;i<t.length;i++){k=sap.ui.getCore().byId(t[i]);m=k.getGizmoForContainer(this);if(m&&m.expandBoundingBox){m.expandBoundingBox(s);}}this._camera.adjustClipPlanes(s);}}}this._updateDynamicObjects(h,j,n,s);h.autoClear=this._backgroundColor!=null;if(h.autoClear){h.setClearColor(this._backgroundColor.color,this._backgroundColor.alpha);}else{h.render(this._backgroundScene,this._backgroundCamera);}var v=this._getViewStateManagerThreeJS();h.clippingPlanes=this._clippingPlanes;if(this.getRenderMode()===sap.ui.vk.RenderMode.XRay){if(v){var u=n.children[n.children.length-1].clone();v._selectedNodes.forEach(function(x){if(x.visible){x.add(u);h.render(x,j);h.autoClear=false;x.remove(u);}});}this._xrayColor1.w=0.45;n.overrideMaterial=this._xrayMaterial;}h.render(n,j);h.autoClear=false;h.clippingPlanes=[];n.overrideMaterial=null;if(v){var w=v._boundingBoxesScene;if(w){h.render(w,j);}}for(i=0;i<t.length;i++){k=sap.ui.getCore().byId(t[i]);m=k.getGizmoForContainer(this);if(m&&m.render){m.render(this);}}if(this._selectionRect){h.render(this._selectionRect,this._backgroundCamera);}};f.prototype.getImage=function(i,j,t,k,m){if(this._scene===null){return null;}i=i||16;j=j||16;if(i>2048){i=2048;}if(j>2048){j=2048;}var n=new THREE.WebGLRenderer({preserveDrawingBuffer:true});n.setSize(i,j);var s=this.getBackgroundColorTop();var u=this.getBackgroundColorBottom();if(t&&!k){n.setClearColor(t,1);}else if(!t&&k){n.setClearColor(k,1);}else{if(t&&k){this.setBackgroundColorTop(t);this.setBackgroundColorBottom(k);}n.render(this._backgroundScene,this._backgroundCamera);n.autoClear=false;}document.body.appendChild(n.domElement);var v=this.getCamera().getCameraRef().clone();var x=i/j;if(v.isOrthographicCamera){var w=v.right-v.left;var h=v.top-v.bottom;if(w>h){v.top=w/x/2;v.bottom=-w/x/2;}else{v.left=-h*x/2;v.right=h*x/2;}}else{var y=2*Math.atan(v.aspect*Math.tan(v.fov*Math.PI/360));if(v.fov<y*180/Math.PI){v.fov=360*Math.atan(Math.tan(y*0.5)/x)/Math.PI;}v.aspect=x;}v.updateProjectionMatrix();var z=[];var A=this._getViewStateManagerThreeJS();if(!m){if(A!==null){A.enumerateSelection(function(D){z.push(D);});A.setSelectionState(z,false,false);}}n.render(this._scene.getSceneRef(),v);var B=n.getContext().canvas.toDataURL();if(A!==null&&z.length>0){A.setSelectionState(z,true,false);}n.forceContextLoss();document.body.removeChild(n.domElement);if(u&&t){this.setBackgroundColorBottom(u);}if(s&&k){this.setBackgroundColorTop(s);}return B;};f.prototype._setContent=function(h){var s;var j;if(h){s=h;if(!(s instanceof sap.ui.vk.threejs.Scene)){s=null;}j=h.camera;if(!(j instanceof sap.ui.vk.threejs.OrthographicCamera||j instanceof sap.ui.vk.threejs.PerspectiveCamera)){j=null;}if(j instanceof sap.ui.vk.threejs.OrthographicCamera){var k=new THREE.Box3().setFromObject(s.getSceneRef());var m=k.getCenter();var n=j.getTargetDirection();var t=j.getPosition();var u=[m.x-t[0],m.y-t[1],m.z-t[2]];var v=u[0]*n[0]+u[1]*n[1]+u[2]*n[2];if(v<0){var w=k.getSize().length()/2;w-=v;t[0]-=n[0]*w;t[1]-=n[1]*w;t[2]-=n[2]*w;j.setPosition(t);}}if(h.loaders){for(var i=0;i<h.loaders.length;i++){if(h.loaders[i]instanceof sap.ui.vk.threejs.ContentDeliveryService){this._cdsLoader=h.loaders[i];this._cdsLoader.attachSceneUpdated(this._handleCdsSceneUpdate,this);break;}}}}this.setScene(s);if(j){this.setCamera(j);}};f.prototype._onAfterUpdateContentConnector=function(){this._setContent(this._contentConnector.getContent());};f.prototype._onBeforeClearContentConnector=function(){if(g._onBeforeClearContentConnector){g._onBeforeClearContentConnector.call(this);}this.setScene(null);};f.prototype._handleContentReplaced=function(h){var i=h.getParameter("newContent");this._setContent(i);};f.prototype._onAfterUpdateViewStateManager=function(){};f.prototype._onBeforeClearViewStateManager=function(){};C.injectMethodsIntoClass(f);b.injectMethodsIntoClass(f);f.prototype.activateView=function(v){var h=v.getCameraInfo();var n;if(h){if(h.type==="PerspectiveCamera"){n=new sap.ui.vk.threejs.PerspectiveCamera();n.setFov(h.fov);n.setPosition(h.position);}if(h.type==="OrthographicCamera"){n=new sap.ui.vk.threejs.OrthographicCamera();n.setZoomFactor(h.zoomFactor);if(h.zoomNeedRecalculate){n.setZoomNeedRecalculate(true);}var i=h.position;var s=this.getScene();if(s){var j=new THREE.Box3().setFromObject(this.getScene().getSceneRef());var k=j.getCenter();var m=h.targetDirection;var t=[k.x-i[0],k.y-i[1],k.z-i[2]];var u=t[0]*m[0]+t[1]*m[1]+t[2]*m[2];if(u<0){var w=j.getSize().length()/2;w-=u;i[0]-=m[0]*w;i[1]-=m[1]*w;i[2]-=m[2]*w;}}n.setPosition(i);}n.setNearClipPlane(h.nearClipPlane);n.setFarClipPlane(h.farClipPlane);n.setUpDirection(h.upDirection);n.setTargetDirection(h.targetDirection);n.setUsingDefaultClipPlanes(h.usingDefaultClipPlanes);this._viewportGestureHandler.prepareForCameraUpdateAnimation(h.type);this.setCamera(n);this._viewportGestureHandler.startAnimatingCameraUpdate(500);}function x(T){return new THREE.Matrix4().set(T[0],T[1],T[2],T[3],T[4],T[5],T[6],T[7],T[8],T[9],T[10],T[11],0,0,0,1);}var y=this._viewStateManager.getNodeHierarchy();var z=v.getNodeInfos();if(z){this._nodesTransitionHelper.clear();z.forEach(function(S){if(S.target===null){return;}function T(X,Y,Z){for(var $=0;$<X.elements.length;$++){if(Math.abs(X.elements[$]-Y.elements[$])>Z){return false;}}return true;}if(S.transform){var U=x(S.transform);if(!T(U,S.target.matrix,1e-6)){var W=y.createNodeProxy(S.target);this._nodesTransitionHelper.setNodeForDisplay(W);U.decompose(S.target.position,S.target.quaternion,S.target.scale);S.target.updateMatrix();}}}.bind(this));var A=[];var B=[];for(var D=0;D<z.length;D++){if(z[D].visible){A.push(z[D].target);}else{B.push(z[D].target);}}this._viewStateManager.setVisibilityState(A,true,false);this._viewStateManager.setVisibilityState(B,false,false);var E=new Set(A);var F=[];var G=y.getSceneRef();var H=this;G.traverse(function collectChildNodes(S){if(S.parent&&H._viewStateManager.getVisibilityState(S.parent)===false){return;}if(H._viewStateManager.getVisibilityState(S)){if(S.userData&&S.userData.treeNode){F.push(S);}}});var I=[];for(var J=0;J<F.length;J++){if(!E.has(F[J])){var K=true;var Q=0;var S=F[J];while(S&&Q<4){if(S.parent&&S.parent.userData&&S.parent.userData.treeNode){K=false;break;}else{S=S.parent;Q++;}}if(!K){I.push(F[J]);}}}this._viewStateManager.setVisibilityState(I,false,false);this._nodesTransitionHelper.startDisplay(500);}return this;};f.prototype.zoomTo=function(w,n,h,m){var i=this._scene?this._scene.getSceneRef():null;var j=this._camera?this._camera.getCameraRef():null;if(!j||!i){return this;}m=m||0;var k=new THREE.Box3();var s=null;var t=null;(Array.isArray(w)?w:[w]).forEach(function(w){switch(w){case sap.ui.vk.ZoomTo.All:i._expandBoundingBox(k,false);break;case sap.ui.vk.ZoomTo.Visible:i._expandBoundingBox(k,true);break;case sap.ui.vk.ZoomTo.Selected:var v=this._getViewStateManagerThreeJS();if(v){v.enumerateSelection(function(n){n._expandBoundingBox(k,false);});}break;case sap.ui.vk.ZoomTo.Node:if(!n){return this;}t=n;if(Array.isArray(n)){n.forEach(function(n){n._expandBoundingBox(k,false);});}else{n._expandBoundingBox(k,false);}break;case sap.ui.vk.ZoomTo.Restore:q.sap.log.error("sap.ui.vk.ZoomTo.Restore is not implemented");return this;case sap.ui.vk.ZoomTo.NodeSetIsolation:q.sap.log.error("sap.ui.vk.ZoomTo.NodeSetIsolation is not implemented");return this;case sap.ui.vk.ZoomTo.RestoreRemoveIsolation:q.sap.log.error("sap.ui.vk.ZoomTo.RestoreRemoveIsolation is not implemented");return this;case sap.ui.vk.ZoomTo.ViewLeft:s=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),-Math.PI/2);break;case sap.ui.vk.ZoomTo.ViewRight:s=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI/2);break;case sap.ui.vk.ZoomTo.ViewTop:s=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),-Math.PI/2);break;case sap.ui.vk.ZoomTo.ViewBottom:s=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),Math.PI/2);break;case sap.ui.vk.ZoomTo.ViewBack:s=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI);break;case sap.ui.vk.ZoomTo.ViewFront:s=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),0);break;default:break;}}.bind(this));if(!k.isEmpty()){this._viewportGestureHandler.zoomTo(k,s,m,h*1000,t,t!==null);}return this;};f.prototype.getViewInfo=function(h){var v={};if(h==null){h={};}if(h.camera==null){h.camera=true;}var n=this._camera?this._camera.getCameraRef():null;if(h.camera&&n){var i=n.rotation.clone();i.reorder("YXZ");v.camera={rotation:{yaw:THREE.Math.radToDeg(i.y),pitch:THREE.Math.radToDeg(i.x),roll:THREE.Math.radToDeg(i.z)},position:{x:n.position.x,y:n.position.y,z:n.position.z},projectionType:n.isOrthographicCamera?sap.ui.vk.CameraProjectionType.Orthographic:sap.ui.vk.CameraProjectionType.Perspective,bindingType:sap.ui.vk.CameraFOVBindingType.Vertical};if(v.camera.projectionType===sap.ui.vk.CameraProjectionType.Perspective){v.camera.fieldOfView=n.fov;}else if(v.camera.projectionType===sap.ui.vk.CameraProjectionType.Orthographic){v.camera.zoomFactor=n.zoom;}if(h.camera.matrices){v.camera.matrices={view:n.matrixWorldInverse.elements.slice(),projection:n.projectionMatrix.elements.slice()};}}if(h.visibility&&this._viewStateManager){var j=h.visibility.mode==null?sap.ui.vk.VisibilityMode.Complete:h.visibility.mode;v.visibility={mode:j};if(j===sap.ui.vk.VisibilityMode.Complete){var k=this._viewStateManager.getVisibilityComplete();v.visibility.visible=k.visible;v.visibility.hidden=k.hidden;}else if(this._viewStateManager.getShouldTrackVisibilityChanges()){v.visibility.changes=this._viewStateManager.getVisibilityChanges();}else{v.visibility.changes=null;q.sap.log.warning(sap.ui.vk.getResourceBundle().getText(M.VIT32.summary),M.VIT32.code,"sap.ui.vk.dvl.Viewport");}}return v;};f.prototype.setViewInfo=function(v,h){var n=this._camera?this._camera.getCameraRef():null;if(v.camera&&n){var i=v.camera;var j=i.projectionType===sap.ui.vk.CameraProjectionType.Orthographic?new THREE.OrthographicCamera():new THREE.PerspectiveCamera();j.userData=n.userData;j.aspect=n.aspect;j.position.copy(i.position);var k=i.rotation;j.quaternion.setFromEuler(new THREE.Euler(THREE.Math.degToRad(k.pitch),THREE.Math.degToRad(k.yaw),THREE.Math.degToRad(k.roll),"YXZ"));j.fov=i.fieldOfView||j.fov;j.zoom=i.zoomFactor||j.zoom;this._viewportGestureHandler._activateCamera(j,(h||0)*1000);}if(v.visibility){var m=this._viewStateManager.getNodeHierarchy(),s=new Map(),t=m.findNodesByName();t.forEach(function(x){var y=m.createNodeProxy(x);var z=y.getVeId();m.destroyNodeProxy(y);if(z){s.set(z,x);}});switch(v.visibility.mode){case sap.ui.vk.VisibilityMode.Complete:var u=v.visibility.visible,w=v.visibility.hidden;u.forEach(function(x){this._viewStateManager.setVisibilityState(s.get(x),true,false);},this);w.forEach(function(x){this._viewStateManager.setVisibilityState(s.get(x),false,false);},this);break;case sap.ui.vk.VisibilityMode.Differences:v.visibility.changes.forEach(function(x){var y=s.get(x);if(y){this._viewStateManager.setVisibilityState(y,!this._viewStateManager.getVisibilityState(y),false);}},this);break;default:q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT28.summary),M.VIT28.code,"sap.ui.vk.dvl.Viewport");break;}}return this;};f.prototype.queueCommand=function(h){if(this instanceof sap.ui.vk.threejs.Viewport){h();}return this;};f.prototype.getOutputSize=function(){var h=this.getDomRef().getBoundingClientRect();var v=h.width;var i=h.height;var j;j=Math.min(v,i);return{left:(v-j)/2,top:(i-j)/2,sideLength:j};};return f;});
