/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log"],function(L){"use strict";var S=function(b,e,r,i){this._id=S._nextId++;S.add(this);this._parentNode=b;this._contentResource=e;this._resolve=r;this._reject=i;this._nodes=new Map();this._meshes=new Map();this._callouts=new Map();this._cameras=new Map();this._detailViews=new Map();this._materials=new Map();this._images=new Map();};S._nextId=1;S._map=new Map();S.add=function(s){this._map.set(s.getId(),s);return this;};S.getById=function(i){return this._map.get(i);};S.prototype.getId=function(){return this._id;};S.prototype.setScene=function(i){if(i.result!==1){this._reject(i.result);}else{var b=this._cameras.get(i.cameraRef);this._resolve({node:this._parentNode,camera:b,contentResource:this._contentResource});}};S.prototype.createNode=function(i){var b=this._nodes.get(i.parentRef)||null;var e=new THREE.Group();e.name=i.name;e.visible=i.visible;e.matrix.set(i.matrix[0],i.matrix[4],i.matrix[8],i.matrix[12],i.matrix[1],i.matrix[5],i.matrix[9],i.matrix[13],i.matrix[2],i.matrix[6],i.matrix[10],i.matrix[14],i.matrix[3],i.matrix[7],i.matrix[11],i.matrix[15]);e.matrix.decompose(e.position,e.quaternion,e.scale);e.userData.metadata=i.metadata;e.userData.veids=i.veids;(b||this._parentNode).add(e);this._nodes.set(i.nodeRef,e);};var n=new Float32Array([0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0]);var a=new Uint16Array([0,1,2,2,1,3,4,6,5,5,6,7,8+0,8+1,8+2,8+2,8+1,8+3,8+4,8+6,8+5,8+5,8+6,8+7,16+0,16+1,16+2,16+2,16+1,16+3,16+4,16+6,16+5,16+5,16+6,16+7]);S.prototype.createMesh=function(i){var b=i.boundingBox;var v=new Float32Array([b[0],b[1],b[5],b[3],b[1],b[5],b[0],b[4],b[5],b[3],b[4],b[5],b[0],b[1],b[2],b[3],b[1],b[2],b[0],b[4],b[2],b[3],b[4],b[2],b[0],b[4],b[5],b[3],b[4],b[5],b[0],b[4],b[2],b[3],b[4],b[2],b[0],b[1],b[5],b[3],b[1],b[5],b[0],b[1],b[2],b[3],b[1],b[2],b[3],b[1],b[5],b[3],b[1],b[2],b[3],b[4],b[5],b[3],b[4],b[2],b[0],b[1],b[5],b[0],b[1],b[2],b[0],b[4],b[5],b[0],b[4],b[2]]);var e=new THREE.BufferGeometry();e.setIndex(new THREE.BufferAttribute(a,1));e.addAttribute("position",new THREE.BufferAttribute(v,3));e.addAttribute("normal",new THREE.BufferAttribute(n,3));var r=new THREE.Mesh(e,this._materials.get(i.materialRef));this._meshes.set(i.meshRef,r);if(i.matrix){r.matrix.set(i.matrix[0],i.matrix[4],i.matrix[8],i.matrix[12],i.matrix[1],i.matrix[5],i.matrix[9],i.matrix[13],i.matrix[2],i.matrix[6],i.matrix[10],i.matrix[14],i.matrix[3],i.matrix[7],i.matrix[11],i.matrix[15]);r.matrix.decompose(r.position,r.quaternion,r.scale);}};S.prototype.setMeshGeometry=function(i){var b=this._meshes.get(i.meshRef);var e=i.data;var r=new THREE.BufferGeometry();r.setIndex(new THREE.BufferAttribute(e.index,1));r.addAttribute("position",new THREE.BufferAttribute(e.position,3));if(e.normal){r.addAttribute("normal",new THREE.BufferAttribute(e.normal,3));}if(e.uv){r.addAttribute("uv",new THREE.BufferAttribute(e.uv,2));}b.geometry.copy(r);};S.prototype.insertMesh=function(b,e){var i=this._nodes.get(b);var r=this._meshes.get(e);i.add(r.parent?r.clone():r);};var c=[sap.ui.vk.BillboardTextEncoding.PlainText,sap.ui.vk.BillboardTextEncoding.HtmlText];var d=[sap.ui.vk.BillboardStyle.RectangularShape,sap.ui.vk.BillboardStyle.CircularShape,sap.ui.vk.BillboardStyle.None,sap.ui.vk.BillboardStyle.TextGlow];var f=[sap.ui.vk.BillboardBorderLineStyle.None,sap.ui.vk.BillboardBorderLineStyle.Solid,sap.ui.vk.BillboardBorderLineStyle.Dash,sap.ui.vk.BillboardBorderLineStyle.Dot,sap.ui.vk.BillboardBorderLineStyle.DashDot,sap.ui.vk.BillboardBorderLineStyle.DashDotDot];var g=[sap.ui.vk.BillboardHorizontalAlignment.Left,sap.ui.vk.BillboardHorizontalAlignment.Center,sap.ui.vk.BillboardHorizontalAlignment.Right];var l=[sap.ui.vk.LeaderLineMarkStyle.None,sap.ui.vk.LeaderLineMarkStyle.Point,sap.ui.vk.LeaderLineMarkStyle.Arrow];function h(b){var e=b.toString(16);return"#"+"000000".substring(e.length)+e;}S.prototype.createTextAnnotation=function(i){var b=new sap.ui.vk.threejs.Billboard({coordinateSpace:sap.ui.vk.BillboardCoordinateSpace.Screen,renderOrder:3,position:new THREE.Vector3().fromArray(i.position),encoding:c[i.encoding],text:i.text,font:i.font,fontSize:i.fontSize,fontWeight:Math.min(i.fontWeight,900),fontItalic:i.fontItalic,style:d[i.style],width:i.width,height:i.height,textColor:h(i.textColor),backgroundColor:h(i.backgroundColor),backgroundOpacity:i.backgroundOpacity,borderColor:h(i.borderColor),borderOpacity:i.borderOpacity,borderWidth:i.borderWidth,borderLineStyle:f[i.borderLineStyle],horizontalAlignment:g[i.horizontalAlignment],link:i.link});var e=this._nodes.get(i.nodeRef);(e||this._parentNode).add(b._node);if(!this._parentNode.userData._vkBillboards){this._parentNode.userData._vkBillboards=[];}this._parentNode.userData._vkBillboards.push(b);};S.prototype.createImageNote=function(i){var b=this._materials.get(i.materialRef);var e=new sap.ui.vk.threejs.Billboard({coordinateSpace:sap.ui.vk.BillboardCoordinateSpace.Viewport,renderOrder:2,position:new THREE.Vector3().fromArray(i.position),width:i.width,height:i.height,texture:b?b.emissiveMap:null});var r=this._nodes.get(i.nodeRef);(r||this._parentNode).add(e._node);if(!this._parentNode.userData._vkBillboards){this._parentNode.userData._vkBillboards=[];}this._parentNode.userData._vkBillboards.push(e);};S.prototype.createTextNote=function(i){var b=new sap.ui.vk.threejs.Callout({anchorNode:this._nodes.get(i.targetNodeRef)||this._parentNode,coordinateSpace:sap.ui.vk.BillboardCoordinateSpace.World,position:new THREE.Vector3().fromArray(i.position),renderOrder:i.alwaysOnTop?1:0,depthTest:!i.alwaysOnTop,encoding:c[i.encoding],text:i.text,font:i.font,fontSize:i.fontSize,fontWeight:Math.min(i.fontWeight,900),fontItalic:i.fontItalic,style:d[i.style],width:i.width,height:i.height,textColor:h(i.textColor),backgroundColor:h(i.backgroundColor),backgroundOpacity:i.backgroundOpacity,borderColor:h(i.borderColor),borderOpacity:i.borderOpacity,borderWidth:i.borderWidth,borderLineStyle:f[i.borderLineStyle],horizontalAlignment:g[i.horizontalAlignment],link:i.link});var e=this._nodes.get(i.nodeRef);this._callouts.set(e,b);(e||this._parentNode).add(b._node);if(!this._parentNode.userData._vkCallouts){this._parentNode.userData._vkCallouts=[];}this._parentNode.userData._vkCallouts.push(b);};S.prototype.insertLeaderLine=function(b){var e=this._nodes.get(b.nodeRef);var t=this._nodes.get(b.targetNodeRef)||this._parentNode;var r=this._materials.get(b.materialRef);var s=this._callouts.get(e);if(s){var v=[];for(var i=0;i<b.points.length;i+=3){v.push(new THREE.Vector3().fromArray(b.points,i));}s.addLeaderLine(v,t,r,l[b.startPointStyle],l[b.endPointStyle]);}};S.prototype.createCamera=function(i){var b=null;if(i.projection==="perspective"){b=new sap.ui.vk.threejs.PerspectiveCamera();b.setFov(i.fov);}else if(i.projection==="orthographic"){b=new sap.ui.vk.threejs.OrthographicCamera();b.setZoomFactor(i.orthoZoomFactor);}if(b){b.setNearClipPlane(i.nearClip);b.setFarClipPlane(i.farClip);b.setUsingDefaultClipPlanes(i.autoEvaluateClipPlanes);var e=new THREE.Vector3().fromArray(i.origin);var t=new THREE.Vector3().fromArray(i.target).sub(e);var u=new THREE.Vector3().fromArray(i.up).sub(e);b.setUpDirection(u.toArray());b.setPosition(e.toArray());b.setTargetDirection(t.toArray());}this._parentNode.userData.camera=b;this._cameras.set(i.cameraRef,b);};S.prototype.insertCamera=function(b,e){var i=this._nodes.get(b);var r=this._cameras.get(e);r=r?r.getCameraRef():null;if(i&&r){(i||this._parentNode).add(r.parent?r.clone():r);}};var j=[sap.ui.vk.DetailViewType.DetailView,sap.ui.vk.DetailViewType.Cutaway];var k=[sap.ui.vk.DetailViewShape.Box,sap.ui.vk.DetailViewShape.Circle,sap.ui.vk.DetailViewShape.CircleLine,sap.ui.vk.DetailViewShape.CirclePointer,sap.ui.vk.DetailViewShape.CircleArrow,sap.ui.vk.DetailViewShape.CircleBubbles,sap.ui.vk.DetailViewShape.BoxLine,sap.ui.vk.DetailViewShape.BoxNoOutline,sap.ui.vk.DetailViewShape.SolidPointer,sap.ui.vk.DetailViewShape.SolidArrow];S.prototype.createDetailView=function(i){var b=new sap.ui.vk.threejs.DetailView({name:i.name,camera:this._cameras.get(i.cameraRef),type:j[i.type],shape:k[i.shape],borderWidth:i.borderWidth,backgroundColor:h(i.backgroundColor),borderColor:h(i.borderColor),renderOrder:i.renderOrder||0,origin:new THREE.Vector2().fromArray(i.origin),size:new THREE.Vector2().fromArray(i.size),attachmentPoint:new THREE.Vector3().fromArray(i.attachmentPoint),metadata:i.metadata,veId:i.veid});this._detailViews.set(i.detailViewRef,b);var e=this._nodes.get(i.nodeRef);(e||this._parentNode).add(b._node);if(!this._parentNode.userData._vkDetailViews){this._parentNode.userData._vkDetailViews=[];}this._parentNode.userData._vkDetailViews.push(b);};S.prototype.createMaterial=function(i){var b;var e=i.linestyle;if(e.width>0){b=new THREE.LineBasicMaterial({color:new THREE.Color(e.color[0],e.color[1],e.color[2]),depthTest:false,linewidth:e.width});}else{if(i.textures){i.textures.forEach(function(t){var r=t.filterMode===1?THREE.NearestFilter:THREE.LinearFilter;var s=new THREE.Texture(this._images.get(t.imageRef),t.type==="reflection"?THREE.SphericalReflectionMapping:THREE.UVMapping,t.repeatX?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,t.repeatY?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,r,r);s.offset.set(t.offsetX,t.offsetX);s.repeat.set(t.scaleX,t.scaleY);i[t.type+"Texture"]=s;s.needsUpdate=true;s.influence=t.amount;},this);}b=new THREE.MeshPhongMaterial({opacity:i.opacity,color:new THREE.Color(i.diffuse[0],i.diffuse[1],i.diffuse[2]),shininess:i.glossiness*2+i.specularLevel*3,emissive:new THREE.Color(i.emissive[0]+i.ambient[0]*0.2,i.emissive[1]+i.ambient[1]*0.2,i.emissive[2]+i.ambient[2]*0.2),specular:new THREE.Color(i.specular[0],i.specular[1],i.specular[2]),map:i.diffuseTexture?i.diffuseTexture:null,specularMap:i.specularTexture?i.specularTexture:null,emissiveMap:i.emissiveTexture?i.emissiveTexture:null,envMap:i.reflectionTexture?i.reflectionTexture:null,alphaMap:i.opacityTexture?i.opacityTexture:null,bumpMap:i.bumpTexture?i.bumpTexture:null,transparent:i.opacity<1||!!i.opacityTexture});if(b.map){b.color.lerp(new THREE.Color(1,1,1),b.map.influence?b.map.influence:0);}if(b.bumpMap){b.bumpScale=b.bumpMap.influence?b.bumpMap.influence:0;}if(b.envMap){b.mapping=THREE.SphericalReflectionMapping;b.combine=THREE.AddOperation;b.reflectivity=b.envMap.influence?b.envMap.influence:0;}}this._materials.set(i.materialRef,b);};S.prototype.createImage=function(i){var b=window.btoa(String.fromCharCode.apply(null,i.data));var e=new THREE.ImageLoader().load("data:image/"+i.format+";base64,"+b);this._images.set(i.imageRef,e);};S.prototype.progress=function(b){L.log("reading progress:",b);};var o=function(e){var b=e.data;if(b.ready){o.resolve();}else{var s=S.getById(b.sceneBuilderId);s[b.method].apply(s,b.args);}};var m=function(e){L.error("Error in WebWorker",e);};var p=(function(){var b;return function(){return b||(b=new Promise(function(r){var w=new Worker(sap.ui.require.toUrl("sap/ui/vk/threejs/MataiLoaderWorker.js"));o.resolve=r.bind(null,w);w.onmessage=o;w.onerror=m;}));};})();var q=function(b,u,e,i,r,s){p().then(function(w){var t=new S(e,i,r,s);w.postMessage({method:"loadSceneFromArrayBuffer",sceneBuilderId:t.getId(),buffer:b,fileName:u,sourceLocation:"remote"},[b]);});};return function(b,i){return new Promise(function(r,s){if(typeof i.getSource()==="string"){var u=i.getSource();fetch(u).then(function(e){if(e.ok){return e.arrayBuffer();}throw(new Error(e.statusText));}).then(function(e){q(e,u,b,i,r,s);}).catch(function(e){s(e);});}else if(i.getSource()instanceof File){var t=new FileReader();t.onload=function(e){q(e.target.result,i.getSource().name,b,i,r,s);};t.onerror=function(e){s(e);};t.readAsArrayBuffer(i.getSource());}});};});
