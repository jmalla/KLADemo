/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/core/Control','sap/ui/model/PropertyBinding','sap/ui/model/Context','sap/ui/model/base/ManagedObjectModel','sap/ui/base/ManagedObjectObserver','sap/base/Log','sap/ui/mdc/library','./FilterItemLayout','sap/ui/mdc/base/FilterField','sap/ui/mdc/base/FieldValueHelp','sap/ui/mdc/util/IdentifierUtil','sap/ui/layout/AlignedFlowLayout','sap/m/library','sap/m/Button','sap/ui/model/json/JSONModel',"sap/ui/fl/ControlPersonalizationAPI"],function(C,P,a,M,b,L,m,F,c,d,I,A,l,B,J,e){"use strict";var f=m.FilterExpression;var g=l.ButtonType;var h=C.extend("sap.ui.mdc.base.filterbar.FilterBar",{metadata:{library:"sap.ui.mdc",designtime:"sap/ui/mdc/designtime/base/filterbar/FilterBar.designtime",defaultAggregation:"filterItems",properties:{metadataDelegate:{type:"string",defaultValue:"sap/ui/mdc/base/filterbar/FilterBarHelper"},conditionModelName:{type:"string",defaultValue:null},dataTypeFormatOptions:{type:"object",group:"Data",defaultValue:{style:'short'}},liveMode:{type:"boolean",defaultValue:false},showGoButton:{type:"boolean",defaultValue:true},showAdaptFiltersButton:{type:"boolean",defaultValue:true}},aggregations:{filterItems:{type:"sap.ui.mdc.base.FilterField",multiple:true},conditionsData:{type:"sap.ui.mdc.base.filterbar.ConditionsData",multiple:true,singularName:"conditionData"}},events:{search:{},reset:{},filtersChanged:{filtersText:{type:"string"}}}},renderer:function(r,o){r.write("<div ");r.writeControlData(o);r.writeClasses();r.write(">");r.renderControl(o._getContent());r.write("</div>");}});h.INNER_MODEL_NAME="$sap.ui.mdc.base.filterbar.FilterBar";var j=null;var k=null;h.prototype.init=function(){this.addStyleClass("sapUiMdcBaseFilterBar");this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this._createInnerModel();this._aProperties=null;this.attachModelContextChange(this._setModel,this);this._oObserver=new b(this._observeChanges.bind(this));this._oObserver.observe(this,{aggregations:["filterItems","conditionsData"]});this._oFilterBarLayout=new A();this._addButtons();this._fFilterBarInitialized=undefined;this._oInitializedPromise=new Promise(function(r){this._fFilterBarInitialized=r;}.bind(this));this._fConditionsModel=undefined;this._oConditionModelPromise=new Promise(function(r){this._fConditionsModel=r;}.bind(this));this._clearChanges();this._aConditions=[];this._fFilterBarMetadataApplied=undefined;this._oMetadatAppliedPromise=new Promise(function(r){this._fFilterBarMetadataApplied=r;}.bind(this));};h.prototype.initialized=function(){if(!this._oMetadataPromise){this._oMetadataPromise=this._retrieveMetadata();}return this._oInitializedPromise;};h.prototype.applySettings=function(s,S){C.prototype.applySettings.apply(this,arguments);};h.prototype.setMetadataDelegate=function(p){this.setProperty("metadataDelegate",p);this._oMetadataPromise=this._retrieveMetadata();};h.prototype._createInnerModel=function(){this._oModel=new M(this);this.setModel(this._oModel,h.INNER_MODEL_NAME);};h.prototype._addButtons=function(){if(this._oFilterBarLayout){this._btnAdapt=new B(this.getId()+"-btnAdapt",{text:this._oRb.getText("filterbar.ADAPT"),press:this.onAdaptFilters.bind(this)});this._btnAdapt.setModel(this._oModel,h.INNER_MODEL_NAME);this._btnAdapt.bindProperty("visible",{path:'/showAdaptButtonsButton',model:h.INNER_MODEL_NAME});this._oFilterBarLayout.addEndContent(this._btnAdapt);this._btnSearch=new B(this.getId()+"-btnSearch",{text:this._oRb.getText("filterbar.GO"),press:this.onSearch.bind(this),type:g.Emphasized});this._btnSearch.setModel(this._oModel,h.INNER_MODEL_NAME);this._btnSearch.bindProperty("visible",{parts:[{path:'/showGoButton',model:h.INNER_MODEL_NAME},{path:"/liveMode",model:h.INNER_MODEL_NAME}],formatter:function(v,V){return v&&!V;}});this._oFilterBarLayout.addEndContent(this._btnSearch);}};h.prototype._initializeProvider=function(){var s=this.getMetadataDelegate();return new Promise(function(r){sap.ui.require([s],function(i){r(i);});});};h.prototype.onAdaptFilters=function(E){this.showFiltersDialog();};h.prototype._setModel=function(){var o=this.getModel(this.getConditionModelName());if(o&&!this._oConditionChangeBinding){this.detachModelContextChange(this._setModel,this);this._oConditionChangeBinding=o.bindProperty("/",o.getContext("/"));this._oConditionChangeBinding.attachChange(this._handleConditionModelChange.bind(this));this._fConditionsModel(o);}};h.prototype._getAssignedFilterNames=function(){var o,n,p=null,q=this._getConditionModel(),r;if(q){o=q.getConditions();p=[];for(var i in o){n=o[i].fieldPath;if(n==="$search"){continue;}if(p.indexOf(n)<0){r=this._getFilterField(n);if(r){if(r.getVisible()){p.push(n);}}else{p.push(n);}}}}return p;};h.prototype._getAssignedFiltersText=function(i){var s,n;i=i||[];if(i.length>5){n=i.slice(0,5);n.push("...");}else{n=i;}s=Object.values(n).join(", ");if(i.length){return this._oRb.getText("filterbar.ADAPT_FILTERED",[i.length,s]);}return this._oRb.getText("filterbar.ADAPT_NOTFILTERED");};h.prototype.getAssignedFiltersText=function(){return this._getAssignedFiltersText(this._getAssignedFilterNames());};h.prototype._handleConditionModelChange=function(E){var o={},i=this._getAssignedFilterNames();if(i){if(this._btnAdapt){this._btnAdapt.setText(this._oRb.getText(i.length?"filterbar.ADAPT_NONZERO":"filterbar.ADAPT",i.length));}o.filtersText=this._getAssignedFiltersText(i);this.fireFiltersChanged(o);if(this.getLiveMode()){this.fireSearch();}}};h.prototype.onReset=function(E){this.fireReset();};h.prototype.onSearch=function(E){this.fireSearch();};h.prototype.fireSearch=function(E){var o=this._getConditionModel();if(o){o.applyFilters();}};h.prototype._getConditionModel=function(){var o=null,s=this.getConditionModelName();if(s){o=this.getModel(s);if(!o||!o.isA("sap.ui.mdc.base.ConditionModel")){L.error("error during _getConditionModel - no condition model obtained.");o=null;}}return o;};h.prototype.getProvider=function(){return this._oProvider;};h.prototype.showFiltersDialog=function(){if(!j){sap.ui.require(["sap/ui/mdc/base/filterbar/AdaptFiltersDialog","sap/ui/mdc/base/filterbar/AdaptFiltersDialogItem"],function(i,n){j=i;k=n;this._showFiltersDialog();}.bind(this));}else{this._showFiltersDialog();}};h.prototype._showFiltersDialog=function(){this._clearChanges();var o=new J({showResetEnabled:false,items:this._setItemsForAdaptFiltersDialog()});var i=new k({key:"{$sapuimdcbasefilterbarAdaptFiltersDialog>key}",text:"{$sapuimdcbasefilterbarAdaptFiltersDialog>text}",tooltip:"{$sapuimdcbasefilterbarAdaptFiltersDialog>tooltip}",required:"{$sapuimdcbasefilterbarAdaptFiltersDialog>required}",visible:"{$sapuimdcbasefilterbarAdaptFiltersDialog>visible}",relativePosition:"{$sapuimdcbasefilterbarAdaptFiltersDialog>relativePosition}",controls:{path:'$sapuimdcbasefilterbarAdaptFiltersDialog>controls',templateShareable:false,factory:function(s,q){return q.getObject(q.getPath());}}});var n=new j({showReset:false,showResetEnabled:{path:'$sapuimdcbasefilterbarAdaptFiltersDialog>/showResetEnabled'},items:{path:'$sapuimdcbasefilterbarAdaptFiltersDialog>/items',templateShareable:false,template:i},visibilityChanged:function(E){this._addFilterVisibilityChange(E.getParameter("key"),E.getParameter("visible"));}.bind(this),positionChanged:function(E){this._addFilterPositionyChange(E.getParameter("key"),E.getParameter("relativePosition"));}.bind(this),ok:function(E){this._storeChanges();E.getSource().close();E.getSource().destroy();this._oAdaptFiltersDialog=null;}.bind(this),reset:function(){this._oAdaptFiltersDialog=null;},cancel:function(E){E.getSource().close();E.getSource().destroy();this._oAdaptFiltersDialog=null;}});n.setModel(o,"$sapuimdcbasefilterbarAdaptFiltersDialog");var p=this._getConditionModel().clone();n.setModel(p,"cmodel");this.addDependent(n);this._oAdaptFiltersDialog=n;n.open();};h.prototype._addFilterPositionyChange=function(n,i){var o=this._getFilterField(n);var s=o?o.getId():this._getFilterFieldId(n);this._removeSetFilterPositionChange(s);var p={id:s,position:i};this._aChanges.push({selectorControl:this,changeSpecificData:{changeType:"setFilterPosition",content:p}});};h.prototype._addFilterVisibilityChange=function(n,v){var o=this._getFilterField(n),p=this._getNonHiddenPropertyByName(n);if(p){if(v){if(!o){p.setPath('\{'+this.getConditionModelName()+">/conditions/"+n+'\}');this._aChanges.push({selectorControl:this,changeSpecificData:{changeType:"addFilter",content:{id:this._getFilterFieldId(n),name:n,type:p.getType(),path:p.getPath(),required:p.getRequired(),label:p.getLabel(),filterExpression:p.getFilterExpression(),hasFieldHelp:p.getHasFieldHelp(),fieldHelp:p.getFieldHelp(),fieldHelpShowConditionPanel:p.getFieldHelpShowConditionPanel(),fieldHelpDescriptionPath:p.getFieldHelpDescriptionPath()}}});}else{if(o.getVisible()){this._removeRemoveFilterChange(o);}else{this._aChanges.push({selectorControl:this,changeSpecificData:{changeType:"addFilter",content:{id:this._getFilterFieldId(n),name:n,type:p.getType(),path:p.getPath(),required:p.getRequired(),label:p.getLabel(),filterExpression:p.getFilterExpression(),hasFieldHelp:p.getHasFieldHelp(),fieldHelp:p.getFieldHelp(),fieldHelpShowConditionPanel:p.getFieldHelpShowConditionPanel(),fieldHelpDescriptionPath:p.getFieldHelpDescriptionPath()}}});}}}else{if(o){this._aChanges.push({selectorControl:this,changeSpecificData:{changeType:"removeFilter",content:{id:o.getId()}}});}else{this._removeAddFilterChange(p);}}}else{L.error("addFilter change can't be created. No corresponding property found for "+n);}};h.prototype._filterValueChanged=function(o,i,v){var s=o.getFieldPath();if(!i){return;}this._removeFilterValueChange(s);if(i.length===0){this._aChanges.push({selectorControl:this,changeSpecificData:{changeType:"removeFilterValue",content:{name:s}}});}else{this._aChanges.push({selectorControl:this,changeSpecificData:{changeType:"setFilterValue",content:{name:s,conditions:i}}});}if(!this._oAdaptFiltersDialog){this._storeChanges();}};h.prototype._removeFilterValueChange=function(s){var n=-1;this._aChanges.some(function(o,i){if(((o.changeSpecificData.changeType==="setFilterValue")||(o.changeSpecificData.changeType==="removeFilterValue"))&&(o.changeSpecificData.content.name===s)){n=i;}return n>-1;});if(n>-1){this._aChanges.splice(n,1);}};h.prototype._removeAddFilterChange=function(p){var n=-1;this._aChanges.some(function(o,i){if((o.changeSpecificData.changeType==="addFilter")&&(o.changeSpecificData.content.name===p.getName())){n=i;}return n>-1;});if(n>-1){this._aChanges.splice(n,1);}};h.prototype._removeRemoveFilterChange=function(o){var n=-1;this._aChanges.some(function(i,p){if((i.changeSpecificData.changeType==="removeFilter")&&(i.changeSpecificData.content.id===o.getId())){n=p;}return n>-1;});if(n>-1){this._aChanges.splice(n,1);}};h.prototype._removeSetFilterPositionChange=function(i){var n=-1;this._aChanges.some(function(o,p){if((o.changeSpecificData.changeType==="setFilterPosition")&&(o.changeSpecificData.content.id===i)){n=p;}return n>-1;});if(n>-1){this._aChanges.splice(n,1);}};h.prototype._clearChanges=function(){this._aChanges=[];};h.prototype._condenseChange=function(){var n,o,r=[];this._aChanges.every(function(p){var i,q,s=false;if(p.changeSpecificData.changeType==="setFilterPosition"){if(p.changeSpecificData.content.id){for(i=0;i<this._aChanges.length;i++){q=this._aChanges[i];if((q.changeSpecificData.changeType==="removeFilter")&&(q.changeSpecificData.content.id===p.changeSpecificData.content.id)){s=true;break;}}}else if(p.changeSpecificData.content.name){s=true;for(i=0;i<this._aChanges.length;i++){q=this._aChanges[i];if((q.changeSpecificData.changeType==="addFilter")&&(q.changeSpecificData.content.name===p.changeSpecificData.content.name)){s=false;break;}}}if(!s){r.push(p);}}else if(p.changeSpecificData.changeType==="addFilter"){n=p.changeSpecificData.content.name;o=this._getFilterField(n);if(o&&!o.getVisible()){o.setVisible(true);}else{r.push(p);}}else{r.push(p);}return true;}.bind(this));this._aChanges=r;};h.prototype._storeChanges=function(){this._condenseChange();if(this._aChanges&&this._aChanges.length){e.addPersonalizationChanges({controlChanges:this._aChanges,ignoreVariantManagement:false});this._clearChanges();}};h.prototype._setItemsForAdaptFiltersDialog=function(){var i=this.getFilterItems();return this._getNonHiddenPropertyInfoSet().map(function(p,n){var K=p.getName();var o=this._getFilterField(K);var q=i.indexOf(o);var r=o?o.clone():this.createFilterField(p);r.setVisible(true);r.bindProperty("conditions",{path:"cmodel>/conditions/"+K});return{key:K,text:p.getLabel(),tooltip:p.getLabel(),required:p.getRequired(),relativePosition:q,visible:(q>-1)&&o.getVisible(),controls:[r]};}.bind(this));};h.prototype._getContent=function(){return this._oFilterBarLayout;};h.prototype._insertFilterFieldtoContent=function(o,n){if(!F){return;}var i=new F();i.setFilterField(o);this._oFilterBarLayout.insertContent(i,n);};h.prototype.addConditions=function(s,i){this._aConditions.push({fieldPath:s,conditions:i});this._handleConditions();};h.prototype.removeAllConditions=function(s){this._aConditions.push({fieldPath:s,conditions:null});this._handleConditions();};h.prototype.removeConditions=function(s,i){var o=this._getConditionModel();if(o&&i){i.forEach(function(n){o.removeCondition(s,n);});}};h.prototype._handleConditions=function(D){var i=function(o){this._aConditions.forEach(function(n){o.removeAllConditions(n.fieldPath);if(n.conditions){n.conditions.forEach(function(p){o.addCondition(n.fieldPath,p);});}});this._aConditions=[];}.bind(this);var o=this._getConditionModel();if(o){i(o);}else{Promise.all([this._oConditionModelPromise,this._oMetadatAppliedPromise]).then(function(n){var o=this._getConditionModel();if(o){i(o);}}.bind(this));}};h.prototype._filterItemInserted=function(o){var n,p;if(!o.getVisible()){return;}if(!o.getDataTypeFormatOptions()){o.setDataTypeFormatOptions(this.getDataTypeFormatOptions());}p=this.indexOfAggregation("filterItems",o);if(this._basicSearchFilterField){p++;}if(!o.hasListeners("change")){o.attachChange(this._filterFieldValueChange.bind(this));}n=p;var q=this.getFilterItems();for(var i=0;i<n;i++){if(!q[i].getVisible()){p--;}}this._insertFilterFieldtoContent(o,p);if(!this._oObserver.isObserved(o,{properties:["visible"]})){this._oObserver.observe(o,{properties:["visible"]});}};h.prototype._filterItemRemoved=function(o){var i=null;this._oFilterBarLayout.getContent().some(function(n){if(n._getFilterField()===o){i=n;}return i!==null;});if(i){this._oFilterBarLayout.removeContent(i);}};h.prototype._observeChanges=function(o){if(o.type==="aggregation"&&o.name==="filterItems"){switch(o.mutation){case"insert":this._filterItemInserted(o.child);break;case"remove":this._filterItemRemoved(o.child);break;default:L.error("operation "+o.mutation+" not yet implemented");}}else if(o.type==="property"){var i,n;if(o.object.isA("sap.ui.mdc.base.FilterField")){n=this._getFilterField(o.object.getFieldPath());if(n){if(o.current){this._filterItemInserted(n);}else{this._filterItemRemoved(n);}this._oFilterBarLayout.rerender();}}else if(o.object.isA("sap.ui.mdc.PropertyInfo")){n=this._getFilterField(o.object.getName());if(n){if((o.name==="tooltip")){n.setTooltip(o.current);}else{n.setProperty(o.name,o.current);i=this._getFilterItemLayout(n);if(i){i.rerender();}}}}}};h.prototype._getFilterItemLayout=function(o){var i=null;this._oFilterBarLayout.getContent().some(function(n){if(n._getFilterField()===o){i=n;}return i!==null;});return i;};h.prototype._getFilterField=function(n){var o=null;this.getFilterItems().some(function(i){if(i&&i.getFieldPath&&(i.getFieldPath()===n)){o=i;}return o!==null;});return o;};h.prototype._retrieveMetadata=function(){return new Promise(function(r){Promise.all([this._oConditionModelPromise,this._initializeProvider()]).then(function(i){this._oProvider=i[1];if(this._oProvider){this._oProvider.fetchProperties(this).then(function(p){this._aProperties=p;this.enrichFiltersWithMetadata();this.applySearchField();}.bind(this));}else{this._aProperties=[];}this._metadataApplied();r();}.bind(this));}.bind(this));};h.prototype._metadataApplied=function(){this._fFilterBarMetadataApplied();this._fFilterBarInitialized();};h.prototype.enrichFiltersWithMetadata=function(){this.getFilterItems().every(function(o){var n=o.getFieldPath();this._getNonHiddenPropertyInfoSet().some(function(p){var v,i=1;if((p.getName()===n)&&(n!=="$search")){o.setDataType(p.getType());o.setRequired(p.getRequired());o.setDataTypeFormatOptions(this.getDataTypeFormatOptions());if(p.getFilterExpression()===f.Multi){i=-1;}o.setMaxConditions(i);v=p.getFilterConditions();if(v&&(v.length>0)){o.setConditions(v);}if(p.getTooltip()){o.setTooltip(p.getTooltip());}this._oObserver.observe(p,{properties:["required","label","toolbar","visible","visibleInFilterBar"]});return true;}return false;}.bind(this));return true;}.bind(this));};h.prototype.applySearchField=function(){var p=this._getSearchFieldProperty();if(p){this._basicSearchFilterField=this.createFilterField(p);this._insertFilterFieldtoContent(this._basicSearchFilterField,0);this._oFilterBarLayout.rerender();}};h.prototype.applyVisibleInFilterBar=function(){var i=this.getFilterItems();this._getNonHiddenPropertyInfoSet().every(function(p){var n=false;if(p.getVisible()){i.some(function(o){if(o.getFieldPath()===p.getName()){n=true;}return n;});if(!n){this.addFilterItem(this.createFilterField(p));}}return true;}.bind(this));};h.prototype._applyDefaultValues=function(){var o=this._getConditionModel();if(o){this.getPropertyInfoSet().every(function(p){var v=p.getDefaultFilterConditions();if(v&&v.length){v.every(function(i){o.addCondition(p.getName(),i);return true;});}return true;});}};h.prototype.getPropertyInfoSet=function(){return this._aProperties||[];};h.prototype._getSearchFieldProperty=function(){return this._getPropertyByName("$search");};h.prototype._getPropertyByName=function(n){var o=null;this.getPropertyInfoSet().some(function(p){if(p.getName()===n){o=p;}return o!=null;});return o;};h.prototype._getNonHiddenPropertyInfoSet=function(){var v=[];this.getPropertyInfoSet().every(function(p){if(!p.getHiddenFilter()){if(p.getName()!=="$search"){v.push(p);}}return true;});return v;};h.prototype._getNonHiddenPropertyByName=function(n){var p=null;this._getNonHiddenPropertyInfoSet().some(function(o){if(o.getName()===n){p=o;}return p!=null;});return p;};h.prototype._getFilterFieldId=function(n){return this.getId()+"--filter--"+I.replace(n);};h.prototype.createFilterField=function(p){var o,n=1;if(p.getFilterExpression()===f.Multi){n=-1;}o=new c(this._getFilterFieldId(p.getName()),{dataType:p.getType(),required:p.getRequired(),dataTypeFormatOptions:this.getDataTypeFormatOptions(),maxConditions:n,visible:p.getVisible()});o.bindProperty("conditions",{path:this.getConditionModelName()+">/conditions/"+p.getName()},true);var v=p.getFilterConditions();if(v&&(v.length>0)){o.setConditions(v);}if(p.getTooltip()){o.setTooltip(p.getTooltip());}if(p.getHasFieldHelp()){this._createValueHelp(o,p);}var i=this._getConditionModel();if(i){o.setModel(i,this.getConditionModelName());}o.attachChange(this._filterFieldValueChange.bind(this));return o;};h.prototype._createValueHelp=function(o,p){var v=null,V=p.getFieldHelp();if(!V){v=new d({title:p.getFieldHelpTitle(),showConditionPanel:p.getFieldHelpShowConditionPanel()});V=v.getId();}o.setFieldHelp(V);if(v){o.addAggregation("dependents",v);}};h.prototype._filterFieldValueChange=function(E){if(E&&E.getParameter("valid")){this._filterValueChanged(E.oSource,E.getParameter("conditions"),E.getParameter("value"));}};h.prototype.exit=function(){C.prototype.exit.apply(this,arguments);if(this._oFilterBarLayout){this._oFilterBarLayout.destroy();this._oFilterBarLayout=null;}this._btnAdapt=undefined;this._btnSearch=undefined;if(this._basicSearchFilterField){this._basicSearchFilterField.destroy();this._basicSearchFilterField=null;}this._oRb=null;this.detachModelContextChange(this._setModel,this);if(this._oConditionChangeBinding){this._oConditionChangeBinding.detachChange(this._handleConditionModelChange.bind(this));this._oConditionChangeBinding=null;}if(this._oModel){this._oModel.destroy();this._oModel=null;}this._oObserver.disconnect();this._oObserver=undefined;this._oProvider=null;this._aProperties=null;this._oInitializedPromise=null;this._fFilterBarInitialized=undefined;this._oConditionModelPromise=null;this._fConditionModelPromise=undefined;this._oMetadataPromise=null;this._aConditions=null;this._aChanges=null;};return h;},true);
