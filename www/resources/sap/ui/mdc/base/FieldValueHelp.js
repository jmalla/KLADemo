/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['./FieldHelpBase','./FilterOperatorConfig','./Condition','sap/ui/base/ManagedObjectObserver','sap/base/util/merge','sap/base/util/ObjectPath','sap/base/util/deepEqual'],function(F,a,C,M,m,O,d){"use strict";var D;var B;var V;var b;var c;var e=F.extend("sap.ui.mdc.base.FieldValueHelp",{metadata:{library:"sap.ui.mdc",properties:{getTextForKey:{type:"function",group:"Data"},getKeyForText:{type:"function",group:"Data"},getKeyFromItem:{type:"function",group:"Data"},getTextFromItem:{type:"function",group:"Data"},filterFields:{type:"string",defaultValue:"$search"},keyPath:{type:"string",defaultValue:""},descriptionPath:{type:"string",defaultValue:""},showConditionPanel:{type:"boolean",defaultValue:false},title:{type:"string",group:"Appearance",defaultValue:""},noDialog:{type:"boolean",group:"Appearance",defaultValue:false}},aggregations:{content:{type:"sap.ui.mdc.base.FieldValueHelpContentWrapperBase",multiple:false},filterBar:{type:"sap.ui.core.Control",multiple:false},_dialog:{type:"sap.m.Dialog",multiple:false,visibility:"hidden"}},defaultAggregation:"content",events:{navigateToItem:{parameters:{step:{type:"int"},selectedItem:{type:"sap.m.ListItemBase"}}},filterItems:{parameters:{filterText:{type:"string"}}}}}});e.prototype.init=function(){F.prototype.init.apply(this,arguments);this._oObserver=new M(_.bind(this));this._oObserver.observe(this,{properties:["filterValue","conditions","showConditionPanel","title","filterFields"],aggregations:["content","filterBar"]});};e.prototype.exit=function(){F.prototype.exit.apply(this,arguments);this._oObserver.disconnect();this._oObserver=undefined;if(this._oFilterOperatorConfig){this._oFilterOperatorConfig.destroy();delete this._oFilterOperatorConfig;}};e.prototype.invalidate=function(i){if(i){var j=this.getAggregation("_dialog");var N=this.getFilterBar();if((j&&i===j)||(N&&i===N)){if(i.bOutput){var S=sap.ui.getCore().getStaticAreaRef();S=sap.ui.getCore().getUIArea(S);if(S.addInvalidatedControl){S.addInvalidatedControl(i);}}return;}}F.prototype.invalidate.apply(this,arguments);};e.prototype.connect=function(i){if(this._oField&&this._oField!==i){if(this._oFilterConditionModel){this._oFilterConditionModel.removeFilterField(this);}if(this._oConditionModel){this._oConditionModel.removeFilterField(this);}}F.prototype.connect.apply(this,arguments);if(this._oFilterConditionModel){this._oFilterConditionModel.addFilterField(this);}if(this._oConditionModel){this._oConditionModel.addFilterField(this);}else{s.call(this);}J.call(this,this.getShowConditionPanel());return this;};e.prototype.getIcon=function(){if(this.getNoDialog()){return"sap-icon://slim-arrow-down";}else{return"sap-icon://value-help";}};e.prototype._createPopover=function(){var P=F.prototype._createPopover.apply(this,arguments);if(P){var i=this._getField();if(i){P.setInitialFocus(i);}var W=this.getContent();if(W){W.initialize(true);}P._getAllContent=function(){var j=this.getParent();var N=[];if(j){var Q=L.call(j);if(Q){N.push(Q);}}return N;};if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep);this._iStep=null;}}return P;};e.prototype._handleAfterOpen=function(i){F.prototype._handleAfterOpen.apply(this,arguments);var W=this.getContent();if(W){W.fieldHelpOpen(true);}};e.prototype.open=function(S){if(this.getNoDialog()&&!S){S=true;}var W=this.getContent();if(W&&W.getFilterEnabled()&&!this._oFilterConditionModel){q.call(this);}var P=this.getAggregation("_popover");if(S){if(!W){this._bOpenIfContent=true;this.fireOpen({suggestion:S});}else{if(P){var i=this._getField();P.setInitialFocus(i);}F.prototype.open.apply(this,[S]);}}else{if(P){if(P.isOpen()){this.close();}P.$().remove();}var j=A.call(this);if(j){var N=j.getContent()[0];N.setShowTokenizer(this.getMaxConditions()!==1&&!!W);this.fireOpen({suggestion:S});if(W){W.fieldHelpOpen(false);l.call(this);}j.open();}else{this._bOpen=true;}}return;};e.prototype.toggleOpen=function(S){if(this.getNoDialog()&&!S){S=true;}if(S){F.prototype.toggleOpen.apply(this,[S]);}else{var i=A.call(this);if(i){if(i.isOpen()){var j=i.oPopup.getOpenState();if(j!=="CLOSED"&&j!=="CLOSING"){this.close();}else{this._bReopen=true;}}else{this.open(S);}}else{this._bOpen=!this._bOpen;}}};e.prototype.close=function(){if(!this._bDialogOpen){F.prototype.close.apply(this,arguments);}else{var i=this.getAggregation("_dialog");if(i){this._bClosing=true;i.close();var W=this.getContent();if(W){W.fieldHelpClose();this._oFilterConditionModel.removeAllConditions();o.call(this);}}this._bReopen=false;}};e.prototype._handleAfterClose=function(i){F.prototype._handleAfterClose.apply(this,arguments);if(this._bUpdateFilterAfterClose){this._bUpdateFilterAfterClose=false;n.call(this,this._sFilterValueAfterClose);this._sFilterValueAfterClose=null;}var W=this.getContent();if(W){W.fieldHelpClose();}};function _(i){if(i.name==="content"){z.call(this,i.mutation,i.child);}if(i.name==="filterBar"){K.call(this,i.mutation,i.child);}if(i.name==="conditions"){k.call(this,i.current);}if(i.name==="filterValue"){if(this._bClosing){this._bUpdateFilterAfterClose=true;this._sFilterValueAfterClose=i.current;}else{n.call(this,i.current);}}if(i.name==="showConditionPanel"){J.call(this,i.current);}if(i.name==="title"){var j=this.getAggregation("_dialog");if(j){j.setTitle(i.current);}}if(i.name==="filterFields"){var j=this.getAggregation("_dialog");if(j){var N=j.getContent()[0];N.setFilterFields(i.current);}}}e.prototype.openByTyping=function(){return true;};e.prototype.navigate=function(S){var W=this.getContent();var P;if(W){P=this._getPopover();}if(!P){this._bNavigate=true;this._iStep=S;if(!W){this.fireOpen({suggestion:true});}return;}else if(!P.isOpen()){this.fireOpen({suggestion:true});}if(W){W.navigate(S);}};function f(i){var P=this._getPopover();var j=i.getParameter("key");var N=i.getParameter("description");var Q=this.getFieldPath();var R;if(!P.isOpen()){this.open(true);}R=C.createItemCondition(Q,j,N);this.setProperty("conditions",[R],true);this.fireNavigate({value:N,key:j});}e.prototype.getTextForKey=function(i){var T="";var j=this.getGetTextForKey();if(j){T=j(i);if(typeof T!=="string"){throw new Error("function getTextForKey must return a string");}}else{var W=this.getContent();if(W){T=W.getTextForKey(i);}}return T;};e.prototype.getKeyForText=function(T){var i;var j=this.getGetKeyForText();if(j){i=j(T);}else{var W=this.getContent();if(W){i=W.getKeyForText(T);}}return i;};function g(N){var S=N.getParameter("selectedItems");var P=this.getFieldPath();var Q;var R=m([],this._oConditionModel.getConditions(P));var T;var i=0;var j=0;var U=false;for(i=0;i<R.length;i++){T=R[i];if(T.operator==="EEQ"||T.operator==="EQ"){U=false;for(j=0;j<S.length;j++){Q=S[j];if(T.values[0]===Q.key){U=true;break;}}if(!U){this._oConditionModel.removeCondition(P,T);}}}R=m([],this._oConditionModel.getConditions(P));for(i=0;i<S.length;i++){Q=S[i];U=false;for(j=0;j<R.length;j++){T=R[j];if((T.operator==="EEQ"||T.operator==="EQ")&&T.values[0]===Q.key){U=true;break;}}if(!U){T=C.createItemCondition(P,Q.key,Q.description);this._oConditionModel.addCondition(P,T);}}if(this._bDialogOpen){l.call(this);}else{this.close();var W=Q&&Q.key;var X=Q&&Q.description;this._bNoConditionModelUpdate=true;this.setProperty("conditions",[T],true);this.fireSelect({value:X,key:W,conditions:[T],add:true});}}function h(i){if(i.getParameter("contentChange")){var P=this.getAggregation("_popover");var j=this.getAggregation("_dialog");var W=this.getContent();if(W){if(P&&this._bOpenIfContent){var N=this._getField();if(N){W.fieldHelpOpen(true);P.openBy(N);}this._bOpenIfContent=false;}else if(j){var Q=j.getContent()[0];y.call(this,Q,W.getDialogContent());}if(this._oFilterConditionModel&&W.getListBinding()!==this._oFilterConditionModel._oListBinding){this._oFilterConditionModel.destroy();this._oFilterConditionModel=undefined;}if(W.getFilterEnabled()&&!this._oFilterConditionModel){q.call(this);}}}this.fireDataUpdate();}function k(j){if(this._oConditionModel){if(!this._bNoConditionModelUpdate){this._oConditionModel.removeAllConditions();for(var i=0;i<j.length;i++){var N=m({},j[i]);this._oConditionModel.addCondition(N.fieldPath,N);}}else{this._bNoConditionModelUpdate=false;}}else{s.call(this);}l.call(this);}function l(){if(!this._oField){return;}var j=this.getFieldPath();var W=this.getContent();if(W){var N=this._oConditionModel?this._oConditionModel.getConditions(j):this.getConditions();var P=[];for(var i=0;i<N.length;i++){var Q=N[i];if(Q.operator==="EEQ"||Q.operator==="EQ"){P.push({key:Q.values[0],description:Q.values[1]});}}if(!d(P,W.getSelectedItems())){W.setSelectedItems(P);}}}function n(i){if(!this._oFilterConditionModel){return;}var j=this.getFilterFields();if(!j){return;}if(i){this._bOwnFilterChange=true;}this._oFilterConditionModel.removeAllConditions(j);if(i){this._bOwnFilterChange=false;var N=C.createCondition(j,"StartsWith",[i]);this._oFilterConditionModel.addCondition(j,N);}}function o(){if(!this._oFilterConditionModel){return;}if(this._oFilterConditionModel._oListBinding.isSuspended()){this._oFilterConditionModel._oListBinding.resume();}this._oFilterConditionModel.applyFilters(true);}function p(i){if(this._bOwnFilterChange){return;}o.call(this);}function q(){if(!c&&!this._bFilterConditionModelRequested){c=sap.ui.require("sap/ui/mdc/base/ConditionModel");if(!c){sap.ui.require(["sap/ui/mdc/base/ConditionModel"],r.bind(this));this._bFilterConditionModelRequested=true;}}if(c){var i=this.getFilterValue();var W=this.getContent();var j=W&&W.getListBinding();if(j){this._oFilterConditionModel=c.getFor(j,this.getId());if(i){n.call(this,i);}var N=this._oFilterConditionModel.bindProperty("/conditions",this._oFilterConditionModel.getContext("/conditions"));N.attachChange(p.bind(this));this.setModel(this._oFilterConditionModel,"filter");}}}function r(i){c=i;this._bFilterConditionModelRequested=false;if(!this._bIsBeingDestroyed){q.call(this);}}e.prototype.getMaxConditions=function(){if(this._oField.getMaxConditions){return this._oField.getMaxConditions();}else{return 1;}};e.prototype.getDisplay=function(){if(this._oField.getDisplay){return this._oField.getDisplay();}};e.prototype.getRequired=function(){if(this._oField.getRequired){return this._oField.getRequired();}else{return false;}};e.prototype.getFilterOperatorConfig=function(){if(this._oField&&this._oField._getFilterOperatorConfig){return this._oField._getFilterOperatorConfig();}else if(this._oFilterOperatorConfig){return this._oFilterOperatorConfig;}else{this._oFilterOperatorConfig=a.getFor();return this._oFilterOperatorConfig;}};e.prototype.getDataType=function(){if(this._oField.getDataType){return this._oField.getDataType();}else{return"sap.ui.model.type.String";}};e.prototype._getDataType=function(){if(this._oField._getDataType){return this._oField._getDataType();}else{var i=O.get("sap.ui.model.odata.type.String");return new i();}};e.prototype._getKeyPath=function(){var i=this.getKeyPath();if(!i&&this._oField&&this._oField.getFieldPath&&this._oField.getFieldPath()){i=this._oField.getFieldPath();}return i;};function s(){if(!c&&!this._bConditionModelRequested){c=sap.ui.require("sap/ui/mdc/base/ConditionModel");if(!c){sap.ui.require(["sap/ui/mdc/base/ConditionModel"],t.bind(this));this._bConditionModelRequested=true;}}if(c){this._oConditionModel=new c();var i=this;this._oConditionModel.getFilterOperatorConfig=function(){return i.getFilterOperatorConfig();};var j=this._oConditionModel.bindProperty("/",this._oConditionModel.getContext("/"));j.attachChange(u.bind(this));this._oConditionModel.addFilterField(this);k.call(this,this.getConditions());this.setModel(this._oConditionModel,"cm");}}function t(i){c=i;this._bConditionModelRequested=false;if(!this._bIsBeingDestroyed){s.call(this);}}function u(i){if(this._bChangedByMe){this._bChangedByMe=false;return;}if(this._bDialogOpen){l.call(this);}}function v(){var i;if((!D||!B||!V||!b)&&!this._bDialogRequested){D=sap.ui.require("sap/m/Dialog");B=sap.ui.require("sap/m/Button");V=sap.ui.require("sap/ui/mdc/base/ValueHelpPanel");b=sap.ui.require("sap/ui/mdc/base/DefineConditionPanel");if(!D||!B||!V||!b||!c){sap.ui.require(["sap/m/Dialog","sap/m/Button","sap/ui/mdc/base/ValueHelpPanel","sap/ui/mdc/base/DefineConditionPanel"],w.bind(this));this._bDialogRequested=true;}}if(D&&B&&V&&b&&!this._bDialogRequested){if(!this._oResourceBundle){this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");}var j=new B(this.getId()+"-ok",{text:this._oResourceBundle.getText("valuehelp.OK"),press:E.bind(this)});var N=new B(this.getId()+"-cancel",{text:this._oResourceBundle.getText("valuehelp.CANCEL"),press:G.bind(this)});var P=x.call(this);i=new D(this.getId()+"-dialog",{contentHeight:"600px",contentWidth:"1000px",horizontalScrolling:false,verticalScrolling:false,title:this.getTitle(),resizable:true,draggable:true,content:[P],afterOpen:H.bind(this),afterClose:I.bind(this),buttons:[j,N]});this.setAggregation("_dialog",i,true);i.setModel(new sap.ui.model.resource.ResourceModel({bundleName:"sap/ui/mdc/messagebundle",async:false}),"$i18n");J.call(this,this.getShowConditionPanel());}return i;}function w(i,j,N,P,Q){D=i;B=j;V=N;b=P;this._bDialogRequested=false;if(!this._bIsBeingDestroyed){v.call(this);if(this._bOpen){this.open();delete this._bOpen;}}}function x(){var W=this.getContent();var i=this.getFilterBar();var j=new V(this.getId()+"-VHP",{height:"100%",showFilterbar:!!i,filterFields:this.getFilterFields()});if(W){W.initialize(false);y.call(this,j,W.getDialogContent());}if(i){j.setFilterbar(i);}j.initModel(this._oConditionModel);return j;}function y(i,j){i.setTable(j);}function z(i,W){var P=this.getAggregation("_popover");var j=this.getAggregation("_dialog");if(i==="remove"){W.detachEvent("navigate",f,this);W.detachEvent("selectionChange",g,this);W.detachEvent("dataUpdate",h,this);W=undefined;}else{W.attachEvent("navigate",f,this);W.attachEvent("selectionChange",g,this);W.attachEvent("dataUpdate",h,this);l.call(this);}this.fireDataUpdate();if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep);this._iStep=null;}else if(P){P.invalidate();var N=this.getFilterValue();if(N){n.call(this,N);}if(W&&W.getFilterEnabled()&&!this._oFilterConditionModel){q.call(this);}if(W&&this._bOpenIfContent){W.initialize(true);var Q=this._getField();if(Q){W.fieldHelpOpen(true);P.openBy(Q);}this._bOpenIfContent=false;}}else if(W&&this._bOpenIfContent){this._bOpenIfContent=false;this.open(true);}if(j){if(W){W.initialize(false);if(W.getFilterEnabled()&&!this._oFilterConditionModel){q.call(this);}var R=j.getContent()[0];y.call(this,R,W.getDialogContent());if(j.isOpen()){W.fieldHelpOpen(false);}}}}function A(){var i=this.getAggregation("_dialog");if(!i){i=v.call(this);}return i;}function E(i){this.close();var j=this._oConditionModel.getConditions(this.getFieldPath());j=c._removeEmptyConditions(j);var N;var P;if(j.length>0){N=j[0].values[0];P=j[0].values[1];}this._bNoConditionModelUpdate=true;this.setProperty("conditions",j,true);this.fireSelect({value:P,key:N,conditions:j,add:false});}function G(i){this.close();}function H(i){this._bDialogOpen=true;}function I(i){this._bDialogOpen=false;k.call(this,this.getConditions());var W=this.getContent();if(W){W.fieldHelpClose();}this._handleAfterClose();}function J(i){var j=this.getAggregation("_dialog");if(j&&this._oField){var N=j.getContent()[0];if(i&&this._oField._getOnlyEEQ&&!this._oField._getOnlyEEQ()){if(!N._oDefineConditionPanel){var P=new b(this.getId()+"-DCP");N.setDefineConditions(P);}}else{N.setDefineConditions();}}}function K(i,j){if(i==="remove"){j=undefined;}var N=this.getAggregation("_dialog");if(N){var P=N.getContent()[0];P.setFilterbar(j);P.setShowFilterbar(!!j);}}function L(){var W=this.getContent();if(W){return W.getSuggestionContent();}}return e;},true);
