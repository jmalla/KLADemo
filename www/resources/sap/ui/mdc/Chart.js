/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/mdc/Control','sap/m/Title','./ActionToolbar','sap/m/OverflowToolbarButton','sap/m/Button','sap/ui/base/ManagedObjectObserver','sap/ui/model/json/JSONModel','sap/ui/model/Sorter','sap/ui/mdc/library'],function(B,T,A,O,a,M,J,S,b){"use strict";var C,c,d,e,D,f;var g=B.extend("sap.ui.mdc.Chart",{metadata:{library:"sap.ui.mdc",defaultAggregation:"items",properties:{header:{type:"string",group:"Misc",defaultValue:null},chartType:{type:"string",group:"Misc",defaultValue:"column"},selectionMode:{type:"string",group:"Misc",defaultValue:"MULTIPLE"}},aggregations:{data:{multiple:true,forwarding:{idSuffix:"--innerChart",aggregation:"data",forwardBinding:true}},items:{type:"sap.ui.mdc.chart.Item",multiple:true},actions:{type:"sap.ui.core.Control",multiple:true,forwarding:{getter:"_createToolbar",aggregation:"actions"}},_chart:{type:"sap.chart.Chart",multiple:false},selectionDetailsActions:{type:"sap.ui.mdc.chart.SelectionDetailsActions",multiple:false}},events:{selectionDetailsActionPressed:{parameters:{action:{type:"sap.ui.core.Item"},itemContexts:{type:"sap.ui.model.Context"},level:{type:"sap.m.SelectionDetailsActionLevel"}}}}},renderer:function(r,o){r.write("<div");r.writeControlData(o);r.writeAccessibilityState(o);r.writeClasses();if(o.getHeight()){r.addStyle("height",o.getHeight());}if(o.getWidth()){r.addStyle("width",o.getWidth());}r.writeStyles();r.write(">");if(o._oToolbar){r.renderControl(o._oToolbar);}var h=o.getAggregation("_chart");if(h){r.renderControl(h);}r.write("</div>");},init:function(){this.setModel(new J({sorters:[]}),"$sapuimdcchartSorter");this._oObserver=new M(this.update.bind(this));this._oObserver.observe(this,{aggregations:["items","_chart"]});},applySettings:function(s){s=s||{};var o=s.data||null;delete s.data;this.oChartPromise=this._getLibraryPromise().then(function(){if(!this._bIsBeingDestroyed){return this._createInnerChart(s,o);}else{return null;}}.bind(this));B.prototype.applySettings.apply(this,[s]);},_createInnerChart:function(s,o){var I={},h,m=[],j=[],v=[];I.chartType=s.chartType;I.dimensions=[];I.measures=[];I.id=this.getId()+"--innerChart";s.items=s.items||[];function k(V){if(this.getType()=="Measure"){I.measures.push(V);m.push(this.getName());}else{I.dimensions.push(V);j.push(this.getName());}}for(var i=0;i<s.items.length;i++){h=s.items[i];v.push(h.toVizChartItem().then(k.bind(h)));}return Promise.all(v).then(function(){var l=new C(I);this._oObserver.observe(l,{bindings:["data"],aggregations:["dimensions","measures"]});this.setAggregation("_chart",l);if(o){this.bindAggregation("data",o);}this._createToolbar();return l;}.bind(this));},setSelectionMode:function(v){var o=this.getAggregation("_chart");if(o){o.setSelectionMode(v);if(v!=="NONE"){this._prepareSelection();}}else{this.oChartPromise.then(function(o){o.setSelectionMode(v);if(v!=="NONE"){this._prepareSelection();}}.bind(this));}return this.setProperty("selectionMode",v,true);},setChartType:function(v){var o=this.getAggregation("_chart");if(o){o.setChartType(v);}else{this.oChartPromise.then(function(o){if(o){o.setChartType(v);}});}return this.setProperty("chartType",v,true);},setHeight:function(v){var o=this.getAggregation("_chart");if(o){o.setHeight(v);}else{this.oChartPromise.then(function(o){if(o){o.setHeight(v);}});}return this.setProperty("height",v,true);},setWidth:function(v){var o=this.getAggregation("_chart");if(o){o.setWidth(v);}else{this.oChartPromise.then(function(o){if(o){o.setWidth(v);}});}return this.setProperty("width",v,true);},_getLibraryPromise:function(){if(!this.oChartLibPromise){this.oChartLibPromise=new Promise(function(r,h){if(!C){sap.ui.require(["sap/chart/Chart","sap/ui/mdc/chart/ChartTypeButton"],function(g,i){C=g;f=i;c=sap.ui.getCore().getLibraryResourceBundle("sap.chart.messages");d=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");r(true);});}else{r(true);}});}return this.oChartLibPromise;},addItem:function(i,s){var o=this.getAggregation("_chart");if(o){i.toChart(o);}else{this.oChartPromise.then(function(o){if(o){this.toChart(o);}}.bind(i));}this._oObserver.observe(i,{properties:["visible","inResult","role"]});return this.addAggregation("items",i,s);},insertItem:function(i,I,s){var o=this.getAggregation("_chart");if(o){i.toChart(o);}else{this.oChartPromise.then(function(o){if(o){this.toChart(o);}}.bind(i));}this._oObserver.observe(i,{properties:["visible","inResult","role"]});return this.insertAggregation("items",i,I,s);},removeItem:function(i,s){this._oObserver.unobserve(i);return this.removeAggregation("items",i,s);}});g.prototype.exit=function(){var o=this.getAggregation("_chart");if(o){o.destroy();}else{this._bIsBeingDestroyed=true;this.oChartPromise.then(function(o){o?o.destroy():null;});}if(this._oToolbar){this._oToolbar.destroy();this._oToolbar=null;this._oTitle=null;}};g.prototype._createToolbar=function(){if(!this._oToolbar){this._oTitle=new T(this.getId()+"-title",{text:this.getHeader()});this._oDrillDownBtn=new a(this.getId()+"-drillDown",{text:"View By",tooltip:"View By",press:[this._showDrillDown,this]});this._oSettingsBtn=new O(this.getId()+"-chart_settings",{icon:"sap-icon://action-settings",tooltip:d.getText('chart.PERSONALIZATION_DIALOG_TITLE'),press:function(){sap.ui.require(["sap/ui/mdc/chart/P13nController","sap/ui/fl/FlexControllerFactory"],function(P,F){F.createForControl(this).waitForChangesToBeApplied(this).then(function(){var p=this._getP13nState("chart");P.showChartDialog(p.chart.initData,p.chart.runtimeData,this);}.bind(this));}.bind(this));}.bind(this)});this._oToolbar=new A(this.getId()+"-toolbar",{design:"Transparent",left:[this._oTitle],right:[this._oDrillDownBtn,this._oSettingsBtn,new f(this)]});}return this._oToolbar;};g.prototype._showDrillDown=function(){if(D){if(!this._oDrillDownPopover){D.createDrillDownPopover(this);}D.showDrillDownPopover(this,this.getMetadataDelegate());}else{sap.ui.require(["sap/ui/mdc/chart/DrillStackHandler"],function(h){D=h;D.createDrillDownPopover(this);D.showDrillDownPopover(this,this.getMetadataDelegate());}.bind(this));}};g.prototype._getP13nState=function(p){var P={};var m=this.DELEGATE.retrieveAllMetadata(this);if(!p||p==="chart"){var o={Dimension:[{key:b.ChartItemRoleType.category,text:d.getText('chart.PERSONALIZATION_DIALOG_CHARTROLE_CATEGORY')},{key:b.ChartItemRoleType.category2,text:d.getText('chart.PERSONALIZATION_DIALOG_CHARTROLE_CATEGORY2')},{key:b.ChartItemRoleType.series,text:d.getText('chart.PERSONALIZATION_DIALOG_CHARTROLE_SERIES')}],Measure:[{key:b.ChartItemRoleType.axis1,text:d.getText('chart.PERSONALIZATION_DIALOG_CHARTROLE_AXIS1')},{key:b.ChartItemRoleType.axis2,text:d.getText('chart.PERSONALIZATION_DIALOG_CHARTROLE_AXIS2')},{key:b.ChartItemRoleType.axis3,text:d.getText('chart.PERSONALIZATION_DIALOG_CHARTROLE_AXIS3')}],Aggregatable:[{key:b.ChartItemRoleType.category,text:d.getText('chart.PERSONALIZATION_DIALOG_CHARTROLE_CATEGORY')},{key:b.ChartItemRoleType.category2,text:d.getText('chart.PERSONALIZATION_DIALOG_CHARTROLE_CATEGORY2')},{key:b.ChartItemRoleType.series,text:d.getText('chart.PERSONALIZATION_DIALOG_CHARTROLE_SERIES')},{key:b.ChartItemRoleType.axis1,text:d.getText('chart.PERSONALIZATION_DIALOG_CHARTROLE_AXIS1')},{key:b.ChartItemRoleType.axis2,text:d.getText('chart.PERSONALIZATION_DIALOG_CHARTROLE_AXIS2')},{key:b.ChartItemRoleType.axis3,text:d.getText('chart.PERSONALIZATION_DIALOG_CHARTROLE_AXIS3')}]};var s=d.getText('chart.PERSONALIZATION_DIALOG_TYPE_DIMENSION');var h=d.getText('chart.PERSONALIZATION_DIALOG_TYPE_MEASURE');var r={Dimension:[{key:b.ChartItemRoleType.category,text:s},{key:b.ChartItemRoleType.category2,text:s},{key:b.ChartItemRoleType.series,text:s}],Measure:[{key:b.ChartItemRoleType.axis1,text:h},{key:b.ChartItemRoleType.axis2,text:h},{key:b.ChartItemRoleType.axis3,text:h}],Aggregatable:[{key:b.ChartItemRoleType.category,text:s},{key:b.ChartItemRoleType.category2,text:s},{key:b.ChartItemRoleType.series,text:s},{key:b.ChartItemRoleType.axis1,text:h},{key:b.ChartItemRoleType.axis2,text:h},{key:b.ChartItemRoleType.axis3,text:h}]};var i=this.getAvailableChartTypes();P.chart={initData:{chartType:m.chartType,items:m.items.map(function(k){return{id:undefined,key:k.name,text:k.label,tooltip:k.label,visible:k.visible?k.visible:false,role:k.role,availableRoles:o[k.kind],roleDependentTypes:r[k.kind]};})},runtimeData:{chartType:this.getChartType(),availableChartTypes:i,items:this.getItems().map(function(I){return{id:I.getId(),key:I.getName(),text:I.getLabel(),tooltip:I.getLabel(),visible:I.getVisible(),role:I.getRole(),availableRoles:o[I.getType()],roleDependentTypes:r[I.getType()]};})}};}if(!p||p==="sort"){var G=function(k){var l=m.items.filter(function(n){return n.name===k;});return l.length?l[0].label:undefined;};var j=this.getBinding("data");P.sort={initData:{items:m.items.map(function(k){return{key:k.name,text:k.label,tooltip:k.label,sortOrder:undefined};})},runtimeData:{items:j.aSorters.map(function(k){return{key:k.sPath,text:G(k.sPath),tooltip:G(k.sPath),sortOrder:k.bDescending?"Descending":"Ascending",selected:true};})}};}return P;};g.prototype.getAvailableChartTypes=function(){var h=[];var o=this.getAggregation("_chart");if(o){var j=o.getAvailableChartTypes().available;if(h){for(var i=0;i<j.length;i++){var t=j[i].chart;h.push({key:t,icon:f.mMatchingIcon[t],text:c.getText("info/"+t),selected:(t==this.getChartType())});}}}return h;};g.prototype.getTypeInfo=function(){var t=this.getChartType();var i={icon:f.mMatchingIcon[t],text:d.getText("chart.CHART_TYPE_TOOLTIP",[t])};return i;};g.prototype.update=function(o){var h=this.getAggregation("_chart");if(h){this._update(h);}else{this.oChartPromise.then(function(h){if(h){this._update(h);}}.bind(this));}};g.prototype._update=function(o){var I=this.getItems(),v,h,V=[],j=[],k=[];for(var i=0;i<I.length;i++){h=I[i];v=(o.getMeasureByName(h.getName())||o.getDimensionByName(h.getName()));if(!v){continue;}if(h.getVisible()){if(h.getType()=="Measure"){V.push(h.getName());}else{j.push(h.getName());}}if(h.getType()=="Dimension"){if(h.getInResult()){k.push(h.getName());}}}o.setVisibleDimensions(j);o.setVisibleMeasures(V);o.setInResultDimensions(k);};g.prototype._prepareSelection=function(){if(e){e.prepareChart(this);}else{if(!this.oSelectionHandlerPromise){this.oSelectionHandlerPromise=new Promise(function(r,h){sap.ui.require(["sap/ui/mdc/chart/SelectionHandler"],function(i){e=i;r(true);});});}this.oSelectionHandlerPromise.then(function(){e.prepareChart(this);}.bind(this));}};g.prototype.addSorter=function(m){var o=this.getModel("$sapuimdcchartSorter");var h=o.getProperty("/sorters");h.push(m);o.setProperty("/sorters",h);};g.prototype.removeSorter=function(p){var m=this.getModel("$sapuimdcchartSorter");var h=m.getProperty("/sorters").filter(function(o){return o.path!==p;});m.setProperty("/sorters",h);};g.prototype.moveSorter=function(p,r){var G=function(v,i){var E=i.filter(function(j){return j.path!==undefined&&j.path===v;});return E.length?E[0]:null;};var m=this.getModel("$sapuimdcchartSorter");var h=m.getProperty("/sorters");var o=G(p,h);h.splice(h.indexOf(o),1);h.splice(r,0,o);m.setProperty("/sorters",h);};g.prototype._rebind=function(){var o=this.getBinding("data");var s=this.getModel("$sapuimdcchartSorter").getProperty("/sorters").map(function(m){return new S(m.path,m.sortOrder==="Descending");});o.sort(s);};return g;},true);
