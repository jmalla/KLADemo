sinaDefine(['../../core/core','../../core/util','./typeConverter','../tools/fiori/FioriIntentsResolver','../../sina/NavigationTarget'],function(c,u,t,I,N){"use strict";return c.defineClass({_init:function(p){this.provider=p;this.sina=p.sina;this.intentsResolver=this.sina._createFioriIntentsResolver();this.suvNavTargetResolver=this.sina._createSuvNavTargetResolver();},parse:function(s,d){if(d.value===null){return Promise.resolve([]);}var a=d.value;var b=[];for(var i=0;i<a.length;++i){var e=a[i];var f=this.parseItem(e);b.push(f);}return Promise.all(b);},parseItem:function(a){var i;var b=[];var d=[];var e="";var f,g;var h={};var j;var k={};var l=[];var m=[];var s={};var n={};var o=a['@odata.context'];var p=o.lastIndexOf('#');if(p>-1){o=o.slice(p+1);}var q=this.sina.getDataSource(o);var w=a['@com.sap.vocabularies.Search.v1.WhyFound']||{};var r={};var v='';var x={};var y,z,A,B;var C=[];var D;var E=a["@com.sap.vocabularies.Search.v1.Ranking"];for(var F in a){if(F[0]==='@'||F[0]==='_'){continue;}r=q.getAttributeMetadata(F);if(r.id=="LOC_4326"){r.usage={Detail:{displayOrder:-1}};}var G=t.odata2Sina(r.type,a[F]);var H=G?G.toString():'';var J="";for(var K in w){if(K===F&&w[K][0]){J=w[K][0];delete w[K];}}j=this.sina._createSearchResultSetItemAttribute({id:r.id,label:r.label,value:G,valueFormatted:H,valueHighlighted:J||H,isHighlighted:J.length>0?true:false,metadata:r});if(r.isUnitOfMeasure||r.isCurrency){h[j.id]=j;continue;}if(r.unitOfMeasureAttribute){g=h[r.unitOfMeasureAttribute.id];if(g){j.unitOfMeasure=g;}else{l.push(j);}}if(r.descriptionAttribute){f=k[r.descriptionAttribute.id];if(f){j.description=f;}else{m.push(j);}}if(r.suvUrlAttribute&&r.suvMimeTypeAttribute){A=k[r.suvUrlAttribute]||r.suvUrlAttribute.id;B=k[r.suvMimeTypeAttribute]||r.suvMimeTypeAttribute.id;x[r.id]={suvThumbnailAttribute:j,suvTargetUrlAttribute:A,suvTargetMimeTypeAttribute:B};}if(r.usage.Title){b.push(j);}if(r.usage.TitleDescription){e=j.valueHighlighted;}if(r.group){var L=n[r.group.id];if(!L){L=this.sina._createSearchResultSetItemAttributeGroup({id:r.group.id,metadata:r.group,label:r.group.label,template:r.group.template,attributes:{}});n[r.group.id]=L;if(r.group.usage.Detail){d.push(L);}}L.attributes[r.nameInGroup]=j;j.group=L;j.nameInGroup=r.nameInGroup;}else{if(r.usage.Detail){d.push(j);}}if(r.usage.Navigation){if(r.usage.Navigation.mainNavigation){D=this.sina._createNavigationTarget({label:j.value,targetUrl:j.value});}}k[j.id]=j;v=q.attributeMetadataMap[r.id].semanticObjectType||'';if(v.length>0){s[v]=G;}}for(i=0;i<l.length;i++){j=l[i];r=q.getAttributeMetadata(j.id);if(r.unitOfMeasureAttribute){g=h[r.unitOfMeasureAttribute.id];if(g){j.unitOfMeasure=g;}}}for(i=0;i<m.length;i++){j=m[i];r=q.getAttributeMetadata(j.id);if(r.descriptionAttribute){f=k[r.descriptionAttribute.id];if(f){j.description=f;}}}for(z in x){y=x[z];if(typeof y.suvTargetUrlAttribute=="string"){y.suvTargetUrlAttribute=k[y.suvTargetUrlAttribute];}if(typeof y.suvTargetMimeTypeAttribute=="string"){y.suvTargetMimeTypeAttribute=k[y.suvTargetMimeTypeAttribute];}if(!(y.suvTargetUrlAttribute||y.suvTargetMimeTypeAttribute)){delete x[z];}}b.sort(function(T,U){return T.metadata.usage.Title.displayOrder-U.metadata.usage.Title.displayOrder;});d.sort(function(T,U){return T.metadata.usage.Detail.displayOrder-U.metadata.usage.Detail.displayOrder;});for(var M in w){if(w[M][0]){r=q.getAttributeMetadata(M);j=this.sina._createSearchResultSetItemAttribute({id:r.id||M,label:r.label||M,value:null,valueFormatted:w[M][0],valueHighlighted:w[M][0],isHighlighted:true,metadata:r});d.push(j);delete w[M];}}var O=[];var P=[];for(i=0;i<b.length;++i){var Q=b[i];O.push(Q.valueFormatted);P.push(Q.valueHighlighted);}O=O.join(' ');P=P.join(' ');this.suvNavTargetResolver.resolveSuvNavTargets(q,x,C);v=q.sematicObjectType||'';var R=q.system||'';var S=q.client||'';return this.intentsResolver.resolveIntents({semanticObjectType:v,semanticObjectTypeAttributes:s,systemId:R,client:S,fallbackDefaultNavigationTarget:D}).then(function(T){var U=T&&T.defaultNavigationTarget;var V=T&&T.navigationTargets;return this.sina._createSearchResultSetItem({dataSource:q,title:O,titleHighlighted:P,titleAttributes:b,titleDescription:e,detailAttributes:d,defaultNavigationTarget:U,navigationTargets:V,score:E});}.bind(this));}});});
