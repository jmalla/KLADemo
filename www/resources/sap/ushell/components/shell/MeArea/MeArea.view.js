// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/AppType","sap/m/Button","sap/m/List","sap/m/Text","sap/m/VBox","sap/m/HBox","sap/m/Image","sap/m/Dialog","sap/m/Popover","sap/m/OverflowToolbar","sap/m/ScrollContainer","sap/ushell/renderers/fiori2/AccessKeysHandler","sap/ushell/resources","sap/ushell/ui/launchpad/UserStatusItem","sap/ushell/ui/launchpad/AccessibilityCustomData","sap/m/library","sap/ui/Device","sap/ui/core/Icon","sap/ui/core/IconPool","sap/ui/core/service/ServiceFactoryRegistry"],function(a,B,L,T,V,H,I,D,P,O,S,A,r,U,b,m,c,d,e,f){"use strict";var g=m.BackgroundDesign,h=m.ButtonType,j=m.ListSeparators,k=m.ListType,l=m.PlacementType,n=m.ToolbarDesign;sap.ui.jsview("sap.ushell.components.shell.MeArea.MeArea",{createContent:function(C){this.addStyleClass('sapUshellMeAreaView');this.aDanglingControls=[];var u=sap.ushell.Container.getUser().getFullName(),p,t=r.i18n,o=(this.getViewData()?this.getViewData().config:{})||{},s=o.appState,q=(s==='embedded'||s==='embedded-home'||s==='standalone'||s==='blank-home'||s==='blank'),w,x=f.get("sap.ushell.ui5service.UserStatus");if(x){var y=x.createInstance(),z=function(i){y.then(function(x){x.setStatus(i);p.close();});};}w=[new U({status:U.prototype.STATUS_ENUM.AVAILABLE,id:"userStatusItem1",isOpener:false,press:function(i){z(sap.ushell.ui5service.UserStatus.prototype.AvailableStatus.AVAILABLE);}.bind(this)}).addStyleClass('sapUserStatusContainer'),new U({status:U.prototype.STATUS_ENUM.AWAY,id:"userStatusItem2",isOpener:false,press:function(i){z(sap.ushell.ui5service.UserStatus.prototype.AvailableStatus.AWAY);}.bind(this)}).addStyleClass('sapUserStatusContainer'),new U({status:U.prototype.STATUS_ENUM.BUSY,id:"userStatusItem3",isOpener:false,press:function(i){z(sap.ushell.ui5service.UserStatus.prototype.AvailableStatus.BUSY);}.bind(this)}).addStyleClass('sapUserStatusContainer'),new U({status:U.prototype.STATUS_ENUM.APPEAR_OFFLINE,id:"userStatusItem4",isOpener:false,press:function(i){z(sap.ushell.ui5service.UserStatus.prototype.AvailableStatus.APPEAR_OFFLINE);}.bind(this)}).addStyleClass('sapUserStatusContainer')];if(!o.disableSignOut){w.push(new U({status:U.prototype.STATUS_ENUM.SIGNOUT,id:"userStatusLogout",isOpener:false,press:[C.logout,C]}).addStyleClass('sapUserStatusSignOutContainer'));}var E=new L({id:"sapUshellUserStatusItemList",showSeparators:"None",items:w});E.addCustomData(new b({key:"aria-labelledBy",value:"userStatusItem1",writeToDom:true}));p=new P("statuses",{placement:l.Bottom,showArrow:false,showHeader:false,content:E}).addStyleClass('sapUserStatusPopOver');p.addStyleClass("sapContrastPlus");p.setOffsetX(-3);w=[new T({text:u}).addStyleClass('sapUshellMeAreaUserName')];var F=new U({id:"userStatusOpener",visible:{parts:["/userStatusEnabled","/userStatusUserEnabled"],formatter:function(i,v){if(i&&v){return true;}return false;}.bind(this)},status:{path:"/userStatus",formatter:function(i){return U.prototype.STATUS_ENUM[i];}.bind(this)},tooltip:t.getText("userStatus_tooltip"),image:e.getIconURI("account"),press:function(i){var v=sap.ui.getCore().byId(i.mParameters.id);if(p.isOpen()){p.close();}else{p.openBy(v);}}.bind(this),contentList:p}).addStyleClass('sapUserStatusOpener');F.addCustomData(new b({key:"tabindex",value:"0",writeToDom:true}));F.addCustomData(new b({key:"aria-label",value:r.i18n.getText("OnlineStatus")+" "+t.getText("userStatus_tooltip"),writeToDom:true}));F.addCustomData(new b({key:"role",value:"listbox",writeToDom:true}));var G=new L({items:[F],backgroundDesign:g.Transparent});w.push(G);if(!o.disableSignOut){var J;if(!q){J=new B("logoutBtn",{visible:{parts:["/userStatusEnabled","/userStatusUserEnabled"],formatter:function(i,v){if(i&&v){return false;}return true;}.bind(this)},type:h.Transparent,icon:'sap-icon://log',text:r.i18n.getText("signoutBtn_title"),press:[C.logout,C]});w.push(J);}else{J=new sap.ushell.ui.launchpad.ActionItem("logoutBtn",{visible:true,type:h.Transparent,icon:'sap-icon://log',text:r.i18n.getText("signoutBtn_title"),press:[C.logout,C]});}}var K=new V({items:[w]}).addStyleClass("sapUshellUserArea");var M=sap.ushell.Container.getUser(),N=M.getImage(),Q;if(!N){Q=this.createPlaceHolderIcon();}else{Q=this.createNewImage();}Q.addStyleClass("sapUshellMeAreaUserImage");var R=new H({items:[Q,K]});M.attachOnSetImage(this._updateUserImage.bind({origScope:this,oUserHBox:R,userBoxItem:Q}));R.addStyleClass('sapUshellMeAreaUserInfo');R.addStyleClass('sapContrastPlus');var W=C.createSaveButton(),X=C.createCancelButton();this.oSettingsDialog=new D({id:"userSettingsDialog",showHeader:false,content:null,contentHeight:"42rem",contentWidth:"58rem",buttons:[W,X],afterClose:function(){sap.ushell.Container.getUser().resetChangedProperties();},stretch:c.system.phone}).addStyleClass("sapUshellUserSetting");this.oSettingsDialog.addContent(C.getSettingsDialogContent());this.oSettingsDialog.addEventDelegate({onkeydown:function(i){if(i.keyCode===27){if(C&&typeof C._dialogCancelButtonHandler==="function"){C._dialogCancelButtonHandler();}}}.bind(this)});this.aDanglingControls.push(X,W,this.oSettingsDialog);R.addEventDelegate({onsapskipback:function(i){i.preventDefault();A.setIsFocusHandledByAnotherHandler(true);A.sendFocusBackToShell(i);},onsaptabprevious:function(i){i.preventDefault();A.setIsFocusHandledByAnotherHandler(true);A.sendFocusBackToShell(i);}});var Y=new O({id:"overflowActions",design:n.Transparent,content:{path:"/currentState/actions",factory:function(i,v){var c1=sap.ui.getCore().byId(v.getObject());if(c1){var d1=c1.isA("sap.ushell.ui.shell.ShellHeadItem");if(d1){return undefined;}if(c1.setActionType){c1.setActionType("action");c1.addStyleClass('sapContrastPlus');}C._addPressHandlerToActions(c1);}return c1;}}});Y._getOverflowButtonSize=function(){return 82.4;};Y.addCustomData(new b({key:"aria-label",value:r.i18n.getText("overflowActions_AriaLabel"),writeToDom:true}));if(Y._getOverflowButton){var Z=Y._getOverflowButton();if(Z){var $=Z.onAfterRendering;Z.onAfterRendering=function(){if($){$.apply(this,arguments);}this.addStyleClass('sapUshellActionItem').addStyleClass('sapContrastPlus');this.setText(r.i18n.getText('meAreaMoreActions'));};}}Y.updateAggregation=function(c1){var d1=this.mBindingInfos[c1],e1=this.getMetadata().getJSONKeys()[c1],f1;jQuery.each(this[e1._sGetter](),jQuery.proxy(function(i,v){this[e1._sRemoveMutator](v);},this));jQuery.each(d1.binding.getContexts(),jQuery.proxy(function(i,v){f1=d1.factory(this.getId()+"-"+i,v);if(f1){this[e1._sMutator](f1.setBindingContext(v,d1.model));}},this));};var _=new V("sapUshellMeAreaContent",{});this.actionBox=Y;_.addItem(R);_.addItem(Y);if(o.enableRecentActivity){var a1=sap.ushell.Container.getRenderer("fiori2").oShellModel.getModel().getProperty('/currentState/showRecentActivity');if(a1===true){var b1=this.createIconTabBar(C);b1.done(function(i){_.addItem(i);var v=sap.ushell.Container.getRenderer("fiori2").oShellModel.getModel().getProperty("/enableTrackingActivity");i.setVisible(v);});}}this.actionBox.addEventDelegate({onsaptabnext:function(i){var v=i.originalEvent,c1=v.srcElement,d1=jQuery('.sapUshellActionItem:last')[0].id,e1,f1;f1=sap.ui.getCore().byId('meAreaIconTabBar').getVisible();e1=d1===c1.id;if(e1===true&&!f1){i.preventDefault();A.setIsFocusHandledByAnotherHandler(true);A.sendFocusBackToShell(i);}},onsapskipforward:function(i){var v=sap.ui.getCore().byId('meAreaIconTabBar').getVisible();if(!v){i.preventDefault();A.setIsFocusHandledByAnotherHandler(true);A.sendFocusBackToShell(i);}}});return new S({vertical:true,horizontal:false,height:"100%",content:_});},createIconTabBar:function(C){var R=new jQuery.Deferred(),t=this,i,o,p;sap.ui.require(['sap/m/IconTabBar','sap/m/CustomListItem','sap/m/IconTabFilter','sap/m/Text','sap/m/HBox'],function(q,s,u,T,H){i=new q('meAreaIconTabBar',{backgroundDesign:g.Transparent,expandable:false,items:[t.createIconTab("recentActivities",true,C,s,u,T,H),t.createIconTab("frequentActivities",false,C,s,u,T,H)]}).addStyleClass('sapUshellMeAreaTabBar');i.addEventDelegate({onsaptabnext:function(E){var v=E.originalEvent,w=v.srcElement,x=w.classList,y;y=jQuery.inArray('sapUshellMeAreaActivityItem',x)>-1;if(y===true){E.preventDefault();A.setIsFocusHandledByAnotherHandler(true);A.sendFocusBackToShell(E);}},onsapskipforward:function(E){E.preventDefault();A.setIsFocusHandledByAnotherHandler(true);A.sendFocusBackToShell(E);}});o=i.onAfterRendering;i.onAfterRendering=function(){if(o){o.apply(t,arguments);}p=sap.ui.getCore().byId('meAreaIconTabBar--header');if(p){p.addStyleClass('sapContrastPlus');p.addStyleClass('sapUshellTabBarHeader');}};R.resolve(i);});return R.promise();},createIconTab:function(i,s,C,o,p,T,H){var q,t,u,v,w,x,y,M,z,E;q=function(F,G){t=G.getProperty("icon");u=G.getProperty("title");v=a.getDisplayName(G.getProperty("appType"));var J=new T({text:u}).addStyleClass('sapUshellMeAreaActivityItemTitle'),K=t?new d({src:t}).addStyleClass('sapUshellMeAreaActivityItemIcon'):null,N=new T({text:v}).addStyleClass('sapUshellMeAreaActivityItemDescription'),Q=new T({text:s?G.getProperty("timestamp"):""}).addStyleClass('sapUshellMeAreaActivityItemInfo'),R=new H({items:K?[K,N]:[N],justifyContent:"SpaceBetween"}),W=new H({items:s?[R,Q]:[R],justifyContent:"SpaceBetween"}).addStyleClass('sapUshellMeAreaActivityItemContainer');w=new o({content:[J,W],type:k.Active}).addStyleClass('sapUshellMeAreaActivityItem');w.addCustomData(new b({key:"aria-describedby",value:x.getId(),writeToDom:true}));return w;};x=new p({id:"sapUshellIconTabBar"+i,text:r.i18n.getText(i)});y=new L({id:"sapUshellActivityList"+i,showSeparators:j.All,items:{path:"meAreaModel>/apps/"+i,factory:q.bind(this)},noDataText:r.i18n.getText(i+'NoDataText'),itemPress:function(F){M=this.getModel('meAreaModel');E=sap.ui.getCore().byId("viewPortContainer");if(E){E.switchState("Center");}z=F.getParameter('listItem').getBindingContextPath();C.setLastVisited(M.getProperty(z).url);setTimeout(function(){var R={},G=sap.ushell.Container.getRenderer("fiori2");if(M.getProperty(z).url[0]==='#'){hasher.setHash(M.getProperty(z).url);}else{R.title=M.getProperty(z).title;R.appType="App";R.url=M.getProperty(z).url;R.appId=M.getProperty(z).url;G.logRecentActivity(R);window.open(M.getProperty(z).url,'_blank');}},200);}});x.addContent(y);return x;},onViewStateShow:function(){this.getController().refreshRecentActivities();this.getController().refreshFrequentActivities();if(this.actionBox){this.actionBox.updateAggregation("content");}this.getController().updateScrollBar(hasher.getHash());},createNewImage:function(){return new I({src:'{/userImage/personPlaceHolder}'});},createPlaceHolderIcon:function(){return new d({src:'{/userImage/personPlaceHolder}',size:'4rem'});},getControllerName:function(){return"sap.ushell.components.shell.MeArea.MeArea";},_updateUserImage:function(o){var u=(typeof o)==='string'?o:o.mParameters;this.oUserHBox.removeItem(this.userBoxItem);if((typeof u)==='string'){this.userBoxItem=this.origScope.createNewImage();}else{this.userBoxItem=this.origScope.createPlaceHolderIcon();}if(this.oUserHBox){this.oUserHBox.insertItem(this.userBoxItem,0);if(this.userBoxItem){this.userBoxItem.addStyleClass("sapUshellMeAreaUserImage");}}}});},false);
