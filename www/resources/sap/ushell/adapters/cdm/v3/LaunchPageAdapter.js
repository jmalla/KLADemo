// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/adapters/cdm/v3/_LaunchPage/readHome","sap/ushell/adapters/cdm/_LaunchPage/modifyHome","sap/ushell/adapters/cdm/v3/_LaunchPage/readCatalogs","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/m/GenericTile","sap/m/library","sap/ui/core/ComponentContainer","sap/ushell/adapters/cdm/_LaunchPage/uri.transform","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/navigationMode","sap/ushell/resources","sap/ushell/utils","sap/ushell/adapters/cdm/v3/utilsCdm","sap/base/util/Version","sap/base/Log"],function(r,m,R,o,G,M,C,u,a,E,n,b,U,c,V,L){"use strict";var l=jQuery.sap.log.getLogger("sap/ushell/adapters/cdm/LaunchPageAdapter"),d=jQuery.sap.log.Level;var g=M.GenericTileMode;function f(h,p,A){var _,s="sap.ushell.components.tiles.cdm.applauncher",D="sap.ushell.components.tiles.cdm.applauncherdynamic";this._mResolvedTiles={};this._mCatalogTilePromises={};this._mFailedResolvedCatalogTiles={};this._mFailedResolvedTiles={};this._mContentProviders={};this.getCdmVersionsSupported=function(){return{"min":V("3.0.0"),"max":V("3.0.0")};};this.isSiteSupported=function(S){if(!S._version||V(S._version).compareTo(this.getCdmVersionsSupported()["min"])<0||V(S._version).compareTo(this.getCdmVersionsSupported()["max"])>0){L.fatal("Invalid CDM site version: Only version 3.0.0 is supported");return false;}return true;};this.TileType={Tile:"tile",Link:"link"};this.getGroups=function(){var e=new jQuery.Deferred();this._assureLoaded().done(function(B){U.setPerformanceMark("FLP - homepage groups processed");e.resolve(B);}).fail(function(){e.resolve([]);});return e.promise();};this._getTileFromHashInContextOfSite=function(e,B,I){var F=new jQuery.Deferred(),H=B[I];if(!H){H=e(I);B[I]=H;}H.done(function(T){var J={tileIntent:I,tileResolutionResult:T};F.resolve(J);}).fail(function(J){F.reject("Hash '"+I+"' could not be resolved to a tile. "+J);});return F.promise();};this._getTileFromHash=function(I){var e=sap.ushell.Container.getService("ClientSideTargetResolution");var B=e.resolveTileIntent.bind(e);return this._getTileFromHashInContextOfSite(B,this._mCatalogTilePromises,I);};this._getTileFromHashFromSite=function(S,I){var e=sap.ushell.Container.getService("ClientSideTargetResolution");var B=c.formatSite(S);var F=e.resolveTileIntentInContext.bind(e,B);var H={};return this._getTileFromHashInContextOfSite(F,H,I);};this._getTileForUrl=function(T){var e=T.indicatorDataSource?"#Shell-dynamicTile":"#Shell-staticTile";return{tileIntent:"#",tileResolutionResult:{tileComponentLoadInfo:e,isCustomTile:false}};};this._assureGroupItemsResolved=function(e,S){var P=[],B,F;if(e.payload&&e.payload.tiles){B=this._assureGroupTilesResolved(e.payload.tiles,S);Array.prototype.push.apply(P,B);}if(e.payload&&e.payload.links){F=this._assureGroupLinksResolved(e.payload.links,S);Array.prototype.push.apply(P,F);}return P;};this._assureGroupTilesResolved=function(e,S){return(e||[]).map(function(T,I){return this._resolveGroupTile(T,S).then(function(B){B.isLink=false;return B;});},this);};this._assureGroupLinksResolved=function(e,S){return(e||[]).map(function(B,I){return this._resolveGroupTile(B,S).then(function(F){F.isLink=true;return F;});},this);};this._resolveGroupTile=function(T,S){var e=this._mResolvedTiles;var F=this._mFailedResolvedTiles;var B;function H(J){e[T.id]=J;if(F[T.id]){delete F[T.id];}return J;}function I(T){var J=T.target;return J&&J.semanticObject==="Shell"&&J.action==="launchURL";}if(e[T.id]){return(new jQuery.Deferred()).resolve(e[T.id]).promise();}if(T.target&&T.target.url){B=jQuery.when(this._getTileForUrl(T));}else if(T.isBookmark){B=this._resolveTileByIntent(T,S);}else if(I(T)){B=this._resolveTileByIntent(T,S);}else{B=this._resolveTileByVizId(T,S);}B.done(function(J){H(J);}).fail(function(J){F[T.id]=J;});return B;};this._resolveTileByVizId=function(T,S){var e,B,F,H,I,J,K,N,O,P,Q,W,X;function Y(d1,e1){return new jQuery.Deferred().reject({logLevel:d1,message:e1}).promise();}if(!jQuery.isPlainObject(S)){return Y(d.ERROR,"Cannot resolve tile: oSite must be an object");}if(!jQuery.isPlainObject(T)){return Y(d.ERROR,"Cannot resolve tile: oTile must be an object");}B=T.vizId;if(!B){return Y(d.ERROR,["Cannot resolve tile '",T.id,"': vizId must be specified"].join(""));}e=o.get(S,B);H=o.getTypeId(e);F=o.getType(S,H);I=o.getAppId(e);if(I){J=o.getAppDescriptor(S,I);if(!J){return Y(d.INFO,["Tile '",T.id,"' filtered from result: no app descriptor found for appId '",I,"' (dangling app reference)"].join(""));}K=r.getInbound(J,o.getTarget(e).inboundId);if(!K){return Y(d.ERROR,["Cannot resolve tile '",T.id,"': app '",I,"' has no navigation inbound"].join(""));}N=c.mapOne(K.key,K.inbound,J,e,F);var Z=N.resolutionResult.applicationType,$=N.resolutionResult.additionalInformation,a1=a.last("/core/navigation/enableInPlaceForClassicUIs"),b1=a1?a1[Z]:false;O=n.computeNavigationModeForHomepageTiles(Z,$,b1);W=o.getOutbound(e,K.inbound);Q=this._toHashFromOutbound(W);}else{var c1=o.getConfig(e);if(c1==undefined){return Y(d.INFO,["Tile '",T.id,"' filtered from result: Neither target app nor configuration given in visualization '",B,"'"].join(""));}N=c.mapOne(undefined,undefined,undefined,e,F);if(o.startsExternalUrl(e)){X=U.getMember(c1,"sap|flp.target.url");}}P=N.tileResolutionResult;P.navigationMode=O;P.isLink=false;if(!this._isFormFactorSupported(P)){return Y(d.INFO,["Tile '",T.id,"' filtered from result: form factor not supported"].join(""));}return jQuery.when({tileResolutionResult:P,tileIntent:X||Q});};this._isFormFactorSupported=function(e){var B=U.getFormFactor();return r.supportsFormFactor(e,B);};this._getFirstInbound=function(e,I){var F=Object.keys(e["sap.app"].crossNavigation.inbounds).shift(),B=e["sap.app"].crossNavigation.inbounds[F];return{key:F,inbound:B};};this._resolveTileByIntent=function(T,S){var H=this._prepareTileHash(T);return this._getTileFromHash(H);};this._prepareTileHash=function(T){var e=sap.ushell.Container.getService("URLParsing"),P={},B,F;if(this._isCatalogTile(T)){return T.tileIntent;}if(this._isGroupTile(T)&&T.target){F=T.target.parameters||[];F.forEach(function(H){if(H.name&&H.value){P[H.name]=[H.value];}});B={target:{semanticObject:T.target.semanticObject,action:T.target.action},params:P,appSpecificRoute:T.target.appSpecificRoute};return"#"+e.constructShellHash(B);}return undefined;};this._allPromisesDone=function(P){var e=new jQuery.Deferred(),B;if(P.length===0){e.resolve([]);}else{var N=P.map(function(F){B=new jQuery.Deferred();F.always(B.resolve.bind(B));return B.promise();});jQuery.when.apply(this,N).done(function(){var F=Array.prototype.slice.call(arguments);e.resolve(F);});}return e.promise();};this._assureLoaded=function(){var e=this,B=sap.ushell.Container.getService("CommonDataModel"),F;if(this._assureLoadedDeferred){return this._assureLoadedDeferred.promise();}F=new jQuery.Deferred();this._assureLoadedDeferred=F;B.getSite().done(function(S){if(!e.isSiteSupported(S)){throw new Error("Invalid CDM site version: Check configuration of launchpage adapter and version of FLP site");}var I=[];var H=r.getGroupsArrayFromSite(S);var J=r.getDefaultGroup(H);if(!J){J=m.createDefaultGroup(U.generateUniqueId(r.getGroupIdsFromSite(S)));S=m.addGroupToSite(S,J,0);H=r.getGroupsArrayFromSite(S);}_=J;H.forEach(function(K){I=e._assureGroupItemsResolved(K,S).concat(I);});e._allPromisesDone(I).done(function(){e._assureLoadedDeferred.resolve(H);delete e._assureLoadedDeferred;e._logTileResolutionFailures(e._mFailedResolvedTiles);});}).fail(function(H){jQuery.sap.log.error("Delivering hompage groups failed - "+H);e._assureLoadedDeferred.resolve([]);delete e._assureLoadedDeferred;});return F.promise();};this._logTileResolutionFailures=function(F){var e={};if(!F){return;}Object.keys(d).filter(function(B){var H=d[B];return H>=d.FATAL&&H<=d.ALL;}).forEach(function(B){e[d[B]]="";});Object.keys(F).forEach(function(B){var H=F[B];if(H.logLevel){e[H.logLevel]=e[H.logLevel].concat(H.message).concat("\n");}});if(e[d.FATAL]){l.fatal(e[d.FATAL]);}if(e[d.ERROR]){l.error(e[d.ERROR]);}if(e[d.WARNING]){l.warning(e[d.WARNING]);}if(e[d.INFO]){l.info(e[d.INFO]);}if(e[d.DEBUG]){l.debug(e[d.DEBUG]);}if(e[d.TRACE]){l.trace(e[d.TRACE]);}};this.getDefaultGroup=function(){var e=new jQuery.Deferred(),B;if(!_){B=this._assureLoaded();}if(B){B.done(function(){e.resolve(_);}).fail(function(F){e.reject("Failed to access default group. "+F);});}else{e.resolve(_);}return e.promise();};this._isValidTitle=function(T){if(typeof T!=='string'||!T){return false;}return true;};this._isGroupPreset=function(e){return r.isGroupPreset(e);};this._isGroupLocked=function(e){return r.isGroupLocked(e);};this.addGroup=function(T){var e=new jQuery.Deferred(),B=sap.ushell.Container.getService("CommonDataModel"),F,H,I=this;if(!this._isValidTitle(T)){return e.reject("No valid group title").promise();}H="Failed to add the group with title '"+T+"' to the homepage. ";B.getSite().done(function(S){F=U.generateUniqueId(r.getGroupIdsFromSite(S));m.addGroupToSite(S,m.createEmptyGroup(F,T));B.save().done(function(){delete I._assureLoadedDeferred;e.resolve(S.groups[F],F);}).fail(function(J){e.reject(J);});}).fail(function(J){e.reject(H+J);});return e.promise();};this.getGroupTitle=function(e){return r.getGroupTitle(e);};this.setGroupTitle=function(e,N){var B=this,F=new jQuery.Deferred(),H=sap.ushell.Container.getService("CommonDataModel"),O,I;if(typeof e!=='object'||!r.getGroupId(e)){return F.reject("Unexpected group value").promise();}if(!B._isValidTitle(N)){return F.reject("Unexpected oGroup title value").promise();}I="Failed to set new title for group with id '"+r.getGroupId(e)+"'. ";O=r.getGroupTitle(e);H.getSite().done(function(S){if(e){m.setGroupTitle(e,N);}H.save().done(function(){F.resolve();}).fail(function(J){jQuery.sap.log.error(J);F.reject(O);});}).fail(function(J){F.reject(O,I+J);});return F.promise();};this.getGroupId=function(e){return r.getGroupId(e);};this.hideGroups=function(H){var e=new jQuery.Deferred(),B=sap.ushell.Container.getService("CommonDataModel"),F;if(H&&jQuery.isArray(H)){F="Failed to hide group. ";B.getSite().done(function(S){r.getGroupsArrayFromSite(S).forEach(function(I){m.setGroupVisibility(I,jQuery.inArray(r.getGroupId(I),H)===-1);});B.save().done(function(){e.resolve();}).fail(function(I){e.reject("Hiding of groups did not work as expected - "+I);});}).fail(function(I){e.reject(F+I);});}else{e.reject("Invalid input parameter aHiddenGroupIds. Please pass a valid input parameter.");}return e.promise();};this.isGroupVisible=function(e){return r.isGroupVisible(e);};this.moveGroup=function(e,B){var F=new jQuery.Deferred(),H=sap.ushell.Container.getService("CommonDataModel"),I,J;if(!e||!r.getGroupId(e)||B<0){return F.reject("Unable to move groups - invalid parameters").promise();}J="Failed to move group with id '"+e.identification.id+"'. ";H.getSite().done(function(S){var K=r.getGroupIdsFromSite(S),N=r.getGroupId(e);if(!K){return F.reject("groupsOrder not found - abort operation of adding a group.");}else if(K.indexOf(N)===B){return F.resolve();}I=U.moveElementInsideOfArray(K,K.indexOf(N),B);if(!I){return F.reject("invalid move group operation - abort.");}m.setGroupsOrder(S,I);H.save().done(function(){F.resolve();}).fail(function(O){F.reject(O);});return undefined;}).fail(function(K){F.reject(J+K);});return F.promise();};this.removeGroup=function(e){var B=new jQuery.Deferred(),F=sap.ushell.Container.getService("CommonDataModel"),H,I;if(typeof e!=="object"){return B.reject("invalid group parameter").promise();}I=r.getGroupId(e);if(!I){return B.reject("group without id given").promise();}H="Failed to remove group with id '"+I+"'. ";F.getSite().done(function(S){m.removeGroupFromSite(S,e);F.save().done(function(){B.resolve();}).fail(function(J){B.reject(J);});}).fail(function(J){B.reject(H+J);});return B.promise();};this.resetGroup=function(e){var B=new jQuery.Deferred(),F=sap.ushell.Container.getService("CommonDataModel"),S=[],H=this,I,J;if(typeof e==="object"&&r.getGroupId(e)){J=r.getGroupId(e);I="Failed to reset group with id '"+J+"'. ";F.getSite().done(function(K){jQuery.extend(true,S,r.getGroupsArrayFromSite(K));if(H.isGroupRemovable(e)===false){F.getGroupFromOriginalSite(J).done(function(N){if(typeof K==="object"&&r.getGroupFromSite(K,J)){m.overwriteGroup(K,N,J);}F.save().done(function(){B.resolve(N);}).fail(function(O){B.reject("Group could not be reset - "+O,S);});}).fail(function(N){B.reject("Group could not be reset - "+N,S);});}else{B.reject("Group could not be reset as it was created by the user",S);}}).fail(function(K){B.reject(I+K,[]);});}return B.promise();};this.getTileTitle=function(T){return r.getTileTitle(this._mResolvedTiles,T);};this.getTileSubtitle=function(T){return r.getTileSubtitle(this._mResolvedTiles,T);};this.getTileIcon=function(T){return r.getTileIcon(this._mResolvedTiles,T);};this.getTileInfo=function(T){return r.getTileInfo(this._mResolvedTiles,T);};this.getTileIndicatorDataSource=function(T){var e=this._mResolvedTiles[T.id],B={},F;if(T.indicatorDataSource){B.indicatorDataSource=T.indicatorDataSource;if(T.dataSource){B.dataSource=T.dataSource;}return B;}if(!e){return B;}F=e.tileResolutionResult;if(F.indicatorDataSource){B.indicatorDataSource=F.indicatorDataSource;if(F.indicatorDataSource.hasOwnProperty("dataSource")){var H=F.indicatorDataSource.dataSource,I=F.dataSources;if(I&&I.hasOwnProperty(H)){B.dataSource=I[H];}else{jQuery.sap.log.warning("datasource referenced but not found for tile: "+e.tileIntent);}}if(U.getMember(F,"runtimeInformation.componentProperties.url")){var P=U.getMember(B,"indicatorDataSource.path");var J=U.getMember(B,"dataSource.uri");var K=U.getMember(F,"runtimeInformation.componentProperties.url");var N=u(P,J,K,window.location.href);if(!N.error){if(P){B.indicatorDataSource.path=N.uri;}if(J){B.dataSource.uri=N.uriParent;}}}}return B;};this.isGroupRemovable=function(e){return!this._isGroupPreset(e);};this.isGroupLocked=function(e){return this._isGroupLocked(e);};this.getGroupTiles=function(e){return r.getGroupTiles(e).concat(r.getGroupLinks(e));};this.getLinkTiles=function(e){return r.getGroupLinks(e);};this.getTileType=function(T){if(r.isLink(this._mResolvedTiles,T)){return this.TileType.Link;}return this.TileType.Tile;};this.getTileId=function(T){return r.getTileId(T);};this.getTileSize=function(T){return r.getTileSize(this._mResolvedTiles,T)||"1x1";};this.getTileTarget=function(T){var e=r.getTileId(T),B=this._mResolvedTiles[e];if(T.target&&T.target.url){return T.target.url;}if(B){return B.tileIntent;}jQuery.sap.log.warning("Could not find a target for Tile with id '"+e+"'","sap.ushell.adapters.cdm.LaunchPageAdapter");return"";};this.isLinkPersonalizationSupported=function(T){return true;};this.isTileIntentSupported=function(T){return(this._mFailedResolvedTiles[T.id]===undefined)?true:false;};this._notifyTileAboutRefresh=function(T){if(typeof T.tileRefresh==="function"){T.tileRefresh();}};this.refreshTile=function(T){var e=this._mResolvedTiles[T.id];if(e){if(e.tileComponent){this._notifyTileAboutRefresh(e.tileComponent);}}};this._notifyTileAboutVisibility=function(T,N,O){if(typeof T.tileSetVisible==="function"&&O!==N){T.tileSetVisible(N);}};this.setTileVisible=function(T,N){var e=this._mResolvedTiles[T.id];if(e){if(e.tileComponent){this._notifyTileAboutVisibility(e.tileComponent,N,e.visibility);}e.visibility=N;}};this.getTileView=function(e){var B=this;return new jQuery.Deferred(function(F){return B._getTileView(e,false).then(function(T){F.resolve(T);},function(H){var I="Tile with ID '"+e.id+"' could not be initialized"+(H?":\n"+H:".");jQuery.sap.log.error(I,null,e.tileType);F.reject(I);});}).promise();};this._getTileUiComponentContainerSync=function(T,e,I){var B=this,F,H,N,J,K={};if(I===true){H=B._createTileComponentData(T,true,e);}else{H=B._createTileComponentData(T,false,e);}F=e.tileResolutionResult;if(e.isLink){N=F.navigationMode;return B._createLinkInstance(T,I,N,G,b);}if(typeof F.tileComponentLoadInfo==="object"&&F.tileComponentLoadInfo!==null){K=F.tileComponentLoadInfo.componentProperties||{};K.name=F.tileComponentLoadInfo.componentName;}K.componentData=H;if(K.manifest){K.componentData.properties=K.componentData.properties||{};K.componentData.properties.manifest=K.manifest;}if(K.name){K.async=false;var O;try{J=sap.ui.component(K);}catch(P){jQuery.sap.log.error(P.message+"\n-- An error occurred while instantiating "+"the tile component for "+K.name,P.stack?P.stack:"","sap.ushell.adapters.cdm.LaunchPageAdapter");return null;}O=new sap.ui.core.ComponentContainer({component:J,height:'100%'});if(I===true){B._mResolvedCatalogTiles[T.id].tileComponent=J;}else{B._mResolvedTiles[T.id].tileComponent=J;}return O;}return null;};this._getTileUiComponentContainer=function(T,e,I){var B=this,F,H,N,J,K,O,P=new jQuery.Deferred();var Q=sap.ushell.Container.getService("Ui5ComponentLoader");if(I===true){H=B._createTileComponentData(T,true,e);}else{H=B._createTileComponentData(T,false,e);}F=e.tileResolutionResult;if(e.isLink){N=F.navigationMode;P.resolve(B._createLinkInstance(T,I,N,G,b));return P.promise();}var S=this._createTileComponentProperties(H,F.tileComponentLoadInfo);if(!S.name){return P.reject("Cannot find name of tile component for tile with id: '"+T.id+"'").promise();}if(S.manifest){H.properties=H.properties||{};H.properties.manifest=S.manifest;}O=this.isCustomTile(S.name);var W=function(Y){var e;J=Y.componentHandle.getInstance();K=new C({component:J,height:'100%'});if(!I){e=B._mResolvedTiles[T.id];e.tileComponent=J;if(typeof e.visibility==="boolean"){B._notifyTileAboutVisibility(J,e.visibility);}}return K;};var X=function(){return Q.createComponent({loadCoreExt:O,loadDefaultDependencies:false,componentData:H,url:S.url,applicationConfiguration:{},reservedParameters:{},applicationDependencies:S,ui5ComponentName:S.name},{},[]).then(W);};if(O){E.once("CoreResourcesComplementLoaded").do(function(){X().then(function(K){P.resolve(K);}).fail(function(Y){P.reject(Y);});});}else{X().then(function(K){P.resolve(K);}).fail(function(Y){P.reject(Y);});}return P.promise();};this._createTileComponentProperties=function(T,e){var B={};if(typeof e==="string"){if(T.properties.indicatorDataSource&&T.properties.indicatorDataSource.path){B.name=D;}else{B.name=s;}return B;}if(typeof e==="object"&&e!==null){if(jQuery.isEmptyObject(e)){if(T.properties.indicatorDataSource&&T.properties.indicatorDataSource.path){B.name=D;}else{B.name=s;}return B;}B=e.componentProperties||{};B.name=e.componentName;B.url=e.url;}return B;};this._getTileView=function(e){var B,F,H=new jQuery.Deferred();if(typeof e!=="object"||!e.id){F="Invalid input parameter passed to _getTileView: "+e;jQuery.sap.log.error(F);return H.reject(F).promise();}B=this._mResolvedTiles[e.id];if(B){return this._getTileUiComponentContainer(e,B,false);}F="No resolved tile found for tile ID: "+e.id;jQuery.sap.log.error(F);return H.reject(F).promise();};this._getCatalogTileView=function(e){if(typeof e!=="object"){throw new Error(e);}return this._getTileUiComponentContainerSync(e,e,true);};this._getCatalogTileViewControl=function(e){var B=new jQuery.Deferred();if(typeof e!=="object"){var F="Invalid input parameter passed to _getCatalogTileView: "+e;jQuery.sap.log.error(F);return B.reject(F).promise();}return this._getTileUiComponentContainer(e,e,true);};this._createTileComponentData=function(T,I,e){var B=I?this.getCatalogTileTitle(T):this.getTileTitle(T),S=I?this.getCatalogTilePreviewSubtitle(T):this.getTileSubtitle(T),F=I?this.getCatalogTilePreviewIcon(T):this.getTileIcon(T),H=I?this.getCatalogTilePreviewInfo(T):this.getTileInfo(T),J=I?this.getCatalogTileTargetURL(T):this.getTileTarget(T),K=this.getTileIndicatorDataSource(T),N={properties:{},startupParameters:{}};if(e.tileResolutionResult.isCustomTile===true&&e.tileResolutionResult.startupParameters){N.startupParameters=e.tileResolutionResult.startupParameters;}if(B){N.properties.title=B;}if(H){N.properties.info=H;}if(S){N.properties.subtitle=S;}if(F){N.properties.icon=F;}if(J){N.properties.targetURL=J;}if(K.indicatorDataSource){N.properties.indicatorDataSource=K.indicatorDataSource;if(K.dataSource){N.properties.dataSource=K.dataSource;}}if(e.tileResolutionResult){N.properties.navigationMode=e.tileResolutionResult.navigationMode;}return N;};this._createLinkInstance=function(T,I,N,e,b){var B,F,H,J=this.getTileSubtitle(T);var G=e;if(I===true){B=this.getCatalogTileTitle(T);}else{B=this.getTileTitle(T);}F=new G({mode:g.LineMode,subheader:J,header:B,press:function(K){this._genericTilePressHandler(T,K);}.bind(this)});if(N){H=b.i18n.getText(N+"NavigationMode");F.setAriaLabel(H+" "+B+" "+J);}this._mResolvedTiles[T.id].linkTileControl=F;return F;};this._genericTilePressHandler=function(T,e){var B;if(e.getSource().getScope&&e.getSource().getScope()==="Display"){B=this.getTileTarget(T);if(B){if(B[0]==='#'){hasher.setHash(B);}else{window.open(B,'_blank');}}}};this._addTileToSite=function(P,e,N,B){var F=this,H=new jQuery.Deferred(),I=sap.ushell.Container.getService("URLParsing").parseShellHash(N.properties.targetURL),T={"id":F.getTileId(N),"target":{"semanticObject":I.semanticObject,"action":I.action,"parameters":z(I.params)}};P.groups[e.identification.id].payload.tiles.push(T);B.save().done(function(){H.resolve(T);}).fail(function(J){H.reject(J);});return H.promise();};this.addTile=function(e,B){var F=new jQuery.Deferred(),H,I=sap.ushell.Container.getService("CommonDataModel"),J;if(!B){B=_;}if(e.contentProviderId){if(e.externalUrl){return this.addBookmark(this._getBookmarkDataForExtensionCatalogTile(e),B);}return F.reject("Extension Tile without URL").promise();}J=k();J.vizId=e.vizId;this._mResolvedTiles[J.id]={tileIntent:e.tileIntent,tileResolutionResult:e.tileResolutionResult,isLink:false};I.getSite().done(function(S){S.groups[B.identification.id].payload.tiles.push(J);I.save().done(function(){F.resolve(J);}).fail(function(K){F.reject(K);});}).fail(function(K){H="Failed to add tile with id '"+J.id+"' to group with id '"+B.identification.id+"'. ";F.reject(H+K);});return F.promise();};this._getBookmarkDataForExtensionCatalogTile=function(e){var B={title:e.tileResolutionResult.title,subtitle:e.tileResolutionResult.subTitle,icon:e.tileResolutionResult.icon,info:e.tileResolutionResult.info,url:e.externalUrl};if(e.tileResolutionResult.indicatorDataSource&&e.tileResolutionResult.indicatorDataSource.path){B.serviceUrl=e.tileResolutionResult.indicatorDataSource.path;B.serviceRefreshInterval=e.tileResolutionResult.indicatorDataSource.refresh;}return B;};this.removeTile=function(B,T,I){var F,H,J=new jQuery.Deferred(),K=this;if(!B||typeof B!=="object"||!B.identification||!B.identification.id||!T||typeof T!=="object"||!T.id){return J.reject({},"Failed to remove tile. No valid input parameters passed to removeTile method.").promise();}H="Failed to remove tile with id '"+T.id+"' from group with id '"+B.identification.id+"'. ";F=sap.ushell.Container.getService("CommonDataModel");F.getSite().done(function(S){var P,N;I=+I;try{P=S.groups[B.identification.id].payload;}catch(e){J.reject(S.groups[B.identification.id],H);}N=K.getTileType(T)===K.TileType.Link?"links":"tiles";if(K.getTileType(T)===K.TileType.Link){I-=P.tiles.length;}if(I>=0){P[N].splice(I,1);}else{P[N]=P[N].filter(function(O){return O.id!==T.id;});}F.save().done(function(){J.resolve();}).fail(function(O){jQuery.sap.log.error(O);J.reject(S.groups[B.identification.id],O);});}).fail(function(e){J.reject({},H+e);});return J.promise();};this.moveTile=function(T,S,e,B,F,H){var I=new jQuery.Deferred(),J=sap.ushell.Container.getService("CommonDataModel"),K=this,N;if(!T||jQuery.isEmptyObject(T)||S===undefined||S<0||e===undefined||e<0||!B||!B.identification||!B.identification.id||!F||!F.identification||!F.identification.id){return I.reject("Invalid input parameters").promise();}N="Failed to move tile with id '"+T.id+"'. ";J.getSite().done(function(O){var P,Q,W=K.getTileType(T)===K.TileType.Link?"links":"tiles";if(!H){H=K._mResolvedTiles[T.id].isLink?"link":"tile";}P=H==="link"?"links":"tiles";if(W!=P&&K._mResolvedTiles[T.id]){K._mResolvedTiles[T.id].isLink=H==="link";}if(P==="links"){e-=O.groups[F.identification.id].payload.tiles.length;}if(W==="links"){S-=O.groups[B.identification.id].payload.tiles.length;}if(B.identification.id===F.identification.id){if(S!==e||W!=P){Q=O.groups[F.identification.id].payload;Q[W].splice(S,1);Q[P].splice(e,0,T);}else{return I.resolve(T).promise();}}else{O.groups[B.identification.id].payload[W].splice(S,1);O.groups[F.identification.id].payload[P].splice(e,0,T);}J.save().done(function(){I.resolve(T);}).fail(function(X){jQuery.sap.log.error(N+X);I.reject(N+X);});return undefined;}).fail(function(O){jQuery.sap.log.error(N+O);I.reject(N+O);});return I.promise();};this._compareCatalogs=function(e,B){if(e.identification.id>B.identification.id){return 1;}return-1;};this.getCatalogs=function(){var e=this,B=new jQuery.Deferred(),F=[],H=sap.ushell.Container.getService("CommonDataModel");function I(J,K,F,N,P,O){var Q=J.catalogs[K];if(P&&O){Q.contentProviderId=P;O.catalogsMap[K]=Q;}F.push(Q);N.notify(Q);}window.setTimeout(function(){H.getSite().done(function(S){Object.keys(S.catalogs).forEach(function(J){I(S,J,F,B);});H.getExtensionSites().progress(function(J){var P=J.providerId;var K=J.site;var N=Promise.resolve(K);var O={sitePromise:N,site:K,catalogsMap:{}};Object.keys(K.catalogs).forEach(function(Q){e._mContentProviders[P]=O;I(K,Q,F,B,P,O);});}).done(function(J){J.filter(function(K){return!K.success;}).forEach(function(K,N){F.push({identification:{id:K.providerId},contentProviderId:K.providerId,error:"The following content providers could not provide catalogs: "+K.providerId+(K.error?" -> "+K.error:"")});});B.resolve(F.sort(e._compareCatalogs));});});},0);return B.promise();};this._isStartableInbound=function(I){var N=["Shell-plugin","Shell-bootConfig"],e;if(!I.semanticObject||!I.action){return false;}if(N.indexOf(I.semanticObject+"-"+I.action)>-1){return false;}if(!jQuery.sap.getObject("signature.parameters",undefined,I)){return true;}e=Object.keys(I.signature.parameters).every(function(p){return!I.signature.parameters[p].filter||(!!I.signature.parameters[p].launcherValue||p==="sap-external-url");});return e;};this._isHiddenInbound=function(I){return!!I.hideLauncher;};this._toHashFromInbound=function(I){var e=c.toHashFromInbound(I);if(!e){return undefined;}return"#"+e;};this._getExternalUrlFromInbound=function(I){return jQuery.sap.getObject("signature.parameters.sap-external-url.launcherValue.value",undefined,I)||null;};this._toHashFromOutbound=function(O){var e=c.toHashFromOutbound(O);if(!e){return undefined;}return"#"+e;};this._isCustomTile=function(e){if(U.getMember(e,"sap|flp.type")==="tile"){return true;}return false;};this.getCatalogTiles=function(e){var B=this,F=new jQuery.Deferred();if(typeof e!=="object"||e===null){return F.reject("Invalid input parameter '"+e+"' passed to getCatalogTiles.").promise();}if(e.contentProviderId&&this._mContentProviders[e.contentProviderId]){this._mContentProviders[e.contentProviderId].sitePromise.then(function(S){i.call(B,e,S).done(F.resolve).fail(F.reject);},function(H){F.reject("Failed to get site: "+H);});}else{sap.ushell.Container.getService("CommonDataModel").getSite().done(function(S){i.call(B,e,S).done(F.resolve).fail(F.reject);}).fail(function(H){F.reject("Failed to get site: "+H);});}return F.promise();};this.isCustomTile=function(e){return!(e===s||e===D);};function i(e,S){var B=this,F=new jQuery.Deferred();setTimeout(function(){var H=((e.payload&&e.payload.viz)||[]).reduce(function(I,J){var K,N,O,P,Q,T,W,X,Y,Z,$,a1,b1,c1,d1,e1,f1;if(!J){return I;}N=o.get(S,J);if(!N){return I;}O=o.getTypeId(N);P=o.getType(S,O);K=o.getAppId(N);if(K){Q=o.getAppDescriptor(S,K);if(!Q){return I;}T=r.getInbound(Q,o.getTarget(N).inboundId);if(!T){return I;}if(!B._isStartableInbound(T.inbound)||B._isHiddenInbound(T.inbound)){return I;}X=c.mapOne(T.key,T.inbound,Q,N,P);if(!X||!X.tileResolutionResult){return I;}c1=X.resolutionResult.applicationType;d1=X.resolutionResult.additionalInformation;f1=a.last("/core/navigation/enableInPlaceForClassicUIs");e1=f1?f1[c1]:false;Y=n.computeNavigationModeForHomepageTiles(c1,d1,e1);Z=o.getOutbound(N,T.inbound);W=B._toHashFromOutbound(Z);}else{var g1=o.getConfig(N);if(g1==undefined){return I;}X=c.mapOne(undefined,undefined,undefined,N,P);if(U.getMember(g1,"sap|flp.target.type")==="URL"){b1=U.getMember(g1,"sap|flp.target.url");}}$=X.tileResolutionResult;$.navigationMode=Y;if(e.contentProviderId){b1=B._getMember(Q,"sap|app.crossNavigation.inbounds.Shell-launchURL.signature.parameters.sap-external-url.launcherValue.value");}a1={id:J,vizId:J,tileIntent:b1||W,tileResolutionResult:$,isCatalogTile:true};if(e.contentProviderId&&b1){a1.contentProviderId=e.contentProviderId;a1.externalUrl=b1;}I.push(a1);return I;},[]);F.resolve(H);},0);return F.promise();}this.getCatalogError=function(e){if(e.error){return e.error;}return undefined;};this.getCatalogId=function(e){return R.getId(e);};this.getCatalogTitle=function(e){return R.getTitle(e);};this._isGroupTile=function(T){return r.isGroupTile(T);};this._isCatalogTile=function(T){return!!(T&&T.isCatalogTile);};this._isFailedGroupTile=function(T){return!!(T&&this._mFailedResolvedTiles&&this._mFailedResolvedTiles[r.getTileId(T)]);};this._isFailedCatalogTile=function(T){return!!(T&&this._mFailedResolvedCatalogTiles&&this._mFailedResolvedCatalogTiles[r.getTileId(T)]);};this.getCatalogTileId=function(e){if(this._isGroupTile(e)){if(this._isFailedGroupTile(e)){return undefined;}if(e.isBookmark&&jQuery.sap.getObject("target.url",undefined,e)){return e.target.url;}return e.vizId||(e.target&&e.target.url);}if(this._isCatalogTile(e)){return e.id;}return undefined;};this.getCatalogTileTitle=function(e){if(this._isGroupTile(e)){if(this._isFailedGroupTile(e)){return"";}return this._mResolvedTiles[e.id].tileResolutionResult.title;}if(this._isCatalogTile(e)){if(this._isFailedCatalogTile(e)){return undefined;}return e.tileResolutionResult.title;}return undefined;};this.getCatalogTileSize=function(e){return this.getTileSize(e);};this.getCatalogTileView=function(e){return this._getCatalogTileView(e);};this.getCatalogTileViewControl=function(e){return this._getCatalogTileViewControl(e);};this.getCatalogTileTargetURL=function(e){if(!e){throw new Error("The given tile is falsy");}if(this._isCatalogTile(e)){if(e.tileResolutionResult&&e.tileResolutionResult.isCustomTile){if(!e.tileResolutionResult.targetOutbound){return"";}return this._toHashFromOutbound(e.tileResolutionResult.targetOutbound);}return e.tileIntent||"";}return this.getTileTarget(e);};this.getCatalogTilePreviewTitle=function(e){if(this._isGroupTile(e)){return this.getTileTitle(e);}return(e.tileResolutionResult&&e.tileResolutionResult.title)||"";};this.getCatalogTilePreviewSubtitle=function(e){if(this._isGroupTile(e)){return this.getTileSubtitle(e);}return(e.tileResolutionResult&&e.tileResolutionResult.subTitle)||"";};this.getCatalogTilePreviewIcon=function(e){if(this._isGroupTile(e)){return this.getTileIcon(e);}return(e.tileResolutionResult&&e.tileResolutionResult.icon)||"";};this.getCatalogTilePreviewInfo=function(e){if(this._isGroupTile(e)){return this.getTileInfo(e);}return(e.tileResolutionResult&&e.tileResolutionResult.info)||"";};this.getCatalogTileKeywords=function(e){var K=[],B=e;if(!B){jQuery.sap.log.error("Could not find the Tile","sap.ushell.adapters.cdm.LaunchPageAdapter");return K;}if(this._mResolvedTiles&&this._mResolvedTiles[e.id]){B=this._mResolvedTiles[e.id];}if(B&&B.tileResolutionResult&&B.tileResolutionResult.title){K.push(B.tileResolutionResult.title);}if(B&&B.tileResolutionResult&&B.tileResolutionResult.subTitle){K.push(B.tileResolutionResult.subTitle);}return K;};this._visitBookmarks=function(e,B){var F=sap.ushell.Container;var H=F.getService("URLParsing");var I=F.getService("CommonDataModel");var J;var K=H.parseShellHash(e);if(K){J=y(K);}else{J=x(e);}return I.getSite().then(function(S){var N=S.groups;var T=Object.keys(N).filter(function(O){return!N[O].payload.locked;}).map(function(O){return N[O].payload.tiles.filter(function(P){return P.isBookmark&&t(J,P.target);});}).reduce(function(O,P){Array.prototype.push.apply(O,P);return O;},[]);if(!B){return T.length;}return jQuery.when(T.map(B)).then(function(){return T.length;});});};this.addBookmark=function(P,e){var T=this;return new jQuery.Deferred(function(B){var F=sap.ushell.Container;var H=F.getService("URLParsing");var I=F.getService("CommonDataModel");jQuery.when(e||T.getDefaultGroup(),I.getSite()).done(function(e,S){var J,K,N=H.parseShellHash(P.url),O,Q=false;if(!N){K=x(P.url);Q=true;}else{K=y(N);}J=j(P,K);if(Q){O=new jQuery.Deferred();O.resolve(T._getTileForUrl(J));}else{O=T._getTileFromHash(P.url);}O.done(function(W){W.isLink=false;T._mResolvedTiles[J.id]=W;S.groups[e.identification.id].payload.tiles.push(J);I.save().done(function(){B.resolve(J);}).fail(function(X){B.reject(X);});}).fail(function(W){B.reject("Bookmark creation failed because: "+W);});}).fail(function(J){B.reject(J);});}).promise();};this.countBookmarks=function(e){return this._visitBookmarks(e);};this.updateBookmarks=function(e,P){var B=sap.ushell.Container;var F=B.getService("URLParsing");var H=B.getService("CommonDataModel");var I=this._mResolvedTiles;function J(T){return new jQuery.Deferred(function(K){var N,O;var Q;var S=false;var W={};if(P.url||P.url===""){N=F.parseShellHash(P.url);if(!N){O=x(P.url);}else{O=y(N);}}if(T.icon!==P.icon){W.icon=P.icon;S=true;}if(T.title!==P.title){W.title=P.title;S=true;}if(T.subTitle!==P.subtitle){W.subtitle=P.subtitle;S=true;}if(P.url&&e!==P.url){W.targetURL=P.url;S=true;}if(T.info!==P.info){W.info=P.info;S=true;}q(T,P,O);if(S&&I[T.id]){Q=I[T.id].tileComponent;Q.tileSetVisualProperties(W);}K.resolve(T);}).promise();}return this._visitBookmarks(e,J).then(function(K){return H.save().then(function(){return K;});});};this.deleteBookmarks=function(e){var B=sap.ushell.Container;var F=B.getService("URLParsing");var H=B.getService("CommonDataModel");var I=F.parseShellHash(e);var J;if(I){J=y(I);}else{J=x(e);}return H.getSite().then(function(S){var K=S.groups;var N=Object.keys(K).map(function(O){var P=K[O].payload;var Q=0;P.tiles=P.tiles.filter(function(T){if(T.isBookmark&&t(J,T.target)){++Q;return false;}return true;});return Q;}).reduce(function(O,P){O+=P;return O;},0);return H.save().then(function(){return N;});});};this.onCatalogTileAdded=function(T){};this._onTileSettingsSave=function(T,S){var e=new jQuery.Deferred(),B,F,N,H,I,O,J,K;if(T&&T.id&&S){N=S.oTitleInput.getValue();I=S.oSubTitleInput.getValue();H=S.oInfoInput.getValue();O=this.getTileTitle(T);J=this.getTileInfo(T);K=this.getTileSubtitle(T);if(O===N&&K===I&&J===H){return undefined;}B=sap.ushell.Container.getService("CommonDataModel");var P=this;B.getSite().done(function(Q){if(!Q.modifiedTiles){Q.modifiedTiles={};}if(!Q.modifiedTiles[T.id]){Q.modifiedTiles[T.id]={id:T.id};}F={};if(O!==N){F.title=N;Q.modifiedTiles[T.id].title=N;T.title=N;}if(K!==I){F.subtitle=I;Q.modifiedTiles[T.id].subTitle=I;T.subTitle=I;}if(J!==H){F.info=H;Q.modifiedTiles[T.id].info=H;T.info=H;}if(P._mResolvedTiles[T.id].tileComponent){P._mResolvedTiles[T.id].tileComponent.tileSetVisualProperties(F);}else if(P._mResolvedTiles[T.id].linkTileControl){if(F.title){P._mResolvedTiles[T.id].linkTileControl.setHeader(F.title);}if(F.subtitle){P._mResolvedTiles[T.id].linkTileControl.setSubheader(F.subtitle);}if((F.title)||(F.subtitle)){P._mResolvedTiles[T.id].linkTileControl.rerender();}}B.save().fail(function(W){jQuery.sap.log.error(W);e.reject("Could not save personalization changes: "+W);}).done(function(){e.resolve();});}).fail(function(Q){jQuery.sap.log.error(Q);e.reject("Cannot get site: "+Q);});}return e.promise();};this.getTileActions=function(T){var e=[],B,F;if(this._isGroupTile(T)&&!this._isFailedGroupTile(T)){F=new sap.ui.model.json.JSONModel({config:{"display_title_text":this.getTileTitle(T),"display_subtitle_text":this.getTileSubtitle(T),"display_info_text":this.getTileInfo(T)}});B=sap.ushell.components.tiles.utilsRT.getTileSettingsAction(F,this._onTileSettingsSave.bind(this,T),this.getTileType(T));e.push(B);}return e;};function j(P,T){var e=k(P,T);e.isBookmark=true;return e;}function k(P,T){var e={id:U.generateUniqueId([])};q(e,P,T);return e;}function q(T,P,e){P=jQuery.extend(true,{},P);if(e){T.target=e;}if(P.title||P.title===""){T.title=P.title;}if(P.icon||P.icon===""){T.icon=P.icon;}if(P.subtitle||P.subtitle===""){T.subTitle=P.subtitle;}if(P.info||P.info===""){T.info=P.info;}if(P.dataSource){T.dataSource={};jQuery.extend(true,T.dataSource,P.dataSource);delete P.serviceUrl;}else if(P.dataSource===null){delete T.dataSource;delete T.indicatorDataSource;delete P.serviceUrl;}if((P.dataSource||T.dataSource)&&P.serviceUrlPath){T.indicatorDataSource={path:P.serviceUrlPath};}if(P.serviceUrl||P.serviceUrl===""){if(T.dataSource){jQuery.sap.log.warning("`serviceUrl` is marked for deprecation in the future."+"It is not the preferred means for defining a dynamic "+"tile's data source. Please use `oParameter.dataSource`");delete T.dataSource;}T.indicatorDataSource={path:P.serviceUrl};}else if(P.serviceUrl===null&&!T.dataSource){delete T.indicatorDataSource;}if(P.serviceRefreshInterval||P.serviceRefreshInterval===0){T.indicatorDataSource.refresh=P.serviceRefreshInterval;}}function t(T,O){if(T&&O){if(T.url){return T.url===O.url;}return T.semanticObject===O.semanticObject&&T.action===O.action&&v(T.parameters,O.parameters);}return T===O;}function v(P,O){var F,e;P=P||[];O=O||[];if(P.length===O.length){F=w(P);e=w(O);return F===e;}return false;}function w(e){return e.map(function(P){return P.name+P.value;}).sort().join();}function x(e){return{url:e};}function y(I){var T={semanticObject:I.semanticObject,action:I.action,parameters:z(I.params)};if(I.appSpecificRoute){T.appSpecificRoute=I.appSpecificRoute;}return T;}function z(I){return Object.keys(I).map(function(K){var e=I[K]&&I[K][0];return{name:K,value:e||""};});}}f.prototype._getMember=function(O,A){return U.getMember(O,A);};return f;},true);
