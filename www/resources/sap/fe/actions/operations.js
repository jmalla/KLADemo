/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(['sap/m/MessageBox',"sap/m/Dialog",'sap/ui/mdc/base/Field','sap/m/Label',"sap/ui/model/json/JSONModel",'sap/ui/core/XMLTemplateProcessor','sap/ui/core/util/XMLPreprocessor','sap/ui/core/Fragment'],function(M,D,F,L,J,X,a,b){'use strict';function c(A,k,P){return new Promise(function(l,m){P=P||{};var C,E,O=P.onSubmitted,n=P.actionParameters||[],q,t,u,v=[],G,i,w=P.label,x=P.invocationGrouping==='ChangeSet',I,S=P.showActionParameterDialog,B=P.bindingParameters,y,R;if(!k||k.length===0){return m("Bound actions always requires at least one context");}if(Array.isArray(k)){C=k;R=true;}else{C=[k];}q=C[0].getModel();A=r(A);I=h(A,q);if(S||n.length>0){u=g(A,q,C);n=p(u,n);if(!n||n.length===0){S=false;}}if(S){y=s;}else if(I){y=e;}E=function(t,H){if(n&&n.length){for(var j=0;j<n.length;j++){t.setParameter(n[j].$Name,n[j].value);}}G=H&&!x?'$auto.'+H:undefined;v.push(t.execute(G));};function z(j){return j.then(function(H){return{response:H,status:"resolved"};},function(H){return{response:H,status:"rejected"};});}(y?y(w,n,u):Promise.resolve(true)).then(function(j){if(j){for(i=0;i<C.length;i++){t=q.bindContext(A+'(...)',C[i],B);E(t,(C.length<=1?null:i));}(O||jQuery.noop)(v);Promise.all(v.map(z)).then(function(H){var K=[],N=[];var Q;for(Q=0;Q<H.length;Q++){if(H[Q].status==="rejected"){K.push(H[Q].response);}if(H[Q].status==="resolved"){N.push(H[Q].response);}}if(!H||(H&&H.length===0)){m(true);}if(K.length===0){if(R){l(N);}else{l(N[0]);}}else{m({resolvedItems:N,rejectedItems:K});}});}else{m(true);}});});}function d(A,m,P){var i=P.actionParameters||[],O=P.onSubmitted,k,l,n,I,q=P.label,S=P.showActionParameterDialog,t;if(!m){return Promise.reject("Action expects a model/context for execution");}A=r(A);l=g(A,m,null);I=h(A,m);if(!l||l.$kind!=="ActionImport"){return Promise.reject("Action Import not found");}if(S||i.length>0){i=p(l,i);if(i.length===0){S=false;}}if(S){t=s;}else if(I){t=e;}(t?t(q,i,l):Promise.resolve(true)).then(function(C){if(C){k=m.bindContext("/"+A+'(...)');if(i&&i.length){for(var j=0;j<i.length;j++){k.setParameter(i[j].name,i[j].value);}}n=k.execute('actionImport');m.submitBatch('actionImport');(O||jQuery.noop)(n);return n;}});}function e(A,i){return new Promise(function(j,k){var R=sap.ui.getCore().getLibraryResourceBundle("sap.fe"),C;if(R.hasText("SAPFE_ACTION_CONFIRM|"+A)){C=R.getText("SAPFE_ACTION_CONFIRM|"+A);}else{C=R.getText("SAPFE_ACTION_CONFIRM");}M.confirm(C,{onClose:function(l){if(l===M.Action.OK){j(true);}j(false);},title:i||R.getText("SAPFE_ACTION_CONFIRM_TITLE")});});}function s(A,P,j){return new Promise(function(k,l){var m=X.loadTemplate('sap/fe/controls/ActionParameterDialog','fragment'),R=sap.ui.getCore().getLibraryResourceBundle("sap.fe"),n=new J({$valueState:{},$valueStateText:{}}),C={handleChange:function(E,i){var v=E.getParameter("value");var V=E.getParameter("valid");if(V&&v!=""){n.setProperty("/$valueState/"+i,'None');n.setProperty("/$valueStateText/"+i,'');}}};return a.process(m,{},{bindingContexts:{action:j},models:{action:j.getModel()}}).then(function(m){b.load({definition:m,controller:C}).then(function(q){var t=new D({title:A||R.getText("SAPFE_ACTION_PARAMETER_DIALOG_TITLE"),content:[q],beginButton:{text:A||R.getText("SAPFE_ACTION_PARAMETER_DIALOG_OK"),press:function(){var E,i,v;for(i=0;i<P.length;i++){v=n.getProperty("/"+P[i].$Name);if(!v&&P[i].$Nullable===false){E=true;n.setProperty("/$valueState/"+P[i].$Name,'Error');n.setProperty("/$valueStateText/"+P[i].$Name,R.getText("SAPFE_ACTION_PARAMETER_REQUIRED"));}else{P[i].value=v;}}if(!E){t.close();t.destroy();k(true);}}},endButton:{text:R.getText("SAPFE_ACTION_PARAMETER_DIALOG_CANCEL"),press:function(){t.close();k(false);}}});t.setModel(n);t.bindElement("/");t.open();});});});}function p(A,P){var i=f(A);P=P||[];if(P.length>0){}return i;}function g(A,m,C){var i=m.getMetaModel(),j=i.getMetaPath(C[0].getPath())+'/'+A;if(i.getObject(j+'/@$ui5.overload/0')){return i.createBindingContext(j+'/@$ui5.overload/0');}else{return i.createBindingContext(j+'/0');}}function r(A){var n=A.split("/")[1];return n?n:A;}function f(A){if(!A){return Promise.reject("No Action was obtained");}var P=A.getObject("$Parameter");if(P&&P.length){if(A.getObject("$IsBound")){return P.slice(1,P.length)||[];}else{return P;}}}function h(A,m){return m.getMetaModel().getObject("/"+A+'@com.sap.vocabularies.Common.v1.IsActionCritical');}var o={callBoundAction:c,callActionImport:d};return o;});
