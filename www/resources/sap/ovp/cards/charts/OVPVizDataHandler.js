sap.ui.define(["sap/ui/core/Control","sap/ui/model/json/JSONModel","jquery.sap.global","sap/ovp/cards/charts/Utils","sap/ovp/app/resources"],function(C,J,q,U,O){"use strict";return C.extend("sap.ovp.cards.charts.OVPVizDataHandler",{metadata:{aggregations:{data:{type:"sap.ui.core.Element"},aggregateData:{type:"sap.ui.core.Element"},content:{multiple:false}},properties:{chartType:{defaultValue:false},dependentDataReceived:{defaultValue:false},scale:{defaultValue:""},entitySet:{}}},renderer:function(r,c){r.write("<div");r.writeElementData(c);r.write(">");if(c.getContent()){r.renderControl(c.getContent());}r.write("</div>");},mergeDatasets:function(b,d,c){var t=this;var m=this.getModel();var p=b.mParameters;var D=q.extend(true,{},this.dataSet);if(p){var s=p.select.split(",");}var e=b.getPath().substring(1);var a=-1;if(e){a=e.indexOf('Parameters');}if(a>=0){e=e.substr(0,e.indexOf('Parameters'));}var f=m.getMetaModel();var g=this.getEntitySet();var h=f.getODataEntitySet(g);var l=f.getODataEntityType(h.entityType);var n=[];var o=[];for(var i=0;i<l.property.length;i++){if(l.property[i]["com.sap.vocabularies.Analytics.v1.Measure"]||(l.property[i].hasOwnProperty("sap:aggregation-role")&&l.property[i]["sap:aggregation-role"]==="measure")){if(s&&s.indexOf(l.property[i].name)!==-1){n.push(l.property[i].name);}}else{if(s&&s.indexOf(l.property[i].name)!==-1){o.push(l.property[i].name);}}}if(D&&D.results){for(var i=0;i<D.results.length-2;i++){for(var j=0;j<n.length;j++){D.results[0][n[j]]=Number(D.results[0][n[j]])+Number(D.results[i+1][n[j]]);}}var r=D.__count-D.results.length;var u={};u.results=[];u.results[0]=D.results[0];var v;if(D.__count>D.results.length){var w=q.extend(true,{},this.aggregateSet);if(w&&w.results&&D.results.length<D.__count){q.each(n,function(i){w.results[0][n[i]]=String(Number(t.aggregateSet.results[0][n[i]])-Number(u.results[0][n[i]]));});q.each(o,function(i){w.results[0][o[i]]=O.getText("OTHERS_DONUT",[r+1]);});w.results[0].$isOthers=true;v=w.results[0];if(v){d.results.splice(-1,1);}}}if(v){d.results.push(v);}var x=c.getModel('ovpCardProperties');var E=x&&x.getProperty("/bEnableStableColors");var y=x&&x.getProperty("/colorPalette");var z=l[x&&x.getProperty("/chartAnnotationPath")];if(z.DimensionAttributes.length===1&&E&&c.getVizType()==="donut"&&y&&(y instanceof Object)&&Object.keys(y).length<=10){var A=z.DimensionAttributes[0].Dimension.PropertyPath;if(y instanceof Array){var B=y.map(function(Q){return Q.color;});var F=B.slice();}else{var G=JSON.parse(JSON.stringify(y));}var V=c.getVizProperties();if(c&&V&&V.plotArea){if(!V.plotArea.dataPointStyle){V.plotArea.dataPointStyle={rules:[]};}else{V.plotArea.dataPointStyle.rules=[];}var H=f.getODataProperty(l,A);if(H){var I=H["com.sap.vocabularies.Common.v1.Label"]?H["com.sap.vocabularies.Common.v1.Label"].String:A;var K;if(H["com.sap.vocabularies.Common.v1.Text"]){K=H["com.sap.vocabularies.Common.v1.Text"]["Path"];}else if(H["sap:text"]){K=H["sap:text"];}else{K=H;}var L=function(i,k,N,M){return{callback:function(Q){if(Q&&(Q[I]===N.dimensionValue)||(N.hasOwnProperty(Q[I]))){return true;}},properties:{color:(B&&B[i])||(N&&N[M])},"displayName":d.results[k][K]};};if(y instanceof Array){q.each(y,function(i,N){for(var k=0;k<d.results.length;k++){if(d.results[k][A]===N.dimensionValue){var R=L(i,k,N);c.getVizProperties().plotArea.dataPointStyle['rules'].push(R);F.splice(i,1);}}});}else{for(var k=0;k<d.results.length;k++){if(y.hasOwnProperty(d.results[k][A])){var M=d.results[k][A];var N={};N[M]=y[M];var R=L(i,k,N,M);c.getVizProperties().plotArea.dataPointStyle['rules'].push(R);delete G[M];}}}if(w){c.getVizProperties().plotArea.dataPointStyle['rules'].push({callback:function(Q){if(Q&&(Q[I].lastIndexOf('Others')!=-1)){return true;}},properties:{color:F&&F.length?B[B.length-1]:Object.keys(G).length&&G[Object.keys(G)[0]]},"displayName":w.results[0][A]});}}}}}var P=new J();P.setData(d.results);c.setModel(P,"analyticalmodel");},updateBindingContext:function(){var b=this.getBinding("data");var a=this.getBinding("aggregateData");var t=this;if(this.chartBinding==b){return;}else{this.chartBinding=b;if(b){var t=this;b.attachEvent("dataReceived",function(e){t.dataSet=e&&e.getParameter("data");t.oDataClone=q.extend(true,{},t.dataSet);if(t.getChartType()=="donut"&&t.getBinding("aggregateData")!==undefined){if(t.getDependentDataReceived()===true||t.getDependentDataReceived()==="true"){t.mergeDatasets(b,t.oDataClone,t.getContent());t.setDependentDataReceived(false);}else{t.setDependentDataReceived(true);}}else{var m=new J();if(t.dataSet){var c=t.getEntitySet();var o=b.getModel();var M=U.cacheODataMetadata(o);var T=[];var d={};var E=M[c];if(E){var f=Object.keys(E);}if(f&&f.length){q.each(f,function(i,p){if(E[p]["type"]==="Edm.String"){if(E[p]["sap:semantics"]==="yearmonth"||E[p]["com.sap.vocabularies.Common.v1.IsCalendarYearMonth"]){T.push(p);d[p]={"sap:semantics":"yearmonth"};}else if(E[p]["sap:semantics"]==="yearquarter"||E[p]["com.sap.vocabularies.Common.v1.IsCalendarYearQuarter"]){T.push(p);d[p]={"sap:semantics":"yearquarter"};}else if(E[p]["sap:semantics"]==="yearweek"||E[p]["com.sap.vocabularies.Common.v1.IsCalendarYearWeek"]){T.push(p);d[p]={"sap:semantics":"yearweek"};}}});}if(T&&T.length){if(t.dataSet.results&&t.dataSet.results.length){q.each(t.dataSet.results,function(i,r){q.each(T,function(i,p){if(r.hasOwnProperty(p)){var g=r[p];var y,h,j,k,l,w,s;switch(d[p]["sap:semantics"]){case'yearmonth':y=parseInt(g.substr(0,4),10);h=g.substr(4);l=parseInt(h,10)-1;r[p]=new Date(Date.UTC(y,l));break;case'yearquarter':y=parseInt(g.substr(0,4),10);j=g.substr(4);k=(parseInt(j,10)*3)-2;l=k-1;r[p]=new Date(Date.UTC(y,l));break;case'yearweek':y=parseInt(g.substr(0,4),10);w=g.substr(4);var s=(1+(parseInt(w,10)-1)*7);r[p]=new Date(Date.UTC(y,0,s));}}});});}}m.setData(t.dataSet.results);}t.getContent().setModel(m,"analyticalmodel");}});}C.prototype.updateBindingContext.apply(this,arguments);}if(this.chartAggrBinding==a){return;}else{this.chartAggrBinding=a;if(a){var t=this;a.attachEvent("dataReceived",function(e){t.aggregateSet=e&&e.getParameter("data");if(t.getChartType()=="donut"){if(t.getDependentDataReceived()===true||t.getDependentDataReceived()==="true"){t.oDataClone=q.extend(true,{},t.dataSet);t.mergeDatasets(b,t.oDataClone,t.getContent());t.setDependentDataReceived(false);}else{t.setDependentDataReceived(true);}}else{var m=new J();m.setData(t.aggregateSet.results);t.getContent().setModel(m,"analyticalmodel");}});}C.prototype.updateBindingContext.apply(this,arguments);}}});});
